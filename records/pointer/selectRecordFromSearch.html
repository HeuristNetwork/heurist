<!--

/**
 * filename, brief description, date of creation, by whom
 * @copyright (C) 2005-2010 University of Sydney Digital Innovation Unit.
 * @link: http://HeuristScholar.org
 * @license http://www.gnu.org/licenses/gpl-3.0.txt
 * @package Heurist academic knowledge management system
 * @todo
 **/

-->
<html>
 <head>
  <link rel=stylesheet href="../../common/css/global.css">
  <title>Find records</title>
  <style>
	#search {height: 55px;left: 0;margin-bottom: 10px;position: relative;top: 0;}
	#results {bottom: 26px;display: block;left: 0;overflow-y: auto;position: absolute;right: 0;top: 60px;}
	body.popup {padding: 0 !important; overflow: hidden;}
	.result_row {padding:1ex 10px 0 10px;}
	.result_row .id{width:10ex;display:inline-block;text-align: right;color:#999;}
	.result_row img{margin:0 8px;}
	div.result_row:hover{cursor: pointer;}
  </style>
 </head>
 <body class="popup" width="500" height="250" >
  <script src="../../common/js/utilsLoad.js"></script>
  <script>
if (window == top) {
	top.HEURIST.loadScript(top.HEURIST.basePath +"common/php/loadCommonInfo.php");	// core HEURIST object definitions (dynamically generated)
}
  </script>

  <form onSubmit="this.submit(); return false;">
  <div id="search" class="banner" style="top:0">
    <table border=0 cellspacing=0 cellpadding=0 class=expander style="margin-bottom: 1em;"><tr>
     <td style="width: 40px; text-align: right;">Find&nbsp;</td>
     <td style="padding: 5px;">
      <div style="width: 100%;">
       <div><input autocomplete=off type=text name=q id=q onChange="top.HEURIST.util.setDisplayPreference('record-search-string', value);" style="padding: 1px 18px 1px 2px; margin: 0; width: 100%;"></div>
       <div id=help-div>Enter part of word and click <img src="../../common/images/tiny-magglass.gif" onClick="document.forms[0].submit()" style="vertical-align: middle;"></div>
      </div>
     </td>
     <td style="width: 1px; vertical-align: middle;">
      <div style="overflow: visible; width: 1px;">
      <img src="../../common/images/small-magglass.gif" style="position: relative; cursor: pointer; z-index: 1; left: -22px;"
           onclick="document.forms[0].submit()" title="Search records">
      </div>
      <input type=submit value=Find style="display: none; font-weight: bold; padding: 0 1ex; margin-right: 1ex;">
     </td>
     <td style="width: 120px;" title="Restrict search to this record type">
      <select id=t name=t style="width: 100%;" onChange="top.HEURIST.util.setDisplayPreference('record-search-type', options[selectedIndex].value);"></select>
     </td>
     <td style="width: 80px; padding: 0 5px;">
      <div class=radio><nobr><label for=r-recent><input type=radio name=r id=r-recent value=recent> recent</label></nobr></div>
      <div class=radio><nobr><label for=r-all><input type=radio name=r id=r-all value=all> all records</label></nobr></div>
     </td>
    </tr></table>
   </div>
<!--   <div id=results-container class=expander style="overflow: hidden;">-->
    	<div id=results></div>
<!--   </div>-->
   <div id="add_records_footer">
    Didn't find what you were looking for?
    <a href="#" onClick=" return addRecord();"><img src="../../common/images/add-record-small.png" />Add a new record</a>
   </div>
  </form>

  <script language="JavaScript">
window.HEURIST.parameters = top.HEURIST.parseParams(window.location.search);

var rectype = window.HEURIST.parameters["t"];
if (rectype) {
	var rectypes = {};
	var recTypeName = "";
	if (rectype.search(",") != -1) {//seems like we have multiple type constraint, test that it is well formed
		var temp = rectype.split(",");
		for (var i=0; i<temp.length; i++) {
			if (temp[i].search(/\D/) == -1) {
				rectypes[temp[i]] = 1;
				recTypeName += top.HEURIST.rectypes.names[temp[i]].toLowerCase() + ",";
			}
		}
		recTypeName = recTypeName.slice(0,-1); // remove the last comma
		delete temp;
	}else if (rectype.search(/\D/) == -1) {
		rectypes[rectype] = 1;
		recTypeName = top.HEURIST.rectypes.names[rectype].toLowerCase();
	}else{
		rectypes = null;
	}
}

/* If a rectype has been chosen then set a custom title -- need to do before onload so the popup code will catch it */
if (recTypeName) {
	document.title = "Find " + recTypeName + " records";
}

function addRecord(){
	top.HEURIST.util.popupURL(window, top.HEURIST.basePath +'records/add/formAddRecordPopup.html?rectype='+
										document.getElementById('t').value+
										'&title='+document.getElementById('q').value+
										'&db='+ (window.HEURIST && window.HEURIST.parameters && window.HEURIST.parameters.db ? window.HEURIST.parameters.db :
														(top.HEURIST.parameters.db?top.HEURIST.parameters.db:
															(top.HEURIST.database.name? top.HEURIST.database.name:''))),
									{ callback: function(title, bd, bibID) {
													if (bibID) {
														window.close(bibID, title);
													} else {
														document.forms[0].submit();
													}
												}
									});
	return false;
}

// search callback which fills the result area with a line for each record in the result set
function notifyResults(results) {
	var resultsDiv = document.getElementById("results");
	var records = eval(results.responseText).records;

	var recordDiv;
	var record;
	var bibID, img, title;

	resultsDiv.innerHTML = "";
	for (var i=0; i < records.length; ++i) {
		record = records[i];

		recordDiv = resultsDiv.appendChild(document.createElement("div"));
		recordDiv.className = "result_row";

		bibID = recordDiv.appendChild(document.createElement("span"));
		bibID.appendChild(document.createTextNode(record[0]));
		bibID.className = "id";

		img = recordDiv.appendChild(document.createElement("img"));
		img.src = top.HEURIST.basePath + "common/images/16x16.gif";
img.style.backgroundImage = "url("+ top.HEURIST.basePath + "common/images/rectype-icons/" + top.HEURIST.database.id + "-" + (record[3]? record[3] : "blank") + ".png)";

		title = recordDiv.appendChild(document.createElement("span"));
		title.appendChild(document.createTextNode(record[1]));
		title.title = record[1];
		title.className = "title";

		top.HEURIST.registerEvent(recordDiv, "click", function(bibID, bibTitle) {
			return function() {
				window.close(bibID, bibTitle);
			}
		}(record[0], record[1]));
	}

	if (records.length == 0) {
		resultsDiv.innerHTML = "<b style='padding: 1ex;'>No matching records</b>";
	}

	document.body.cursor = "";
}

document.forms[0].submit = function() {
	// Make an AJAX request for the search results.  If no search specified, default to RECENT entries.
	var q = document.forms[0].elements["q"].value;
	var t = document.forms[0].elements["t"].value;
	if (t == "0") t = "";
// saw TODO modify for multi constraints set
	var query = "q=" + encodeURIComponent(q + (t? (" type:"+parseInt(t)) : ""));
	if (document.getElementById("r-recent").checked  ||  q == "") {
		query += "&r=recent";
	}
	if (top.HEURIST.parameters.db) {
		query += "&db=" + top.HEURIST.parameters.db;
	}else if (top.HEURIST.database.name) {
		query += "&db=" + top.HEURIST.database.name;
	}

	document.body.cursor = "wait";

	var resultsDiv = document.getElementById("results");
	resultsDiv.innerHTML = "<i style='padding: 1ex;'>Searching ...</i>";

	top.HEURIST.util.sendRequest(top.HEURIST.baseURL + "records/pointer/getRecordListForSearch.php", notifyResults, query);

	return false;
}

/* FLAGRANT abuse of the onsubmit function, but otherwise hitting return in the field submits the entire page */
document.forms[0].onsubmit = function() { document.forms[0].submit(); return false; };


function initPage() {
	var qVal = window.HEURIST.parameters["q"];
	if (! qVal  &&  ! (rectype)) {
		qVal = top.HEURIST.util.getDisplayPreference("record-search-string");
	}
	document.forms[0].elements["q"].value = qVal  ||  "";

	top.HEURIST.registerEvent(window, "load", function() { document.forms[0].elements["q"].focus(); });

	var preferredType = top.HEURIST.util.getDisplayPreference("record-search-type");
	var initialType = preferredType;
	if (rectypes) {
		for (var type in rectypes) {	// careful! this only runs once and then breaks.
			if (!rectypes[preferredType]) {
				initialType = type;
			}
			break;
		}
	}

	var tElt = document.getElementById("t");
	tElt.selectedIndex = 0;

	if (!rectypes) {
		tElt.options[tElt.options.length] = new Option("Any record type", "");
		// rectypes displayed in Groups by group display order then by display order within group
		for (var grpID in top.HEURIST.rectypes.groups){
		var grp = document.createElement("optgroup");
			grp.label = top.HEURIST.rectypes.groups[grpID].name;
		tElt.appendChild(grp);
			for (var recTypeID in top.HEURIST.rectypes.groups[grpID].types) {
				if (top.HEURIST.rectypes.groups[grpID].types[recTypeID]) {
					var name = top.HEURIST.rectypes.names[recTypeID];
					tElt.appendChild( new Option(name, recTypeID));
				}
	}
		}
	}else{
		for (var rectypeID in rectypes) {
			var name = top.HEURIST.rectypes.names[rectypeID];
			tElt.appendChild( new Option(name, rectypeID));
			if (rectypeID == initialType) {
			tElt.selectedIndex = tElt.options.length-1;
		}
	}
	}

	if (window.HEURIST.parameters["r"] == "recent")
		document.getElementById("r-recent").checked = true;
	else
		document.getElementById("r-all").checked = true;

	document.forms[0].submit();

	var intervalID = setInterval(function() {
		try {
			if (document.getElementById("q")) {
				document.getElementById("q").focus();
				clearInterval(intervalID);
			}
		} catch (e) { }
	}, 0);
}
top.HEURIST.registerEvent(window, "load", initPage);
  </script>
 </body>
</html>
