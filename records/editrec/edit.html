<html>
	<!-- heurist-search.html

	* Main Heurist search page: this page is the effective home page for the Heurist application *

	(c) Copyright 2006 - 2010 University of Sydney Digital Innovation Unit
	This file is part of the Heurist academic data management system (http://HeuristScholar.org)

	Heurist is free software; you can redistribute it and/or modify it under the terms of the
	GNU General Public License as published by the Free Software Foundation; either version 3
	of the License, or (at your option) any later version.

	Heurist is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
	even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.

	You should have received a copy of the GNU General Public License along with this program.
	If not, see <http://www.gnu.org/licenses/>
	or write to the Free Software Foundation,Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
	-->
	<head>
		<title>Heurist Reference Database - Edit - &copy; 2007 University of Sydney</title>
		<link rel=stylesheet href="../../common/css/global.css">
		<link rel=stylesheet href="../../common/css/edit.css">
	</head>
	<body>

		<script src="../../common/js/heurist.js"></script>
		<script src="heurist-relation.js"></script>
		<script src="../../common/php/heurist-obj-user.php"></script>
		<script>
			top.HEURIST.whenLoaded("obj-user", function() {
				if (! top.HEURIST.is_logged_in()) {
					top.location.replace(top.HEURIST.basePath + "common/connect/login.php?last_uri=" + top.HEURIST.basePath + "edit" + top.location.search);
				}
			});
		</script>
		<script src="../../common/php/heurist-obj-common.php"></script>
		<script src="../../common/php/display-preferences.php"></script>
		<script>

		</script>
		<script src="edit.js"></script>
		<script>
			top.HEURIST.loadScript(top.HEURIST.basePath +"records/pointer/bib.php?bib_id="+
				(top.HEURIST.parameters["bib_id"]? top.HEURIST.parameters["bib_id"] : window.location.search.match(/bib_id=(\d+).*$/)[1])+
				"&bkmk_id="+top.HEURIST.parameters["bkmk_id"]);
		</script>
		<script>
			top.HEURIST.whenLoaded(["record","edit-html"], function() {
				var rec = (top && top.HEURIST && top.HEURIST.edit && top.HEURIST.edit.record ? top.HEURIST.edit.record:null);
				var bib_id =  ((rec?rec.bibID : 0) || (window.HEURIST ? window.HEURIST.parameters["bib_id"]:0) || (top.HEURIST ? top.HEURIST.parameters["bib_id"]:0));
				if (! rec) {
					window.location.replace(top.HEURIST.basePath +"common/messages/invalid.html"+ (bib_id ? "?" + bib_id : ""));
				}
				if (rec.denied) {
					window.location.replace(window.HEURIST.basePath +"common/messages/denied.html"+ (bib_id ? "?" + bib_id : ""));
				}
				if (rec.replacedBy) {
					// This record has been deprecated in favour of another ...
					// Load that page (and make a best effort to stop this one from continuing)
					window.location.replace("?bib_id=" + rec.replacedBy);
				}
			});
		</script>
		<script src="../../common/php/load-hapi.php"></script> <!-- FIXME:  need to just change hapi to load without instances and keys  -->

		<script>
			top.HEURIST.registerEvent(window, "contentloaded", function() {
				document.getElementById("home-link").href = top.HEURIST.basePath + "?instance=" +top.HEURIST.instance.name;
			});

			top.HEURIST.whenLoaded(["record", "edit-html"], function() {
				top.HEURIST.edit.showRecordProperties();
				if (top.HEURIST.parameters["sid"]) {
					top.HEURIST.util.getJsonData(top.HEURIST.basePath+"records/editrec/result-context.php?s="+top.HEURIST.parameters["sid"]+"&id="+top.HEURIST.edit.record.bibID, function(context) {
						if (! context) return;
						document.getElementById("search-nav").innerHTML =
						"<p>Record "+context.pos+" of "+context.count+" search results</p>" +
						"<p>" +
						(context.prev ? "<a style=\"padding-right: 10px;\" href=?sid="+top.HEURIST.parameters["sid"]+"&bib_id="+context.prev+">previous</a>" : "") +
						(context.next ? "<a href=?sid="+top.HEURIST.parameters["sid"]+"&bib_id="+context.next+">next</a>" : "") +
						"</p>";
					});
				}
			});
			top.HEURIST.whenLoaded(["record", "edit-js", "edit-html"], top.HEURIST.edit.loadAllModules);
			top.HEURIST.whenLoaded(["record", "edit-js", "HAPI", "edit-html"],createReftypeChanger );
			window.onbeforeunload = top.HEURIST.edit.onbeforeunload;

			function createReftypeChanger() {
				var reftypeEdit = document.getElementById("reftype-edit");
				var reftypeValSelect = document.createElement("select");
				reftypeValSelect.id = "reftype-select";
				reftypeValSelect.onchange = changeReftype;
				reftypeEdit.appendChild(reftypeValSelect);

				if (reftypeValSelect.options.length == 0) {
					// fill in reftype dropdown if it hasn't been done already
					// bibliographic reftypes
					var grp = document.createElement("optgroup");
					grp.label = "Bibliographic reference types";
					reftypeValSelect.appendChild(grp);
					for (var i=0; i < top.HEURIST.reftypes.primary.length; ++i) {
						var value = top.HEURIST.reftypes.primary[i];
						var name = top.HEURIST.reftypes.names[value];
						reftypeValSelect.options[reftypeValSelect.length] = new Option(name, value);
						if (name == top.HEURIST.edit.record.reftype) {
							reftypeValSelect.selectedIndex = reftypeValSelect.options.length-1;
						}
					}
					// other reftypes
					var grp = document.createElement("optgroup");
					grp.label = "Other reference types";
					reftypeValSelect.appendChild(grp);
					for (var i=0; i < top.HEURIST.reftypes.other.length; ++i) {
						var value = top.HEURIST.reftypes.other[i];
						var name = top.HEURIST.reftypes.names[value];
						reftypeValSelect.options[reftypeValSelect.length] = new Option(name, value);
						if (name == top.HEURIST.edit.record.reftype) {
							reftypeValSelect.selectedIndex = reftypeValSelect.options.length-1;
						}
					}
				}
			}

			function changeReftype() {
				var reftypeValue = document.getElementById("reftype-select").value;
				if (top.HEURIST.edit.record.reftype != reftypeValue) {
					top.HEURIST.edit.record.reftypeID = reftypeValue;
					top.HEURIST.edit.record.reftype = top.HEURIST.reftypes.names[reftypeValue];

					// update the public info frame to reflect the change of reftype
					top.HEURIST.edit.showModule("public");
					top.HEURIST.edit.modules["public"].frame.contentWindow.setReftype(reftypeValue);
					top.HEURIST.edit.showRecordProperties();
				}
			}


			function openWorkgroupChanger() {
				if (top.HEURIST.edit.record.workgroupVisibility == "Hidden") {
					document.getElementById("non-wg-hide").checked = true;
				} else {
					document.getElementById("non-wg-view").checked = true;
				}

				var wgVal = document.getElementById("new-workgroup-value");
				while (wgVal.childNodes.length) {
					wgVal.removeChild(wgVal.lastChild);
				}
				wgVal.options[0] = new Option("Anybody (no restriction)", "");
				wgVal.selectedIndex = 0;
				for (var i=0; i < top.HEURIST.user.workgroups.length; ++i) {
					var wgID = top.HEURIST.user.workgroups[i];
					var wgName = top.HEURIST.workgroups[wgID].name;
					wgVal.options[i+1] = new Option(wgName, wgID);

					if (wgName == top.HEURIST.edit.record.workgroup)
					wgVal.selectedIndex = i+1;
				}


				var wgEditor = document.getElementById("workgroup-editor");
				wgEditor.style.display = "block";

				var linkPos = top.HEURIST.getPosition(document.getElementById("workgroup-edit"));
				top.HEURIST.util.popupElement(window, wgEditor,
				{ width: wgEditor.offsetWidth, height: wgEditor.offsetHeight, x: linkPos.x-150, y: linkPos.y+8, "no-titlebar": true, "no-resize": true });
				setTimeout(function() { wgVal.focus(); }, 0);
			}

			function closeWorkgroupChanger(cancel) {
				if (! cancel) {
					var wgValue = document.getElementById("new-workgroup-value").value;
					var wgVisValue = document.getElementById("non-wg-hide").checked? "Hidden" : "Viewable";
					if (top.HEURIST.edit.record.workgroup != wgValue  ||  top.HEURIST.edit.record.workgroupVisibility != wgVisValue) {
						top.HEURIST.edit.record.workgroup = wgValue? top.HEURIST.workgroups[wgValue].name : null;
						top.HEURIST.edit.record.workgroupVisibility = wgVisValue;

						top.HEURIST.edit.modules["public"].frame.contentWindow.setWorkgroupProperties(wgValue, wgVisValue);

						top.HEURIST.edit.showRecordProperties();
					}
				}

				var popupsList = top.HEURIST.util.popups.list;
				top.HEURIST.util.closePopup(popupsList[popupsList.length-1].id);
			}



		</script>

<a id=home-link>
<div id=logo title="Click the logo to return to your Favourites"></div>
</a>
<div id=version></div>
<!-- instance name -->
<div id=instance-name ></div>
<!-- message of the day -->
<div id="message"> Heurist 3 : Open Source <a href="../help/webhelp/index.html?ACL" target="_blank" title="Click for full information. Design: Ireneusz Golka, Ian Johnson &amp; Ingrid Mason. Programming: Steve Whtie, Kim Jackson, Tom Murtagh &amp; Maria Shvedova. University of Sydney Digital Innovation Unit."><br><font style="font-size:11px">Credits</font></a> </div>
<!-- quicklinks -->
<div id="quicklinks" >
  <div id=quicklink-cell class=yui-skin-sam>
  	<nobr><b>
		<a href="../../help/about.html" onClick="top.HEURIST.util.popupURL(window, href); return false;">About</a> |
		<a href="http://www.timemap.net/tmissues.php" target=_blank>Report a bug</a> |
		<a id=contact-link href="mailto:info@heuristscholar.org">Contact us</a> |
		<a id=help-link href='#' onClick="top.HEURIST.util.helpToggler(this)"></a>

		<script>
			top.HEURIST.whenLoaded(["edit-html", "obj-common"], top.HEURIST.util.setInstanceName);
			top.HEURIST.whenLoaded("record", function() {
				var contactLinkSubject = "HEURIST v" + top.HEURIST.VERSION + " user:"+top.HEURIST.get_user_username() + " edit";
				if (top.HEURIST.edit.record.bibID) contactLinkSubject += " bibID:"+top.HEURIST.edit.record.bibID;
				if (top.HEURIST.edit.record.bkmkID) contactLinkSubject += " bkmkID:"+top.HEURIST.edit.record.bkmkID;
				top.document.getElementById("contact-link").href += "?subject=" + encodeURIComponent(contactLinkSubject);
			});
		</script>
	</b></nobr>
	</div>
</div>
<!-- search -->
<div id=search  class="roundedBoth outline bannerBG">
	<!-- div class="tablecell" id="edit_record_title">EDIT RECORD</div -->
	<div id=record-title>
		<img id=reftype-img src="../../common/images/16x16.gif">
		<div id=title-val></div>
	</div>
	<div id=reftype-edit class=edit ></div>
	<div id=workgroup-div>
		<div id=workgroup-val-div title="Restrict access by workgroup">
			<nobr>
			<b><span id=workgroup-val></span></b>
			<span id=workgroup-edit class="edit admin-only" onClick="openWorkgroupChanger();"><img src="../../common/images/edit-pencil.png">change</span>
		</nobr>
		</div>
		<div id=workgroup-access title="Access for users not in this workgroup"></div>
	</div>
	<div id=save-record-buttons>
		<input type=button name=save-button value=Cancel onClick="top.HEURIST.edit.cancelSave();">
		&nbsp;&nbsp;
		<input type=button name=save-button style="font-weight: bold;" value=Save onClick="top.HEURIST.edit.save();">
	</div>
</div>

<!-- sidebar -->
<div id="sidebar">
	<div class="sidebar-link disabled" style="background-image: url(../../common/images/public_icon.gif);" id=public-link
		disabledDescription="No public information for private record"><img src="../../common/images/16x16.gif">
		<b>Public information</b>
		<span id=desc>Record description, bibliographic data</span>
	</div>

	<div class="sidebar-link disabled" style="background-image: url(../../common/images/personal_icon.gif);" id=personal-link
		disabledTitle="Click here to add a bookmark for this record"
		disabledDescription="Click here to bookmark this record"><img src="../../common/images/16x16.gif">
		<b>Personal information</b>
		<span id=desc>Tags, passwords, ratings, notifications</span>
	</div>

	<div class="sidebar-link disabled" style="background-image: url(../../common/images/workgroup_icon.gif);" id=workgroups-link
		disabledDescription="You are not a member of any workgroup"><img src="../../common/images/16x16.gif">
		<b>Workgroup tags</b>
		<span id=desc>For the workgroups you belong to</span>
	</div>

	<div class="sidebar-link disabled" style="background-image: url(../../common/images/wiki-icon.gif);" id=annotation-link
		disabledDescription="Not available"><img src="../../common/images/16x16.gif">
		<b>Text</b>
		<span id=desc>WYSIWYG extended text &amp; discussion</span>
	</div>

	<div class="sidebar-link disabled" style="background-image: url(../../common/images/relationships_icon.gif);" id=relationships-link
		disabledDescription="Not available"><img src="../../common/images/16x16.gif">
		<b>Relationships</b>
		<span id=desc>Cross-referencing, link related records</span>
	</div>

	<div style="width: 180px; text-align: center; padding: 20px 0;" id=public-link>
		<input type=button name=save-button value=Cancel onClick="top.HEURIST.edit.cancelSave();">
		&nbsp;&nbsp;
		<input type=button name=save-button value=Save style="font-weight: bold;" onClick="top.HEURIST.edit.save();">
	</div>
	<div style="padding: 0 30px;">
		<div style="padding: 3px 0;"><label for=act-recent><input type=radio name=act id=act-recent value=search
			onclick="top.HEURIST.util.setDisplayPreference('action-on-save', value)"> show recent edits</label></div>
		<div style="padding: 3px 0;"><label for=act-stay><input type=radio name=act id=act-stay value=stay
			onclick="top.HEURIST.util.setDisplayPreference('action-on-save', value)"> stay on page</label></div>
		<div style="padding: 3px 0;" id=close-window-option><label for=act-close><input type=radio name=act id=act-close value=close
			onclick="top.HEURIST.util.setDisplayPreference('action-on-save', value)"> close window</label></div>
		<div id=search-nav></div>
	</div>
	<script>
		top.HEURIST.whenLoaded("display-preferences", function() {
			var canCloseWindow = false;
			try {
				// see if we would be able to close this window with JS
				if (top.opener != top && top.HEURIST_WINDOW_ID) {
					canCloseWindow = true;
				}
				// otherwise, fall through to a different detail action, and hide the close-window option
			} catch (e) {
				document.getElementById("close-window-option").style.display = "none";
			}

			switch (top.HEURIST.displayPreferences["action-on-save"]) {
				case "search":
				document.getElementById("act-recent").checked = true;
				break;
				case "close":
				if (canCloseWindow) {
					document.getElementById("act-close").checked = true;
					break;
				}
				default:
				document.getElementById("act-stay").checked = true;
			}

			var helpOn = (top.HEURIST.util.getDisplayPreference("help") !== "hide");
			var helpLink = top.document.getElementById("help-link");
			helpLink.innerHTML = "<span>Help is " + (helpOn? "on" : "off") + "</span>";
			helpLink.title = helpOn? "Click here to hide help text" : "Click here to show help text";
		});
	</script>

</div>
<!-- end sidebar -->
<!-- page -->
<div id=page>
	<!-- banner -->
	<div class="banner">
		<nobr>
					<div class=public-visible>

						<label for=input-visibility style="margin-left: 116px;">
							<input style="vertical-align: middle;" type=checkbox id=input-visibility onClick="top.HEURIST.util.setDisplayPreference('input-visibility', this.checked? 'all' : 'recommended')" class=minimal>
							show optional fields
						</label>
						<script>
							top.HEURIST.whenLoaded("display-preferences", function() {
								document.getElementById("input-visibility").checked = (top.HEURIST.displayPreferences["input-visibility"] === "all");
							});
						</script>

					</div>
					<span class=inconsistent-design-help-button>
						<span class="help"
							title="Help tips may be read using your eyes to view helpful tips about the visual elements and/or functions to which they refer"
							onclick="top.HEURIST.util.setDisplayPreference('help', 'hide')"><input onClick="return false;" type=checkbox checked=checked> show help <span style="font-size: 10px; font-weight: bold;">&nbsp;You can also turn help on and off using the button at the top-right of every screen</span></span>
						<span class="not-help" onClick="top.HEURIST.util.setDisplayPreference('help', 'show')"><input onClick="return false;" type=checkbox> show help</span>
					</span>
					&nbsp;
			</nobr>
	</div>
	<!-- end banner -->
	<!-- main panel -->
	<div id="page-inner" class="panel-main-div">
		<div id=tab-holder class="autosize panel-main-content">
		</div>
	</div>


</div>
<!-- end page -->
<!-- footer -->
			<div id=footer>
					<span>last accessed: <span id=moddate></span>
					<span>cite as: <a href='#' id=cite-as-url contextmenu=enable onClick="return false;"></a></span>
					<script>
						top.HEURIST.whenLoaded("record", function() {
							document.getElementById("moddate").appendChild(document.createTextNode(top.HEURIST.edit.record.moddate));
							var citeAs = document.getElementById("cite-as-url");
							citeAs.href = "http://"+window.location.host+ top.HEURIST.basePath +"data/records/viewrec/view.php?instance="+ top.HEURIST.instance.name +"&bib_id=" + top.HEURIST.edit.record.bibID;
							citeAs.appendChild(document.createTextNode(citeAs.href));
						});
					</script>
					</span>
			</div>
<!-- end footer -->
<div style="position: absolute;"><div id=workgroup-editor style="display: none;">
		<table id=workgroupTable border=0 cellspacing=4><tbody>
				<tr><td colspan=2><b>Change workgroup access:</b></td></tr>
				<tr>
					<td>Record is editable by</td>
					<td><select id=new-workgroup-value class=in></select></td>
				</tr>
				<tr>
					<td><span style="position: relative; top: 1.2ex;">Other Heurist users</span></td>
					<td><label for=non-wg-view><input type=radio name=new-non-workgroup value=Viewable id=non-wg-view> cannot edit the record</label></td>
				</tr>
				<tr>
					<td>&nbsp;</td>
					<td><label for=non-wg-hide><input type=radio name=new-non-workgroup value=Hidden id=non-wg-hide> cannot view or edit the record</label></td>
				</tr>
				<tr><td style="text-align: right; padding: 2px;" colspan=2>
						<input type=button value="Change" style="font-weight: bold;" onClick="closeWorkgroupChanger();">
						<input type=button value="Cancel" onClick="closeWorkgroupChanger(true);">
				</td></tr>
		</tbody></table>
</div></div>

<div id=workgroup-message style="display: none;">
	<div style="padding: 5px;">
		<h2>Workgroup warning</h2>
		<p>The link you followed attempts to add workgroup ownership and/or workgroup tags to the record you are creating.
			As you are not a member of the workgroup <span id=workgroup-message-wgname style="font-weight: bold;"></span>, the record will be
		created as an open record without the workgroup information.</p>
		<p>In this context, workgroup tags are generally used to publish records to specific lists.
			The absence of the workgroup tag probably means that your new record will not appear in the corresponding list(s).
		If it needs to appear there, you will need to ask a member of the workgroup to add the tag(s) later.</p>

		<input type="button" value="OK" onClick="top.HEURIST.util.closePopup(workgroupPopupID);">
	</div>
</div>

<script>
	var workgroupPopupID;
	function testWorkgroupMessage() {
		top.HEURIST.deregisterEvent(window, "load", testWorkgroupMessage);

		if (! (top.HEURIST.parameters["wg"]  ||  top.HEURIST.parameters["wgkwd"])) return;
		var wg = top.HEURIST.workgroups[parseInt(top.HEURIST.parameters["wg"])];

		document.getElementById("workgroup-message-wgname").appendChild(document.createTextNode(wg? wg.name : ""));

		var w = top.HEURIST.util.popupElement(top, document.getElementById("workgroup-message"), { "no-titlebar": true, width: 400, height: 300 });
		workgroupPopupID = w.id;
	}
	top.HEURIST.registerEvent(window, "load", testWorkgroupMessage);
</script>


<div id=notes-container></div>

<div>
	<div id=popup-saved style="display: none">
		<b>Record saved</b>
	</div>
</div>

<script src="../disambig/disambiguate.js"></script>
<script>
	function popupDisambiguation(matches) {
		_popupDisambiguation(matches, function(choice) {
			if (choice.value == -1) {
				top.HEURIST.edit.record.forceSave = true;
				var editFrame = top.HEURIST.edit.modules.public.frame;
				editFrame.contentWindow.document.forms[0].heuristSubmit();
			}
			else {
				var modules = top.HEURIST.edit.modules;
				for (var eachName in modules) {
					top.HEURIST.edit.unchanged(eachName);
				}

				top.location.replace(top.HEURIST.basePath+"data/records/editrec/heurist-edit.html?bib_id="+choice.details.id);
			}
		});
	}
</script>

<script>
	if (!top.HAPI && typeof HAPI == "object"){
		HAPI.importSymbols(this,top);
	}
	top.HEURIST.contentLoaded();
	top.HEURIST.fireEvent(top, "heurist-edit-html-loaded");
</script>

	</body>
</html>
