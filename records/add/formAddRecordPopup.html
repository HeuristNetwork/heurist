<!--

/**
 * filename, brief description, date of creation, by whom
 * @copyright (C) 2005-2010 University of Sydney Digital Innovation Unit.
 * @link: http://HeuristScholar.org
 * @license http://www.gnu.org/licenses/gpl-3.0.txt
 * @package Heurist academic knowledge management system
 * @todo
 **/

-->
<html>
 <head>
  <title>Add new record</title>

  <link rel=stylesheet href="../../common/css/global.css">
 </head>

 <body class="popup" width=600 height=400>
  <script src="../../common/js/utilsLoad.js"></script>
  <script src="../../common/php/displayPreferences.php"></script>
<div class="header"><b><span id=rectype-val></span></b><span id=title-val></span></div>
<div id="results"><iframe frameborder=0 class=tab id=edit-frame style="width: 100%; height: 100%;"></iframe></div>
<div id="add_records_footer"><input type=button onClick="window.HEURIST.edit.save();" value="Save new record"></div>
  <script>

window.HEURIST.edit = {
	publicHasChanged: false,

	unchanged: function() {
		window.HEURIST.edit.publicHasChanged = false;
	},

	changed: function() {
		window.HEURIST.edit.publicHasChanged = true;
	},

	save: function() {
		// Attempt to save the public tab

		var editFrame = document.getElementById("edit-frame");
		var contentWindow = editFrame.contentWindow;
		if (contentWindow) {
			var form = contentWindow.document.forms[0];
			if (form.onsubmit  &&  ! form.onsubmit()) {
				return;	// submit failed ... up to the individual form handlers to display messages
			}
			top.HEURIST.registerEvent(editFrame, "load", function() {
				window.close(window.HEURIST.record.title, window.HEURIST.record.bdValuesByType, window.HEURIST.record.bibID);
			});

			(form.heuristSubmit || form.submit)();
			return;
		}

		// If we get here, there were no unsaved changes.
		// Grab the biblio title from the saved document, and close the window.
	}
};

window.HEURIST.parameters = top.HEURIST.parseParams(window.location.search);
var rectype = parseInt(window.HEURIST.parameters["rectype"]);
var titleBits = (window.HEURIST.parameters["title"] || "").split(/\s+/);
for (var i=0; i < titleBits.length; ++i) {
	titleBits[i] = titleBits[i].charAt(0).toUpperCase() + titleBits[i].substring(1);
}
var title = titleBits.join(" ");
document.getElementById("title-val").appendChild(document.createTextNode(title || ""));
var url = window.HEURIST.parameters["url"];
if (! rectype) {
	var setInitialrectype = function() {
		var rectype = rectypeDropdown.options[rectypeDropdown.selectedIndex].value;

		var editFrame = document.getElementById("edit-frame");
		editFrame.src = "../edit/tabs/publicInfoTab.html?rectype="+rectype;
		editFrame.style.display = "block";

		rectypeDropdown.onchange = setrectype;
	}
	var setrectype = function() {
		if (! confirm("Existing details will be lost - continue?")) return;

		var rectype = rectypeDropdown.options[rectypeDropdown.selectedIndex].value;

		var editFrame = document.getElementById("edit-frame");
		editFrame.contentWindow.setrectype(rectype);
	}


	var rectypeDiv = document.getElementById("rectype-val");
	var rectypeDropdown = document.createElement("select");
		rectypeDropdown.id = "rectype";

	var j = 0;
	var firstOption = rectypeDropdown.options[j++] = new Option("(select a record type)", "");
		firstOption.disabled = true;
		firstOption.selected = true;

	// rectypes displayed in Groups by group display order then by display order within group
	for (var grpID in top.HEURIST.rectypes.groups){
	var grp = document.createElement("optgroup");
		grp.label = top.HEURIST.rectypes.groups[grpID].name;
		rectypeDropdown.appendChild(grp);
		for (var recTypeID in top.HEURIST.rectypes.groups[grpID].types) {
			if (top.HEURIST.rectypes.groups[grpID].types[recTypeID]) {
				var name = top.HEURIST.rectypes.names[recTypeID];
				rectypeDropdown.appendChild( new Option(name, recTypeID));
			}
	}
	}

	rectypeDropdown.onchange = setInitialrectype;

	rectypeDiv.appendChild(rectypeDropdown);

} else {
	var editFrame = document.getElementById("edit-frame");
	editFrame.src = "../edit/tabs/publicInfoTab.html?rectype="+rectype+"&title="+encodeURIComponent(title);
	editFrame.style.display = "block";

	document.getElementById("rectype-val").appendChild(document.createTextNode(top.HEURIST.rectypes.names[rectype]));
}

</script>
<script src="../disambig/similarRecordsPopup.js"></script>
<script>
function popupDisambiguation(matches) {
	_popupDisambiguation(matches, function(choice) {
		if (choice.value == -1) {
			window.HEURIST.record.forceSave = true;
			var editFrame = document.getElementById("edit-frame");
			editFrame.contentWindow.document.forms[0].heuristSubmit();
		}
		else {
			window.close(choice.details.title, [], choice.details.bibID);
		}
	});
}
</script>

 </body>
</html>
