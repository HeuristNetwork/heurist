<!--

/**
 * filename, brief description, date of creation, by whom
 * @copyright (C) 2005-2010 University of Sydney Digital Innovation Unit.
 * @link: http://HeuristScholar.org
 * @license http://www.gnu.org/licenses/gpl-3.0.txt
 * @package Heurist academic knowledge management system
 * @todo
 **/

-->
<html>
 <head>
  <link rel="stylesheet" href="../common/css/global.css">
  <script type="text/javascript" src="../../external/yui/2.8.2r1/build/yahoo/yahoo-min.js"></script>
  <script type="text/javascript" src="../../external/yui/2.8.2r1/build/json/json-min.js"></script>
  <script src="../common/js/utilsLoad.js"></script>
  <title>Add relationships to selected records</title>

  <style type="text/css">
	#record-count {
		font-weight: bold;
	}
	#relationship-type {
		margin-bottom: 10px;
	}
	#related-record {
		width: 250px;
		border: 1px dotted gray;
		cursor: pointer;
		margin-bottom: 20px;
	}
  </style>

  <script>

var relTargetID;
var recCountSpan;
var relTypeSelect;
var relTargetInput;
var hBase = "http://" + window.location.host +
			(top && top.HEURIST && top.HEURIST.basePath? top.HEURIST.basePath : window.location.pathname.match(/^\/[^\/]+\//));
var database = (top && top.HEURIST && top.HEURIST.database? top.HEURIST.database.name : location.search.match(/db=([^&]+)/)[1]);

function init () {

	relTargetID;
	recCountSpan = document.getElementById("record-count");
	var relTypeSelectDiv = document.getElementById("relationship-type-div");
	relTargetInput = document.getElementById("related-record");

	recCountSpan.innerHTML = top.HEURIST.search.getSelectedRecIDs().length;

	var relTypeTerms = top.HEURIST.util.expandJsonStructure(top.HEURIST.rectypes.typedefs[52].dtFields[200][11]);
	var relTypeTermsDisabled = top.HEURIST.util.expandJsonStructure(top.HEURIST.rectypes.typedefs[52].dtFields[200][13]);

	relTypeSelect = top.HEURIST.util.createTermSelect(relTypeTerms,
													(relTypeTermsDisabled || ""),
													top.HEURIST.terms.termsByDomainLookup.relation,
													null);
	relTypeSelectDiv.appendChild(relTypeSelect);

	relTargetInput.onclick = function () {
		top.HEURIST.util.popupURL(window, hBase + "records/pointer/selectRecordFromSearch.html?q=&db=" + database, {
			callback: function(recID, recTitle) {
				relTargetInput.value = recTitle || "";
				relTargetID = recID || null;
			}
		});
	}
}

function save () {	// xhrFormSubmit only uses the form's action and elements(name & value) properties
	var fakeForm = {
		action: top.HEURIST.basePath + "records/relationships/saveRelationships.php?db=" + database,
		elements: [
			{ name: "recID", value: top.HEURIST.search.getSelectedRecIDs().join(",") },
			{ name: "save-mode", value: "new" },
			{ name: "RelTermID", value: relTypeSelect.value },
			{ name: "RelatedRecID", value: relTargetID }
		]
	};

	top.HEURIST.util.xhrFormSubmit(fakeForm, function(json) {
		var i, l, rels;
		var vals = eval(json.responseText);
		if (! vals) {
			alert("No response from server");
		}
		else if (vals.error) {
			alert("Error while saving:\n" + vals.error);
		} else {
			rels = 0;
			if (vals.length) {
				l = vals.length;
				for (i = 0; i < l; ++i) {
					if (vals[i].relationship) {
						++rels;
					}
				}
			} else if (vals.relationship) {
				rels = 1;
			}
			document.getElementById("status").innerHTML = "<b>" + rels + "</b> relationships added."
			setTimeout(function () {
				top.location.href = hBase + "?q=relationsfor:" + relTargetID + "&db=" + database;
			}, 2000);
		}
	});
}


  </script>
 </head>

 <body class="popup" onload="init();">

   <p><span id="record-count"></span> selected records</p>

   <div id="relationship-type-div">Relationship type:
   </div>

   <div>
    <label for="related-record">Related Record:</label>
   <input type="text" id="related-record">
   </div>
   <input type="button" value="add relationships" onclick="this.disabled = true; save();">
   <input type="button" value="cancel" onclick="window.close();">

   <p id="status"></p>

 </body>
</html>
