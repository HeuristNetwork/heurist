<!--

/**
 * filename, brief description, date of creation, by whom
 * @copyright (C) 2005-2010 University of Sydney Digital Innovation Unit.
 * @link: http://HeuristScholar.org
 * @license http://www.gnu.org/licenses/gpl-3.0.txt
 * @package Heurist academic knowledge management system
 * @todo
 **/

-->
<html>
	<head>
		<link rel=stylesheet href='../../common/css/global.css'>
		<title></title>
		<script src='../../external/jquery/jquery.js'></script>
		<script src='../../records/tags/usergroupTagEditorLibrary.js'></script>
		<script>
			if (top.HEURIST.search.collectCount == 0) {
				alert("No records have been collected. Please select records from the search results and press collect to add records, then press save.");
				setTimeout(function() { window.close(); }, 100);
			}

			function parseTagOnlySearches(searches) {
				var tagOnlySearches = [];
				for (var i =0; i < searches.length; i++) {
					var ss = searches[i];
					if (!ss[1]) {
						continue;
					}
					var q = ss[1].match(/[\?&]q=([^&]*)/);
					if (!q || !q[1]) {
						continue;
					}
					//q = q[1].replace(/\+/g,' ');
					q = q[1].replace(/\+?sortby:('[^']+'|"[^"]+"|\S+)/g,'');	//remove any sortby predicates
					q = q.replace(/OR(?![^:='"]+['"])/g,'');	// remove any 'OR' s not in a quoted string
					var preds = q.match(/\S+[:=](?:'[^']+'|"[^"]+"|\S+)|[^:='"\s]+/g);	//create an array of all predicates including stand alone words
					var tags = q.match(/((kwd)|(keyword)|(tag))[:=]('[^']+'|"[^"]+"|\S+)/g);	//create an array of just tag predicates
					if (!tags || preds.length != tags.length) {
						continue;
					}
					tags = tags.join(" | ").replace(/[^,\s]+[:=]/g,'').replace(/['"]/g,'');	// strip off the tags predicates
					tagOnlySearches.push([ss[0],tags]);
				}
				return tagOnlySearches;
			}

			function init() {
				var iHTML = '<option value="" selected disabled>select ...</option>';
				var ss = parseTagOnlySearches(top.HEURIST.user.savedSearches);
				if (ss.length) {
					iHTML += '<optgroup label="Personal saved searches" id="my-searches">';
					for (var i = 0; i < ss.length; i++) {
						iHTML += "<option value='" + ss[i][1].replace(/\+/g," ") + "'>" + ss[i][0] + "</option>";
					}
					iHTML += "</optgroup>";
				}
				for ( i = 0; i < top.HEURIST.user.workgroups.length; i++) {
					var wg = top.HEURIST.user.workgroups[i];
					if (!top.HEURIST.user.workgroupSavedSearches[wg]) {
						continue;
					}
					ss = parseTagOnlySearches(top.HEURIST.user.workgroupSavedSearches[wg]);
					if (ss.length) {
						iHTML += '<optgroup label="' + top.HEURIST.workgroups[wg].name +
						' saved searches" id="' + top.HEURIST.workgroups[wg].name.replace(/\s/g,'') + '-wg-searches">';
						for (var j = 0; j < ss.length; j++) {
							iHTML += "<option value='" + ss[j][1].replace(/\+/g," ") + "'>" + ss[j][0] + "</option>";
						}
						iHTML += "</optgroup>";
					}
				}
				document.getElementById("search-select").innerHTML = iHTML;

				iHTML = "";
				for (var i = 0; i < top.HEURIST.user.workgroups.length; i++) {
					var wg = top.HEURIST.user.workgroups[i];
					iHTML += "<option value=" + wg + ">" + top.HEURIST.workgroups[wg].name + "</option>";
				}
				document.getElementById("wg-options").innerHTML += iHTML;

				document.title += " Save collection (" + top.HEURIST.search.collectCount + " records) as Saved Search";
				setTimeout(function() { document.getElementById('search-select').focus() }, 10);
				var tagsElt = document.getElementById('personal-tags');
				window.autocomplete = new top.HEURIST.autocomplete.AutoComplete(tagsElt, top.HEURIST.util.tagAutofill, { nonVocabularyCallback: top.HEURIST.util.showConfirmNewTag });

				var removeButton = document.getElementById("remove-button");
				var addButton = document.getElementById("add-button");

				var currWgTagsElt = document.getElementById("current-workgroup-tags");
				var allWgTagsElt = document.getElementById("all-workgroup-tags");
				HEURIST.wgTagEditor.WgTagEditor(currWgTagsElt, allWgTagsElt, addButton, removeButton);

			}

			function keypress(e) {
				if (! e)
				e = window.event;
				var code = e.keyCode;
				if (e.which)
				code = e.which;
				// " and '
				if (code == 34  ||  code == 39)
				return false;
			}


			function checkPersonalTags() {
				var tagsElem = document.getElementById("personal-tags");
				var tagsWarnStyle = document.getElementById('personal-tags-warning').style;
				if (tagsElem.value && tagsWarnStyle.display) {
					tagsWarnStyle.display = "";
				} else if (!tagsElem.value && !tagsWarnStyle.display) {
					tagsWarnStyle.display = "none";
				}
			}

			function save() {
				var action_fr = parent.document.getElementById("i_action").contentWindow;
				var action_elt = action_fr.document.getElementById("action");
				var ss_name_elt = action_fr.document.getElementById("svs_Name");
				var ss_query_elt = action_fr.document.getElementById("svs_Query");
				var ss_wgid_elt = action_fr.document.getElementById("svs_UGrpID");
				var ss_id_elt = action_fr.document.getElementById("svs_ID");
				var ss_kwds_elt = action_fr.document.getElementById("tagString");
				action_fr.document.getElementById("bib_ids").value = top.HEURIST.search.collection.join(',');

				if (! action_fr  ||  ! action_elt  ||  ! ss_name_elt  ||  ! ss_query_elt  ||  ! ss_wgid_elt ||  ! ss_id_elt ||  ! ss_kwds_elt) {
					alert("Problem contacting server - try again in a moment");
					return;
				}
				if ($('input[name="ssType"]:checked').val()== "1") { //create a saved search
					action_elt.value = "bookmark_tag_and_ssearch";
					ss_name_elt.value = document.getElementById("search-name").value;
					if (!ss_name_elt.value) {
						alert("You must enter name for the saved-search before saying.");
						return;
					}
					ss_wgid_elt.value = document.getElementById("wg-select").value;
					ss_kwds_elt.value = $('#personal-tags').val();
					var kwdsRowTDs = $('#current-workgroup-tags td');
					for (var i=0; i < kwdsRowTDs.length; i++) {
						if (ss_kwds_elt.value) {
							ss_kwds_elt.value += ',';
						}
						ss_kwds_elt.value += kwdsRowTDs[i++].innerHTML + '\\' + kwdsRowTDs[i].innerHTML;
					}
					var query = [];
					if (!ss_kwds_elt.value) {
						alert("You must enter or select at least one tag to save a search.");
						return;
					}else{
						var tags = ss_kwds_elt.value.split(',');
						var q = "";
						for (var j=0; j < tags.length; j++) {
							q += 'tag:"' + tags[j].replace(/^\s*/,'').replace(/\s*$/,'') + '" ';
						}
						query.push('q=' + encodeURIComponent(q));
					}
					var result_style = document.getElementById("result-style-select").value;
					if ($('#result-style-select').val()) {
						query.push("view=" + $('#result-style-select').val());
					}
					query.push("w=" + $("input[name='w']:checked").val());
					ss_query_elt.value = "?" + query.join("&");

				}else{	//tag collections so they show up in an exisitng tag only saved search
					action_elt.value = "bookmark_and_tag";
					ss_kwds_elt.value = $('#search-tag-list').text().replace(/\s\|\s/,',');
				}
				action_elt.form.submit();
				setTimeout(function() { window.close(); }, 10);
			}

			function switchMode(toID,fromID,focusID) {
				$('#'+fromID).removeClass('bggray');
				$('#'+toID).addClass('bggray');
				var enableID = '#' + toID.match(/^[^_]+_/)[0] + "span";
				var disableID = '#' + fromID.match(/^[^_]+_/)[0] + "span";
				$( enableID + " input, " + enableID + " select").attr("disabled",false);
				$( disableID + " input, " + disableID + " select").attr("disabled",true);
				$(enableID + " .wgtag-list tr").show()
				$(disableID + " .wgtag-list tr").hide()
				$('#'+focusID).focus();
			}

			function displayBookmarkCheck(){
				if (document.getElementById("wg-select").value) {
					$('#all')[0].click();
				} else {
					$('bookmark')[0].click();
				}
			}
		</script>
	</head>

	<body class="popup" onload="init();">

		<script src='../../records/tags/autocompleteTags.js'></script>

		<div id="add_to_search" style="padding:10px 0">
				<input type="radio" name="ssType" id="ssType" value="0" checked="checked" onclick="switchMode('add_to_search','create_new_search','search-select');">&nbsp;<b>Add to existing saved search</b>
				<span id="add_span">
				<select id="search-select" style="max-width:150px" onchange="document.getElementById('search-tag-list').innerHTML = this.options[this.selectedIndex].value; document.getElementById('ssType').click(); return false;">
				</select>
				<span class="help prompt" style="margin-left:5px" >
					Only tag-based searches can be used
				</span><br/>
				<div style="margin:10px 0">
					<span style="margin-left: 16px;">The following tag(s) will be added: </span>
					<span id="search-tag-list" style="color: #6A7C99" ></span>
				</div>
				</span>
			</div>

		<div class="separator_row" style="margin-bottom:20px"></div>

			<div id="create_new_search">
			<input type="radio" name="ssType" value="1" onclick="switchMode('create_new_search','add_to_search','search-name');">&nbsp;<b>Create new saved search</b><br/>
			<div style="margin-left:16px">
					<div class="div-section">
					<div style="width:125px; text-align:right; display:inline-block">Name for this search:</div>
					<input style="width:150px;height: 17px; margin-left: 5px;" type=text id=search-name onkeypress="return keypress(event)">
						<span style="float: right; margin-right: 107px;">
							<input type="radio" name="w" value="all" id="all" checked="checked" onclick="document.getElementById('bookmark-warning').style.display = 'none';">
							<label for="all" >&nbsp;search all records</label><br/>
						</span>
					</div>
					<div class="div-section">
					<div style="width:125px; text-align:right; display:inline-block">Add search to:</div>
					<select id=wg-select onChange="displayBookmarkCheck();" style="width:150px;margin-left: 5px; height: 17px;">
							<option value="">personal saved searches</option>
							<optgroup label="workgroup saved searches" id=wg-options></optgroup>
						</select>
						<span style="float: right; margin-right: 56px;">
							<input type="radio" name="w" id="bookmark" value="bookmark" onclick="document.getElementById('bookmark-warning').style.display = '';">
							<label for="bookmark">&nbsp;only my bookmarked records</label><br/>
							<span class="warning-message" id="bookmark-warning" style="margin-left: 25px; display: none;">&nbsp;records in collection will be bookmarked</span>
						</span>
					</div>
					<div class="div-section">
					<div style="width:125px; text-align:right; display:inline-block">Personal tag(s)</div>
					<input style="width:150px;height: 17px; margin-left:5px" type=text id="personal-tags" onkeypress="setTimeout(function(){checkPersonalTags();},10); return true;"><span class="warning-message" id="personal-tags-warning" style="margin-left: 5px; display:none;">records in collection will be bookmarked</span>
				<div class="help prompt" style="margin-left:133px">
				Note: any records with these tags will be included in the saved search
					</div>
				<div class="div-section" style="margin-top:20px">
						<span style="float: left; margin: 0;">Workgroup tag(s) &nbsp;&nbsp;</span>
						<span class="help prompt" >
							Use for personal or workgroup saved searches.
						</span>

						<br clear=all>

						<table border=0 cellspacing=0 cellpadding=0 style="margin: 10px 0;">
							<tr>
							<td style="width:45%;"><b>Available</b></td>
							<td style="width:10%;"></td>
							<td style="width:45%;"><b>Selected</b></td>
							</tr>

							<tr>
								<td>
								<div class=wgtag-list style="height:150px;"><table border=0 cellspacing=0 cellpadding=0><tbody id=all-workgroup-tags></tbody></table></div>
								</td>
								<td>
								<div id=button-box style="text-align:center; padding:0">
									<div style="padding:5px"><input type=button value="&gt;" title="Add a tag" onmousedown="HEURIST.wgTagEditor.addWgTag(window.selectedRow)" disabled id=add-button></div>
									<div style="padding:5px"><input type=button value="&lt;" title="Remove a tag" onmousedown="HEURIST.wgTagEditor.removeWgTag(window.selectedRow)" disabled id=remove-button></div>
									</div>
								</td>
								<td>
								<div class=wgtag-list style="height:150px;"><table border=0 cellspacing=0 cellpadding=0><tbody id=current-workgroup-tags></tbody></table></div>
								</td>
							</tr>

							<tr class=help>
								<td class=prompt>Double-click to add a tag</td>
								<td>&nbsp;&nbsp;</td>
								<td class=prompt>Double-click to deselect a tag</td>
							</tr>
							<tr><td>
									<div id="admin-wgTags"><br><a href="../../admin/ugrps/editGroupTags.php" target="_blank">add/delete</a> tags for workgroups (administrators only). </div>
							</td></tr>
						</table>

						<form id=wgtag-form onsubmit="return false;"></form> <!-- not used so stub teh submit -->

						Default result style:
						<select id=result-style-select>
							<option value="" selected>Status quo</option>
							<option value=list>One column</option>
							<option value=two-col>Two columns</option>
							<option value=icon>Icon</option>
							<option value=thumbs>Thumbnails</option>
							<option value=blog disabled>Blog</option>
						</select>
					</div>
				</div>

			</div>
		</div>

		<div class="separator_row" style="margin:20px 0"></div>

		<p><input type=button value=Save id=save onclick="save();" style="float: right; margin-right: 50px;"></p>

	</body>

</html>
