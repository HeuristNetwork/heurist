<!--

/**
* filename, brief description, date of creation, by whom
* @copyright (C) 2005-2010 University of Sydney Digital Innovation Unit.
* @link: http://HeuristScholar.org
* @license http://www.gnu.org/licenses/gpl-3.0.txt
* @package Heurist academic knowledge management system
* @todo
**/

-->
<html>
	<head>
		<link rel=stylesheet href="../../common/css/global.css">
		<link rel=stylesheet href="../../common/css/search.css">
		<title>Save search query, filter and layout</title>
		<script>
			var qparams = window.location.search;

			var ssid = Number(top.HEURIST.util.getUrlParameter("ssid", qparams)),
				wgId = 0,
				sLabel = "",
				sQuery = "",
				sAllOrBookmarks = "all",
				sFilter = "",
				sLayout = top.HEURIST.search.getLayoutString(), //current layout
				sSelids = top.HEURIST.search.getSelectedString()[1],//current selids
				rtFilter,
				relFilter,
				ptrFilter;
			if(sLayout.length > 1 && sLayout[0] > -1){
				sLayout = sLayout[1];
			}
			if(ssid>0){
				//load values from  top.HEURIST.user.savedSearches
				//find it by ID
				var ss = top.HEURIST.search.savedSearchFind(ssid);

				if(ss===null){
					//not found - show warning??
				}else{
					wgId = Number(ss[3]);
					sLabel = ss[0];
					sQuery = top.HEURIST.util.getUrlParameter("q", ss[1]);
					sAllOrBookmarks = top.HEURIST.util.getUrlParameter("w", ss[1]);
					// or it may taken from
					if(top.HEURIST.util.isempty(sAllOrBookmarks)){
						sAllOrBookmarks = (ss[4] == 1)?"all":"bookmark";
					}
					sSelids = getParams2("selids", ss[1]);
					sLayout = getParams2("layout", ss[1]);

					//extract filters from query
					rtFilter = getParams2("rtfilters", ss[1]);
					relFilter = getParams2("relfilters", ss[1]);
					ptrFilter = getParams2("ptrfilters", ss[1]);
				}

			}else{
				//load values from current search query
				sLabel = "";//decodeURIComponent(top.HEURIST.parameters["label"]);
				sQuery = top.HEURIST.parameters["q"];
				sAllOrBookmarks = top.HEURIST.parameters["w"];
				if(top.HEURIST.util.isempty(sAllOrBookmarks)){
					sAllOrBookmarks = "all";
				}

				rtFilter = top.HEURIST.search.getPushDownFilter("rectype"),
				relFilter = top.HEURIST.search.getPushDownFilter("reltype"),
				ptrFilter = top.HEURIST.search.getPushDownFilter("ptrtype");
				if (!sQuery) {
					sQuery = top.HEURIST.util.getUrlParameter("q", qparams);
					if (sQuery) {
						sQuery = decodeURIComponent(sQuery);
					}
				}
				if ( /*!sQuery || */sQuery.search(/_COLLECTED_/) !== -1) {
					/*if (!sQuery) {// no query so nothing to save  ???? except filtering and layout!!!!
						alert("There is no search string to save. Please enter a search and then save.");
						setTimeout(function() { window.close(); }, 100);
					}else{*/// if the user pressed Save when showing a collection then divert them to saveCollectionPopup.html
						setTimeout(function() { window.close(); top.HEURIST.util.popupURL(top, top.HEURIST.baseURL+'search/saved/saveCollectionPopup.html?db='+
												(top.HEURIST.parameters['db'] ? top.HEURIST.parameters['db'] :
													(top.HEURIST.database && top.HEURIST.database.name ?
														top.HEURIST.database.name : "")), {width:650, height:380}
																						  );},100);
					//}
				}
			}

			var f = new Array();
			function _push(val){
				if(top.HEURIST.util.isArray(val) && val.length>0){
					if(!top.HEURIST.util.isempty(val[1])){
						f.push(val[1]);
					}
				} else if(!top.HEURIST.util.isempty(val)){
					f.push(val);
				}
			}
			_push(rtFilter);
			_push(relFilter);
			_push(ptrFilter);
			sFilter = f.join("&");

			/*
			*
			*/
			function getParams2(name, query){
				var res = top.HEURIST.util.getUrlParameter(name, query)
				if(res){ res = name+"="+res; }
				return res;
			}

			/**
			* Assigns values to UI controls
			*/
			top.HEURIST.registerEvent(window, "load", function() {

					/* ARTEM wtf?
					if (publish == "yes"){
					document.getElementById("warning-message").innerHTML = "<b>Your search has not yet been saved</b>";
					document.getElementById("save").value = "Save & publish";
					}
					if (mode == "rename") {
					//this is for editing
					}
					*/

					if(ssid>0){ //editing
						//destination is already fixed so hide interface
						document.getElementById("divSaveDestination").style.display = "none";
						document.getElementById("divSelectStyle").style.display = "none";
						//don't care about mode this is saved
						document.getElementById("rbSaveFilterLayout").style.visibility = "hidden";
						document.getElementById("rbSaveQuery").style.visibility = "hidden";
						document.getElementById("rbSaveAll").style.visibility = "hidden";
						document.getElementById("lblS1").innerHTML = "";
						document.getElementById("lblS2").innerHTML = "";
						document.getElementById("lblS3").innerHTML = "";

						if(!sQuery){ //query not defined so saved filtered layout- filter & Layout only
							document.getElementById("divQuery").style.display = "none";
							document.getElementById("divSelids").style.display = "none";
							document.getElementById("rbSaveFilterLayout").checked = true;
							//todo set height 160
						}else{ //Saved search show only fields editable
							//save any and all changes
							document.getElementById("rbSaveAll").checked = true;
							if (sSelids){
								document.getElementById("cbSelids").checked = true;
							}
							//todo set height 180
						}
					}else{
						//fill save destination select

						var iHTML,
						selval = top.HEURIST.util.getDisplayPreference("savedSearchDest"), //value by default
						selIndex = 0;

						var ele = document.getElementById("edSaveDestination");

						var optElem = document.createElement("option");
						optElem.value = "";
						optElem.innerHTML = (sAllOrBookmarks === "all") ?  '"All records" saved searches' : '"My bookmarks" saved searches';
						ele.replaceChild(optElem, ele.firstElementChild );

						//list of all workgroups
						for (var i = 0; i < top.HEURIST.user.workgroups.length; ++i) {
							var wg = top.HEURIST.user.workgroups[i];
							iHTML += "<option value=\"" + wg + "\">" + top.HEURIST.workgroups[wg].name + "</option>";
							if(selval==wg){
								selIndex =  i + 1;
							}
						}
						document.getElementById("wg-options").innerHTML += iHTML;

						ele.selectedIndex = selIndex; //value by default
					}

					document.getElementById("edName").value = sLabel;
					document.getElementById("edQuery").value = sQuery;
					document.getElementById("edFilter").value = sFilter;
					document.getElementById("edLayout").value = sLayout;
					document.getElementById("edSelids").value = sSelids;

					setTimeout(function() { document.getElementById('edName').focus() }, 10);
			});

			/*
			* Save mode for new one
			*/
			function setSaveMode(){
				var saveFiltersOnly = document.getElementById("rbSaveFilterLayout").checked;
				document.getElementById("divSaveDestination").style.visibility = saveFiltersOnly?"hidden":"visible";
			}
			/*
			* change layout
			*/
			function onChangeLayout(){
				var selectLayout = document.getElementById("slctLayout");
				switch (selectLayout.value) {
					case "":
						document.getElementById("edLayout").value = "";
						break;
					case "layout":
						document.getElementById("edLayout").value = sLayout;
						break;
					default:
						document.getElementById("edLayout").value = "layout=srch:" + selectLayout.value;
				}

				document.getElementById("divSaveDestination").style.visibility = saveFiltersOnly?"hidden":"visible";
			}

			/*
			* Check unique name within group of saved searches
			*/
			/*
			function check_old() {
			var wg = document.getElementById("edSaveDestination").value;
			if (wg) {
			top.HEURIST.util.loadWorkgroupDetails(wg, checkCallback);
			} else {
			checkCallback();
			}
			}

			function checkCallback() {
			var wg = document.getElementById("edSaveDestination").value;
			var savedSearches = wg ? top.HEURIST.user.workgroupSavedSearches[wg] : top.HEURIST.user.savedSearches; //top.HEURIST.workgroups[wg].savedSearches

			var val = document.getElementById("edName").value;
			val = val.replace(/'|"/g, "");
			if (val == "") {
			document.getElementById("edName").value = "";
			document.getElementById("message").innerHTML = "Enter a name";
			return;
			}

			if (savedSearches  &&  savedSearches.length) {
			for (var i = 0; i < savedSearches.length; ++i) {
			if (val == savedSearches[i][0]) {
			document.getElementById("coverall").style.display = "block";
			document.getElementById("alertBox").innerHTML =
			"<p>A search with that name already exists.  "
			+ "Do you want to overwrite it?</p>"
			+ "<input type=hidden id=edName value=\""+val+"\">"
			+ "<input type=hidden id=edSaveDestination value=\""+wg+"\">";
			document.getElementById("alertBox").innerHTML += (wg > 0 ? "This is a <b>workgroup saved search</b>. Other workgroup members will be affected.": "");
			document.getElementById("alertBox").innerHTML += "<input type=button value=overwrite onclick=save()>"
			+ "<input type=button value=cancel onclick=window.close()>";
			return;
			}
			}
			}
			save();
			}
			*/

			function check(){

				if(top.HEURIST.util.isempty(document.getElementById("edName").value)){
					document.getElementById("lblName").style.color = "red";
					document.getElementById("edName").focus();
				}else{
					save();
				}
			}

			/*
			*
			*/
			function save()
			{
				var cmb_label, cmb_url, cmb_workgroup, cmb_id;

				/*ARTEM wtf
				if (publish == "yes"){
				publish = "true";
				}
				if (mode == "rename") {
				cmb_id = ssid;
				}
				*/

				if(ssid>0){
					cmb_id = ssid;
					cmb_workgroup = wgId;
				}else{
					cmb_workgroup = Number(document.getElementById("edSaveDestination").value);
				}
				cmb_label = document.getElementById("edName").value;

				var query = new Array();

				// -------- SEARCH QUERY --------------

				if (!document.getElementById("rbSaveFilterLayout").checked)
					{
					top.HEURIST.util.setDisplayPreference("savedSearchDest", cmb_workgroup);

					var q = document.getElementById("edQuery").value;
					//var w = params["w"]; //@todo - take from variable

					if (cmb_workgroup > 0 ){

						/* ARTEM - wtf
						if (!bkmk_only.checked){
						//for workgroup searches overwrite with all records search
						top.HEURIST.parameters["w"] = "all";
						} else {
						top.HEURIST.parameters["w"] = "bookmark";
						top.HEURIST.parameters["q"] = top.HEURIST.parameters["q"] + " user:" + top.HEURIST.get_user_id();
						}
						*/

						//for workgroups - search in bookmarks only
						//ARTEM????? sAllOrBookmarks = "bookmark";
						//wtf???? q = q + " user:" + top.HEURIST.get_user_id();
					}

					query.push("q="+q);
					query.push("w="+sAllOrBookmarks);
				}else{
					cmb_workgroup = 0; //for filters we save for current user only
				}

				// -------- FILTERS --------------

				if (!document.getElementById("rbSaveQuery").checked && document.getElementById("edFilter").value != "") {
					query.push(document.getElementById("edFilter").value);//TODO: validate format
				}

				// -------- LAYOUT --------------

				if (!document.getElementById("rbSaveQuery").checked && document.getElementById("edLayout").value != "") {
					query.push(document.getElementById("edLayout").value);//TODO: validate format
				}

				// -------- Selids --------------

				if (document.getElementById("cbSelids").checked && document.getElementById("edSelids").value != "") {
					query.push(document.getElementById("edSelids").value);//TODO: validate format
				}

				// --------

				//save query
				cmb_url = "?" + query.join("&");


				var saction = "save_search";
				var _data = {svs_Name:cmb_label, svs_Query:cmb_url, svs_UGrpID:cmb_workgroup, svs_ID:cmb_id};

				top.HEURIST.search.executeAction(saction, _data);
				window.close();
			}

		</script>
		<style>
			#message { color: red; }
			#warning-message { color: #990000; }
			input, select{ margin-top: 5px;}

			#save {font-weight: bold;}
			#coverall {background-color:RGBA(255,255,255,0.5);}

			.llab{
				width:80px;
				text-align:right;
				display:inline-block;
			}
			.fld{
				width:270px;
				height: 17px;
				margin-left: 5px;
			}

		</style>
	</head>

	<body class="popup" width="400" height="250">
		<!-- <div id="mainbody">-->

		<label class="llab" id="lblName">Enter a name:</label>
		<input class="fld" type="text" id="edName">

		<div id="divSelectStyle">
			<label class="llab">Layout style:</label>
			<select class="fld" id="slctLayout" onchange="onChangeLayout()" style="width:140px">
				<option value="">Status quo</option>
				<option value="l">One column</option>
				<option value="2">Two columns</option>
				<option value="t">Thumbnails</option>
				<option value="i">Icons</option>
				<option value="layout"  selected>Save Current Layout</option>
			</select>
		</div>

		<div id="divSaveDestination">
			<label class="llab">Add search to:</label>
			<select class="fld" id="edSaveDestination">
				<option value="">personal saved searches</option>
				<optgroup label="workgroup saved searches" id="wg-options"></optgroup>
			</select>
		</div>

		<div style="text-align: center;padding-bottom: 10px;" id="divSaveMode">
			<input id="rbSaveQuery" type="radio" name="rbSaveMode" style="vertical-align:text-bottom;" onclick="setSaveMode()">&nbsp;<label for="rbSaveQuery" id="lblS1" style="padding:3px;">Save Query</label>
			<input id="rbSaveFilterLayout" type="radio" name="rbSaveMode" style="vertical-align:text-bottom;" onclick="setSaveMode()">&nbsp;<label for="rbSaveFilterLayout" id="lblS2" style="padding:3px;">Save Filter &amp; Layout</label>
			<input id="rbSaveAll" type="radio" name="rbSaveMode" checked style="vertical-align:text-bottom;" onclick="setSaveMode()">&nbsp;<label for="rbSaveAll" id="lblS3" style="padding:3px;">Save All</label>
			<input style="float:right" type=button value="Save" id="save" onClick="check();">
		</div>
		<!--
		<p id=warning-message></p>
		<p id=message></p>
		-->

		<hr/>


		<div><strong>Advanced:</strong></div>
		<div id="divQuery"><label class="llab">Query:</label> <input class="fld" type="text" id="edQuery" /></div>
		<div><label class="llab">Filters:</label> <input class="fld" type="text" id="edFilter" /></div>
		<div><label class="llab">Layout:</label> <input class="fld" type="text" id="edLayout" /></div>
		<div id="divSelids"><label class="llab" >Selids :</label> <input class="fld" type="text" id="edSelids"/> <input type="checkbox" id="cbSelids" style="vertical-align:text-bottom; display: inline;">&nbsp;<label for="cbSelids" id="lblCB1" >Save Selids</label></div>


		<!--
		<div id="coverall" style="display:none">
		<div id="alertBox" ></div>
		</div>
		-->
	</body>
</html>
