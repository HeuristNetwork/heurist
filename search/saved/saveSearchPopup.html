<!--

/**
 * filename, brief description, date of creation, by whom
 * @copyright (C) 2005-2010 University of Sydney Digital Innovation Unit.
 * @link: http://HeuristScholar.org
 * @license http://www.gnu.org/licenses/gpl-3.0.txt
 * @package Heurist academic knowledge management system
 * @todo
 **/

-->
<html>
 <head>
  <link rel=stylesheet href="../../common/css/global.css">
  <link rel=stylesheet href="../../common/css/search.css">
  <title>Save search query, filter and layout</title>
  <script>
  	var qparams = window.location.search;

  	var sId = Number(top.HEURIST.util.getUrlParameter("sid", qparams)),
  		wgId = 0,
  		sLabel = "",
  		sQuery = "",
  		sAllOrBookmarks = "all",
  		sFilter = "",
  		sLayout = top.HEURIST.search.getLayoutString(), //current layout
		rtFilter,
		relFilter,
		ptrFilter;

  	if(sId>0){
		//load values from  top.HEURIST.user.savedSearches
		//find it by ID
		var ss = top.HEURIST.search.savedSearchFind(sId);

		if(ss===null){
			//not found - show warning??
		}else{
			wgId = Number(ss[3]);
			sLabel = ss[0];
			sQuery = top.HEURIST.util.getUrlParameter("q", ss[1]);
			sAllOrBookmarks = top.HEURIST.util.getUrlParameter("w", ss[1]);
			// or it may taken from
			if(top.HEURIST.util.isempty(sAllOrBookmarks)){
				sAllOrBookmarks = (ss[4] == 1)?"all":"bookmark";
			}
			sLayout = getParams2("view", ss[1]);
			if(!sLayout){
				sLayout = getParams2("layout", ss[1]);
			}

			//extract filters from query
			rtFilter = getParams2("rtfilters", ss[1]);
			relFilter = getParams2("relfilters", ss[1]);
			ptrFilter = getParams2("ptrfilters", ss[1]);
		}

	}else{
		//load values from current search query
		sLabel = "";//decodeURIComponent(top.HEURIST.parameters["label"]);
		sQuery = top.HEURIST.parameters["q"];
		sAllOrBookmarks = top.HEURIST.parameters["w"];
		if(top.HEURIST.util.isempty(sAllOrBookmarks)){
			sAllOrBookmarks = "all";
		}

		rtFilter = top.HEURIST.search.getPushDownFilter("rectype"),
		relFilter = top.HEURIST.search.getPushDownFilter("reltype"),
		ptrFilter = top.HEURIST.search.getPushDownFilter("ptrtype");

		// ARTEM wtf?
		// if the user pressed Save when showing a collection then divert them to saveCollectionPopup.html
		if (!sQuery) {
			sQuery = decodeURIComponent(top.HEURIST.util.getUrlParameter("q", qparams));
		}
		if ( !sQuery || sQuery.search(/_COLLECTED_/) !== -1) {
			if (!sQuery) {
				alert("There is no search string to save. Please enter a search and then save.");
				setTimeout(function() { window.close(); }, 100);
			}else{
				setTimeout(function() { window.close(); top.HEURIST.util.popupURL(top, 'saveCollectionPopup.html');},100);
			}
		}
	}

	var f = new Array();
	function _push(val){
		if(top.HEURIST.util.isArray(val) && val.length>0){
			if(!top.HEURIST.util.isempty(val[1])){
				 f.push(val[1]);
			}
		} else if(!top.HEURIST.util.isempty(val)){
			f.push(val);
		}
	}
	_push(rtFilter);
	_push(relFilter);
	_push(ptrFilter);
	sFilter = f.join("&");


	var publish = top.HEURIST.util.getUrlParameter("publish", qparams);  //ARTEM wtf?


	/*
	*
	*/
	function getParams2(name, query){
		var res = top.HEURIST.util.getUrlParameter(name, query)
		if(res){ res = name+"="+res; }
		return res;
	}

	/**
	* Assigns values to UI controls
	*/
	top.HEURIST.registerEvent(window, "load", function() {

/* ARTEM wtf?
		if (publish == "yes"){
			document.getElementById("warning-message").innerHTML = "<b>Your search has not yet been saved</b>";
			document.getElementById("save").value = "Save & publish";
		}
		if (mode == "rename") {
			//this is for editing
		}
*/

  		if(sId>0){ //editing
			document.getElementById("divSaveDestination").style.visibility = "hidden";

			if(!sQuery){ //query not defined - filter only
				document.getElementById("divSaveMode").style.visibility = "hidden";
				document.getElementById("divQuery").style.display = "none";
				document.getElementById("rbS2").checked = true;
			}else{
				document.getElementById("lblS2").innerHTML = "";
				document.getElementById("rbS2").style.display = "none";
				document.getElementById("rbS1").checked = (sFilter=="");
				document.getElementById("rbS3").checked = (sFilter!="");
				document.getElementById("lblS3").innerHTML = "Save Query and Filter";
			}


		}else{
			//fill save destination select

			var iHTML,
				selval = top.HEURIST.util.getDisplayPreference("savedSearchDest"), //value by default
				selIndex = 0;

			var ele = document.getElementById("edSaveDestination");

			var optElem = document.createElement("option");
			optElem.value = "";
			optElem.innerHTML = (sAllOrBookmarks === "all") ?  '"All records" saved searches' : '"My bookmarks" saved searches';
			ele.replaceChild(optElem, ele.firstElementChild );

			//list of all workgroups
			for (var i = 0; i < top.HEURIST.user.workgroups.length; ++i) {
				var wg = top.HEURIST.user.workgroups[i];
				iHTML += "<option value=\"" + wg + "\">" + top.HEURIST.workgroups[wg].name + "</option>";
				if(selval==wg){
					selIndex =  i + 1;
				}
			}
			document.getElementById("wg-options").innerHTML += iHTML;

			ele.selectedIndex = selIndex; //value by default
		}

		document.getElementById("edName").value = sLabel;
		document.getElementById("edQuery").value = sQuery;
		document.getElementById("edFilter").value = sFilter;

		setTimeout(function() { document.getElementById('edName').focus() }, 10);
	});

	/*
	* Save mode for new one
	*/
	function setSaveMode(){
		var saveFiltersOnly = document.getElementById("rbS2").checked;
		document.getElementById("divSaveDestination").style.visibility = saveFiltersOnly?"hidden":"visible";
	}

	/*
	* Check unique name within group of saved searches
	*/
	/*
	function check_old() {
		var wg = document.getElementById("edSaveDestination").value;
		if (wg) {
			top.HEURIST.json.loadWorkgroupDetails(wg, checkCallback);
		} else {
			checkCallback();
		}
	}

	function checkCallback() {
		var wg = document.getElementById("edSaveDestination").value;
		var savedSearches = wg ? top.HEURIST.user.workgroupSavedSearches[wg] : top.HEURIST.user.savedSearches; //top.HEURIST.workgroups[wg].savedSearches

		var val = document.getElementById("edName").value;
			val = val.replace(/'|"/g, "");
		if (val == "") {
			document.getElementById("edName").value = "";
			document.getElementById("message").innerHTML = "Enter a name";
			return;
		}

		if (savedSearches  &&  savedSearches.length) {
			for (var i = 0; i < savedSearches.length; ++i) {
				if (val == savedSearches[i][0]) {
					document.getElementById("coverall").style.display = "block";
					document.getElementById("alertBox").innerHTML =
					  "<p>A search with that name already exists.  "
					  + "Do you want to overwrite it?</p>"
					  + "<input type=hidden id=edName value=\""+val+"\">"
					  + "<input type=hidden id=edSaveDestination value=\""+wg+"\">";
					document.getElementById("alertBox").innerHTML += (wg > 0 ? "This is a <b>workgroup saved search</b>. Other workgroup members will be affected.": "");
					document.getElementById("alertBox").innerHTML += "<input type=button value=overwrite onclick=save()>"
					  + "<input type=button value=cancel onclick=window.close()>";
					return;
				}
			}
		}
		save();
	}
	*/

	function check(){
		save();
	}

	/*
	*
	*/
	function save()
	{
		var action_fr = parent.document.getElementById("i_action").contentWindow;
		var action_elt = action_fr.document.getElementById("action");
		var cmb_label_elt = action_fr.document.getElementById("svs_Name");
		var cmb_url_elt = action_fr.document.getElementById("svs_Query");
		var cmb_workgroup_elt = action_fr.document.getElementById("svs_UGrpID");
		var cmb_id_elt = action_fr.document.getElementById("svs_ID");
		var cmb_instance = action_fr.document.getElementById("db");
		var publish_elt = action_fr.document.getElementById("publish");

		if (! action_fr  ||  ! action_elt  ||  ! cmb_label_elt  ||  ! cmb_url_elt  ||  ! cmb_workgroup_elt) {
			alert("Problem contacting server - try again in a moment");
			return;
		}


		/*ARTEM wtf
		if (publish == "yes"){
			publish_elt.value = "true";
		}
		if (mode == "rename") {
			cmb_id_elt.value = sId;
		}
		*/

		action_elt.value = "save_search";

		if(sId>0){
			cmb_id_elt.value = sId;
			cmb_workgroup_elt.value = wgId;
		}else{
			cmb_workgroup_elt.value = Number(document.getElementById("edSaveDestination").value);
		}
		cmb_label_elt.value = document.getElementById("edName").value;

		var query = new Array();

		// -------- SEARCH QUERY --------------

		if (!document.getElementById("rbS2").checked)
		{
			top.HEURIST.util.setDisplayPreference("savedSearchDest", cmb_workgroup_elt.value);

			var q = document.getElementById("edQuery").value;
			//var w = params["w"]; //@todo - take from variable

			if (cmb_workgroup_elt.value > 0 ){

				/* ARTEM - wtf
				if (!bkmk_only.checked){
					//for workgroup searches overwrite with all records search
					top.HEURIST.parameters["w"] = "all";
				} else {
					top.HEURIST.parameters["w"] = "bookmark";
					top.HEURIST.parameters["q"] = top.HEURIST.parameters["q"] + " user:" + top.HEURIST.get_user_id();
				}
				*/

				//for workgroups - search in bookmarks only
				//ARTEM????? sAllOrBookmarks = "bookmark";
				//wtf???? q = q + " user:" + top.HEURIST.get_user_id();
			}

			query.push("q="+q);
			query.push("w="+sAllOrBookmarks);
		}else{
			cmb_workgroup_elt.value = 0; //for filters we save for current user only
		}

		// -------- FILTERS --------------

		if (!document.getElementById("rbS1").checked) {
			query.push(document.getElementById("edFilter").value);
		}

		// -------- LAYOUT --------------

		var result_style = document.getElementById("edLayout").value;
		if (result_style) {
			if (result_style == "layout") {
				if ( sLayout && sLayout[1] && sLayout[1].length > 0) {
					query.push(sLayout[1])
				}else{
					query.push("layout=srch:l");
				}
			} else {
				query.push("view=" + result_style);
			}
		}else if(sId>0 && sLayout){ //take previous value
			//
			query.push(sLayout);
		}

		// --------

		if (top.HEURIST.database.name)
			cmb_instance.value = top.HEURIST.database.name;

		//save query
		cmb_url_elt.value = "?" + query.join("&");
		action_elt.form.submit();

		setTimeout(function() { window.close(); }, 10);
	}

  </script>
  <style>
    #message { color: red; }
	#warning-message { color: #990000; }
	input, select{ margin-top: 5px;}

	#save {font-weight: bold;}
	#coverall {background-color:RGBA(255,255,255,0.5);}

	.llab{
		width:80px;
		text-align:right;
		display:inline-block;
	}
	.fld{
		width:270px;
		height: 17px;
		margin-left: 5px;
	}

  </style>
 </head>

 <body class="popup" width="400" height="320">
<!-- <div id="mainbody">-->
	<div style="text-align: center;" id="divSaveMode">
		<input id="rbS1" type="radio" name="rbSaveMode" style="vertical-align:text-bottom;" onclick="setSaveMode()">&nbsp;<label for="rbS1" style="padding:3px;">Save Query</label>
		<input id="rbS2" type="radio" name="rbSaveMode" style="vertical-align:text-bottom;" onclick="setSaveMode()">&nbsp;<label for="rbS2" style id="lblS2" style="padding:3px;">Save Filter Rules</label>
		<input id="rbS3" type="radio" name="rbSaveMode" checked="true" style="vertical-align:text-bottom;" onclick="setSaveMode()">&nbsp;<label for="rbS3" style id="lblS3" style="padding:3px;">Save Both</label>
	</div>

	<label class="llab">Enter a name:</label>
	<input class="fld" type="text" id="edName">

  	<p>
		<label class="llab">Layout style:</label>
		<select class="fld" id="edLayout">
			<option value="" selected>Status quo</option>
			<option value=list>One column</option>
			<option value=two-col>Two columns</option>
			<option value=thumbs>Thumbnails</option>
			<option value=icons>Icons</option>
			<option value=layout>Save Current Layout</option>
			<option value=blog disabled>Blog</option>
		</select>
	</p>

  	<p>
		<div><label class="llab">Edit directly:</label><input type="checkbox" onclick="{}"></div>
		<div id="divQuery"><label class="llab">Query:</label><input class="fld" type="text" id="edQuery"></div>
		<div><label class="llab">Filters:</label><input class="fld" type="text" id="edFilter"></div>
	</p>

	<p id="divSaveDestination">
		<label class="llab">Add search to:</label>
			<select class="fld" id="edSaveDestination">
				<option value="">personal saved searches</option>
				<optgroup label="workgroup saved searches" id="wg-options"></optgroup>
			</select>
	</p>

	<hr/>

	<div style="float: right;">
		<p id=warning-message></p>
		<p id=message></p>
		<input style="float:right" type=button value="Save" id="save" onClick="check();">
	</div>

	<div id="coverall" style="display:none">
  			<div id="alertBox" ></div>
	</div>
 </body>
</html>
