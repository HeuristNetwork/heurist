<?php
/* T1000 Database template system
   (c) 2005 Archaeological Computing Laboratory, University of Sydney
   T1000 Developed by Tom Murtagh, Template system Ian Johnson 22 Aug 2005 */

/* INSTRUCTIONS: Change database, table and field names below
                 For multi-table system please see full documentation */

define('RESULTS_PER_PAGE', 50);
if (! defined('UPLOAD_PATH'))
	define('UPLOAD_PATH','');

/* Define the tables and joins/lookups needed 
   An appropriate database and table may be created by running t1000_database_create.sql

   mysql -u root -p < database_create.sql  */

$MAINTABLES['BOOKMARK'] = 'usrBookmarks';
	$PKEY['BOOKMARK'] = 'bkm_ID';
	$INIDATE_FIELD['BOOKMARK'] = 'bkm_Added';
      $MODDATE_FIELD['BOOKMARK'] = 'bkm_Modified';
     $JOINS['BOOKMARK'] = array('BIBLIO-ID' => 'bkm_recID');


$MAINTABLES['BIBLIO'] = 'records';
	$PKEY['BIBLIO'] = 'rec_id';
	$INIDATE_FIELD['BIBLIO'] = 'rec_added';
      $MODDATE_FIELD['BIBLIO'] = 'rec_modified';

$MAINTABLES['LINKED_BIBLIO'] = 'records';
	$PKEY['LINKED_BIBLIO'] = 'rec_id';
	$INIDATE_FIELD['LINKED_BIBLIO'] = 'rec_added';
      $MODDATE_FIELD['LINKED_BIBLIO'] = 'rec_modified';
                $JOINS['LINKED_BIBLIO'] = array('REFTYPE-ID' => 'rec_type');

if (function_exists('get_user_id')) {
      $LOOKUPS['LINKED_BIBLIO'] = array( 'usrBookmarks' => 'rec_id=bkm_recID and bkm_UGrpID='.get_user_id() );
}

/*
$MAINTABLES['RATING_CONTENT'] = 'ratings_content';
	$PKEY['RATING_CONTENT'] = 'rc_id';
$MAINTABLES['RATING_QUALITY'] = 'ratings_quality';
	$PKEY['RATING_QUALITY'] = 'rq_id';
$MAINTABLES['RATING_INTEREST'] = 'ratings_interest';
	$PKEY['RATING_INTEREST'] = 'ri_id';
*/

$MAINTABLES['KEYWORD'] = 'usrTags';
	$PKEY['KEYWORD'] = 'kwd_id';

$MAINTABLES['REFTYPE'] = 'rec_types';
	$PKEY['REFTYPE'] = 'rt_id';
	$JOINS['REFTYPE'] = array('ACTIVE_REFTYPE-ID' => 'rt_id');

$MAINTABLES['ACTIVE_REFTYPE'] = 'active_rec_types';
	$PKEY['ACTIVE_REFTYPE'] = 'art_id';
	$JOINS['ACTIVE_REFTYPE'] = array('REFTYPE-ID' => 'art_id');

$MAINTABLES['USER'] = USERS_DATABASE.'.'.USERS_TABLE;
	$PKEY['USER'] = USERS_ID_FIELD;

$MAINTABLES['WORKGROUP'] = USERS_DATABASE.'.'.GROUPS_TABLE;
	$PKEY['WORKGROUP'] = GROUPS_ID_FIELD;


$MAINTABLES['CUSTOMBOOKMARK'] = 'saved_searches';
	$PKEY['CUSTOMBOOKMARK'] = 'ss_id';
	$INIDATE_FIELD['CUSTOMBOOKMARK'] = 'ss_added';
      $MODDATE_FIELD['CUSTOMBOOKMARK'] = 'ss_modified';



$MAINTABLES['BIB_DETAIL'] = 'rec_details';
	$PKEY['BIB_DETAIL'] = 'rd_id';
	$JOINS['BIB_DETAIL'] = array('BIBLIO-ID' => 'rd_rec_id', 'LINKED_BIBLIO-ID' => 'rd_rec_id', 'BIB_DETAIL_TYPE-ID' => 'rd_type');

$MAINTABLES['BIB_DETAIL_TYPE'] = 'rec_detail_types';
	$PKEY['BIB_DETAIL_TYPE'] = 'rdt_id';
	$JOINS['BIB_DETAIL_TYPE'] = array('REFTYPE-ID' => 'rdt_constrain_rec_type');

$MAINTABLES['BIB_DETAIL_REQ'] = 'rec_detail_requirements';
	$PKEY['BIB_DETAIL_REQ'] = 'rdr_id';
	$LINK_KEYS['BIB_DETAIL_REQ'] = array('REFTYPE-ID' => 'rdr_rec_type', 'BIB_DETAIL_TYPE-ID' => 'rdr_rdt_id');

$MAINTABLES['BDR_OVERRIDES'] = 'rec_detail_requirements_overrides';
	$PKEY['BDR_OVERRIDES'] = 'rdr_id';
	$LINK_KEYS['BDR_OVERRIDES'] = array('REFTYPE-ID' => 'rdr_rec_type', 'BIB_DETAIL_TYPE-ID' => 'rdr_rdt_id');


$MAINTABLES['BIB_DETAIL_LOOKUP'] = 'rec_detail_lookups';
	$PKEY['BIB_DETAIL_LOOKUP'] = 'rdl_id';
	$JOINS['BIB_DETAIL_LOOKUP'] = array('ACTIVE_BIB_DETAIL_LOOKUP-ID' => 'rdl_id');

$MAINTABLES['ACTIVE_BIB_DETAIL_LOOKUP'] = 'active_rec_detail_lookups';
	$PKEY['ACTIVE_BIB_DETAIL_LOOKUP'] = 'ardl_id';
	$JOINS['ACTIVE_BIB_DETAIL_LOOKUP'] = array('BIB_DETAIL_LOOKUP-ID' => 'ardl_id');


/* Define lookups for fields which should be coded values (many-to-one with main table)
   Syntax: lookup-table-name => main-table-join-field = lookup-table-join-field', ... */

/* SAW Removed 8/11/2010 no longer used
	$LOOKUPS['BOOKMARK'] = 
		array (
			'ratings_content' => 'pers_content_rating=rc_id',
			'ratings_quality' => 'pers_quality_rating=rq_id',
			'ratings_interest' => 'pers_interest_rating=ri_id');
*/

$MAINTABLES['USER_CLOUD'] = 'coll_groups';
      $PKEY['USER_CLOUD'] = 'cgr_id';

$MAINTABLES['USER_CLOUDS_TO_USERS'] = 'coll_group_links';
      $PKEY['USER_CLOUDS_TO_USERS'] = 'cgl_id';

/* Many-to-many relationships with the main table */

	$LINK_KEYS['USER_CLOUDS_TO_USERS'] = array(	'USER_CLOUD-ID' => 'cgl_cgr_id',
        		                                'USER-ID' => 'cgl_usr_id');

$MAINTABLES["BOOKMARKS_TO_KEYWORDS"] = 'keyword_links';
	$PKEY["BOOKMARKS_TO_KEYWORDS"] = 'kwl_id';
        $LINK_KEYS["BOOKMARKS_TO_KEYWORDS"] = array(	"BOOKMARK-ID" => "kwl_pers_id",
							"KEYWORD-ID"  => "kwl_kwd_id");

/* Custom searches  */

/* define search order with TYPENAME-order */

/* NO LONGER NEEDED - HAVE SEPARATED INTO SEPARATE PAGES WITH THEIR OWN SEARCH
if (@$_REQUEST['showall']) { 
 * for the search page: if showall is set,
 * then we select every URL that hasn't been bookmarked by this user already,
 * but only one bookmark per URL (we arbitrarily select the one with the minimum user id)
	$SEARCHES["BOOKMARK_search"] = "SELECT bkm_ID, bkm_UGrpID, min(bkm_UGrpID) as min_user_id FROM usrBookmarks WHERE (
		bkm_UGrpID != [logged-in-user-id] and
		if ([bkmk_title]!='', if([bkmk_title]!='=', bkmk_title like [%bkmk_title%], bkmk_title = ''), 1) and
		if ([bkmk_url]!='', bkmk_url like [%bkmk_url%], 1) and
		if ([pers_notes]!='', pers_notes like [%pers_notes%], 1) and
		if ([bkmk_category_id]!='', bkmk_category_id = [bkmk_category_id], 1) and
		if ([bkmk_keywordstring]!='', bkmk_keywordstring like [%bkmk_keywordstring%], 1)
		)
		group by bkmk_url
		having bkm_UGrpID=min_user_id
		";
} else {
*/

/* My Bookmarks search */
	
define('KEYWORD_search-order', 'kwd_name');

if (@$_REQUEST['sort_order_dropdown']  &&  in_array($_REQUEST['sort_order_dropdown'], array('title', 'modified', 'added', 'url', 'popularity'))) {
	if ($_REQUEST['sort_order_dropdown'] == 'added'  or
		$_REQUEST['sort_order_dropdown'] == 'modified'  or
		$_REQUEST['sort_order_dropdown'] == 'popularity')
		$_REQUEST['sort_order_dropdown'] = $_REQUEST['sort_order_dropdown'] . ' desc';
	if ($_REQUEST['sort_order_dropdown'] == 'title') {
		define('BOOKMARK_search-order', 'usrBookmarks.bkmk_title = "", usrBookmarks.bkmk_title');
		define('BIBLIO_search_all-order', 'rec_title = "", rec_title');
		define('simple_BIBLIO_search-order', 'rec_title = "", rec_title');
		define('others_BIBLIO_search-order', 'rec_title = "", rec_title');
	} else {
		define('BOOKMARK_search-order', 'usrBookmarks.bkmk_' . $_REQUEST['sort_order_dropdown']);
		define('BIBLIO_search_all-order', 'bib_' . $_REQUEST['sort_order_dropdown']);
		define('simple_BIBLIO_search-order', 'bib_' . $_REQUEST['sort_order_dropdown']);
		define('others_BIBLIO_search-order', 'bib_' . $_REQUEST['sort_order_dropdown']);
	}
	$_SESSION[HEURIST_INSTANCE_PREFIX.'heurist'][HEURIST_INSTANCE_PREFIX.'heurist']['sort_order'] = $_REQUEST['sort_order_dropdown'];
} else if (@$_SESSION[HEURIST_INSTANCE_PREFIX.'heurist'][HEURIST_INSTANCE_PREFIX.'heurist']['sort_order']) {
	if ($_SESSION[HEURIST_INSTANCE_PREFIX.'heurist'][HEURIST_INSTANCE_PREFIX.'heurist']['sort_order'] == 'title') {
		define('BOOKMARK_search-order', 'usrBookmarks.bkmk_title = "", usrBookmarks.bkmk_title');
		define('BIBLIO_search_all-order', 'rec_title = "", rec_title');
		define('simple_BIBLIO_search-order', 'rec_title = "", rec_title');
		define('others_BIBLIO_search-order', 'rec_title = "", rec_title');
	} else {
		define('BOOKMARK_search-order', 'usrBookmarks.bkmk_' . $_SESSION[HEURIST_INSTANCE_PREFIX.'heurist'][HEURIST_INSTANCE_PREFIX.'heurist']['sort_order']);
		define('BIBLIO_search_all-order', 'bib_' . $_SESSION[HEURIST_INSTANCE_PREFIX.'heurist'][HEURIST_INSTANCE_PREFIX.'heurist']['sort_order']);
		define('simple_BIBLIO_search-order', 'bib_' . $_SESSION[HEURIST_INSTANCE_PREFIX.'heurist'][HEURIST_INSTANCE_PREFIX.'heurist']['sort_order']);
		define('others_BIBLIO_search-order', 'bib_' . $_SESSION[HEURIST_INSTANCE_PREFIX.'heurist'][HEURIST_INSTANCE_PREFIX.'heurist']['sort_order']);
	}
} else {
	define('BOOKMARK_search-order', 'usrBookmarks.bkmk_title = "", usrBookmarks.bkmk_title');
	define('BIBLIO_search_all-order', 'rec_title = "", rec_title');
	define('simple_BIBLIO_search-order', 'rec_title = "", rec_title');
	define('others_BIBLIO_search-order', 'rec_title = "", rec_title');
}


/*
$SEARCHES["BOOKMARK_search"] = "SELECT bkm_ID FROM usrBookmarks WHERE (
		(bkm_UGrpID = [logged-in-user-id]) and
		if ([bkmk_title]!='', if([bkmk_title]!='=', bkmk_title like [%bkmk_title%], bkmk_title = ''), 1) and
		if ([bkmk_url]!='', bkmk_url like [%bkmk_url%], 1) and
		if ([pers_notes]!='', pers_notes like [%pers_notes%], 1) and
		if ([bkmk_category_id]!='', bkmk_category_id = [bkmk_category_id], 1) and
		if ([bkmk_keywordstring]!='', bkmk_keywordstring like [%bkmk_keywordstring%], 1) and
		if ([bkmk_reftype]!='', bkmk_reftype = [bkmk_reftype], 1)
		)
		";
*/
$SEARCHES["BOOKMARK_search"] = "SELECT distinct bkm_ID FROM usrBookmarks left join records on bkm_recID=rec_id WHERE (
		(bkm_UGrpID = [logged-in-user-id]) and
		[word-match:bkmk_title:bkmk_title] and 
		if ([bkmk_advanced_search] and [bkmk_url]!='', bkmk_url like [%bkmk_url%], 1) and
		if ([bkmk_advanced_search] and [pers_notes]!='', pers_notes like [%pers_notes%], 1) and
		if ([bkmk_advanced_search] and [bkmk_reftype]!='', rec_type = [bkmk_reftype], 1)
                and not rec_temporary
		)
		";	/* may be over-written by search.php */

$SEARCHES["augmented_BOOKMARK_search"] = "SELECT distinct bkm_ID FROM usrBookmarks left join records on bkm_recID=rec_id left join keyword_links on kwl_pers_id=bkm_ID WHERE (
		(bkm_UGrpID = [logged-in-user-id]) and
		[word-match:bkmk_title:bkmk_title] and 
		if ([bkmk_advanced_search] and [bkmk_url]!='', bkmk_url like [%bkmk_url%], 1) and
		if ([bkmk_advanced_search] and [pers_notes]!='', pers_notes like [%pers_notes%], 1) and
		if ([bkmk_advanced_search] and [bkmk_reftype]!='', rec_type = [bkmk_reftype], 1)
                and not rec_temporary
		)
		";	/* may be appended-to by search.php */


define('BOOKMARK_search_all-order', 'bkmk_title');


/* All Bookmarks search */

/*
$SEARCHES["BOOKMARK_search_all"] = "SELECT bkm_ID, bkm_UGrpID FROM usrBookmarks WHERE (
		bkm_UGrpID != [logged-in-user-id] and
		if ([bkmk_title]!='', bkmk_title like [%bkmk_title%], 1) and
		if ([bkmk_url]!='', bkmk_url like [%bkmk_url%], 1) and
		if ([pers_notes]!='', pers_notes like [%pers_notes%], 1) and
		if ([bkmk_keywordstring]!='', bkmk_keywordstring like [%bkmk_keywordstring%], 1)
		)";
*/

/* IS THIS ONE USED? */

define('ALLBOOKMARK_search-order', 'bkmk_title');

$SEARCHES["ALLBOOKMARK_search"] = "SELECT bkm_ID FROM usrBookmarks WHERE (
	if ([bkmk_title]!='', bkmk_title like [%bkmk_title%], 1) and
	if ([bkmk_url]!='', bkmk_url like [%bkmk_url%], 1) and
	if ([pers_notes]!='', pers_notes like [%pers_notes%], 1)
	)
	";


/* search the records records for which the user doesn't have a bookmark already */

$SEARCHES["BIBLIO_search"] = "select rec_id from records
	                               left join usrBookmarks on bkm_recID=rec_id and bkm_UGrpID = [logged-in-user-id] where (
	bkm_ID is null and
	[word-match:rec_title:rec_title] and 
	if ([rec_url]!='', rec_url like [%rec_url%], 1) and
	if ([rec_scratchpad]!='', rec_scratchpad like [%rec_scratchpad%], 1)
         and not rec_temporary
	)
	";
$SEARCHES["simple_BIBLIO_search"] = "select distinct rec_id from records  where (
	[word-match:rec_title:rec_title] and 
	if ([bib_advanced_search] and [rec_url]!='', rec_url like [%rec_url%], 1) and
	if ([bib_advanced_search] and [rec_type]!='', rec_type = [rec_type], 1)
         and not rec_temporary
	)
	";
$SEARCHES["augmented_simple_BIBLIO_search"] = "select distinct rec_id from records left join usrBookmarks on bkm_recID=rec_id left join keyword_links on kwl_pers_id=bkm_ID where (
	[word-match:rec_title:rec_title] and 
	if ([bib_advanced_search] and [rec_url]!='', rec_url like [%rec_url%], 1) and
	if ([bib_advanced_search] and [rec_type]!='', rec_type = [rec_type], 1)
         and not rec_temporary
	)
	";

$SEARCHES["others_BIBLIO_search"] = "select distinct rec_id from records
	                               left join usrBookmarks on bkm_recID=rec_id and bkm_UGrpID = [logged-in-user-id] where (
	bkm_ID is null and
	[word-match:rec_title:rec_title] and 
	if ([bib_advanced_search] and [rec_url]!='', rec_url like [%rec_url%], 1) and
	if ([bib_advanced_search] and [rec_type]!='', rec_type = [rec_type], 1)
         and not rec_temporary
	)
	";

$SEARCHES['augmented_others_BIBLIO_search'] = "select distinct rec_id from records
	                               left join usrBookmarks A on A.bkm_recID=rec_id
                                       left join usrBookmarks B on B.bkm_recID=A.bkm_recID and B.bkm_UGrpID = [logged-in-user-id]
                                       left join keyword_links on kwl_pers_id=A.bkm_ID where (
	B.bkm_ID is null and
	[word-match:rec_title:rec_title] and 
	if ([bib_advanced_search] and [rec_url]!='', rec_url like [%rec_url%], 1) and
	if ([bib_advanced_search] and [rec_type]!='', rec_type = [rec_type], 1)
         and not rec_temporary
	)
	";





/* THIS IS N0T USED TO THE BEST OF MY KNOWLEDGE, but might be if we want to
   simplify the front screen search
define('BOOKMARK_simple_search-order', 'bkmk_title');
$SEARCHES["BOOKMARK_simple_search"] = "SELECT bkm_ID FROM usrBookmarks WHERE (
		if ([bkm_UGrpID]!='',bkm_UGrpID = [bkm_UGrpID], bkm_UGrpID = [logged-in-user-id]) and
		if ([bkmk_title]!='', bkmk_title like [%bkmk_title%], 1) and
		if ([bkmk_category_id]!='', bkmk_category_id = [bkmk_category_id], 1)
		)
		";
*/



define('CATEGORY_search-order', 'cat_label');

$SEARCHES["CATEGORY_search"] = "SELECT cat_id FROM categories WHERE (
		(cat_user_id = [logged-in-user-id]) and 
		if ([cat_label]!='', cat_label like [%cat_label%], 1)  )";

define('CUSTOMBOOKMARK_search-order', '!(ss_url like "%w=bookmark%" OR ss_url like "%search_type=bookmark%"), ss_name');


define('user_kwds-order', 'kwd_name');
define('user_kwds-RESULTS_PER_PAGE', 10000);
$SEARCHES['user_kwds'] = 'select distinct tag_ID from usrTags left join keyword_links on tag_ID=kwl_kwd_id where kwl_id is not null and tag_UGrpID = [logged-in-user-id]';

?>
