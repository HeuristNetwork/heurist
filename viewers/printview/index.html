<!--

/**
 * filename, brief description, date of creation, by whom
 * @copyright (C) 2005-2010 University of Sydney Digital Innovation Unit.
 * @link: http://HeuristScholar.org
 * @license http://www.gnu.org/licenses/gpl-3.0.txt
 * @package Heurist academic knowledge management system
 * @todo
 **/

-->
<html>
	<head>
		<link rel="stylesheet" href="../../common/css/printview.css"/>
		<link rel="stylesheet" href="../../common/css/printview_print.css" media="print"/>
		<script src="../../external/jquery/jquery-1.6.min.js"></script>
		<script src="loadPrintFormats.php"></script>
		<script>
			function loadXMLDocFromFile(filename)
			{
				var xmlDoc=null;
				var errorMsg = "Error loading " + filename + " using XMLHttpRequest";
				var d;
				try {
					d = new XMLHttpRequest();
				} catch (trymicrosoft) {
					try {
						d = new ActiveXObject("Msxml2.XMLHTTP");
					} catch (othermicrosoft) {
						try {
							d = new ActiveXObject("Microsoft.XMLHTTP");
						} catch (failed) {
							d = false;
						}
					}
				}
				if (d) {
					try{
						d.open("GET", filename, false);
						d.send("");
						xmlDoc=d.responseXML;
					}catch(e){
						alert(errorMsg + " Hint : " + e);
					}
				}else{
					alert("Your browser doesn't process XSL. Unable to view content.");
				}
				return xmlDoc;
			}

			function fillStyles(s) {
				var styleSelectElt = document.getElementById("style_select");
				styleSelectElt.options[0] = new Option("Select a style...", "");
				styleSelectElt.options[0].disabled = true;
				var i = 1;
				for (var n = 0; n < styles.length; ++n) {
					var style = styles[n];
					styleSelectElt.options[i++] = new Option(style[1], style[0]);
					if (style[0] == s) styleSelectElt.selectedIndex = i-1;
				}
				styleSelectElt.options[i] = new Option("Generic XML", "genericXML");
			}

			var xml;
			var pageXMLs = {};
			var aReq;
			var selectedIds;
			var xsls = {};
			var query;
			var aquery;
			var loadingPage;
			var loadCount;	// to restict the number of pages that are loaded. Some queries gives all records.
			var maxLoadPages = 10;
			var curStyle = top.HEURIST.util.getDisplayPreference("defaultPrintView"); //saved default stylesheet
			var currentPage = 1;
			var totalRecordCount = 0;
			var resultsPerPage = 50;
			var pageCount = 0;
			var hBase = "http://" + window.location.host +
						(top && top.HEURIST && top.HEURIST.basePath? top.HEURIST.basePath : window.location.pathname.match(/^\/[^\/]+\//));
			var database = (top && top.HEURIST && top.HEURIST.database? top.HEURIST.database.name :
								(location.search.match(/db=([^&]+)/) ? location.search.match(/db=([^&]+)/)[1]: ""));

			function init() {
			//initialize parameters
				if (top.HEURIST && top.HEURIST.search) {
				// style
					if (location.search.match(/style=([^&=#]*)/)) {
						var temp = location.search.match(/style=([^&=#]*)/)[1];
						if (styles[temp]) { //check if there is a template for this style
							curStyle = temp;
						}
					}
				//selection
					if (location.search.match(/selectedIds=([0-9,]*)/)){
						selectedIds = location.search.match(/selectedIds=([0-9,]*)/);
						if (selectedIds) {
							selectedIds = selectedIds.split(",");
						}
					}else if (top.HEURIST.search.getSelectedRecIDs().get().length > 0) {
						selectedIds = top.HEURIST.search.getSelectedRecIDs().get();
					}
				//query
					query = location.search.replace(/&?selectedIds=([0-9,]*)/,"");
					query = query.replace(/&?style=[^&=#]*/,"");
					query = query.replace(/\?&/,"?");
					var q = query.match(/q=([^&=#]*)/);
					if (!q && top.HEURIST.parameters['q']){ //no query passed in so build one from HEURIST.params
						query = "?";
						for ( var paramName in top.HEURIST.parameters) {
							if (query.length ==1) {
								query += paramName + "=" + top.HEURIST.parameters[paramName];
							}else{
								query += "&" + paramName + "=" + top.HEURIST.parameters[paramName];
							}
						}
						//set paging parameters to match
						if (top.HEURIST.search.results.totalQueryResultRecordCount) totalRecordCount = top.HEURIST.search.results.totalQueryResultRecordCount;
						if (top.HEURIST.search.resultsPerPage) resultsPerPage = top.HEURIST.search.resultsPerPage;
						pageCount = Math.ceil(totalRecordCount / resultsPerPage);
						if (top.HEURIST.search.currentPage) currentPage = top.HEURIST.search.currentPage;
						offset = (currentPage -1)*resultsPerPage;
						if (query.search("limit")> -1) {
							query = query.replace(/limit=[^#&=]*/,"limit=" + resultsPerPage);
						}else{
							query += "&limit=" + resultsPerPage;
						}
						if (query.search("offset")>-1) {
							query = query.replace(/offset=[^#&=]*/,"offset=" + offset);
						}else{
							query += "&offset=" + offset;
						}
					}

					if (query && query.search("db")== -1){
						query += "&db=" + database;
					}
					if (query && query.search("a=")== -1){
						query += "&a=1";
					}
					if (query && query.search("f=")== -1){
						query += "&f=1";
					}
					if (query && query.search("stub=")== -1){
						query += "&stub=1";
					}
					if (query && query.search("woot=")== -1){
						query += "&woot=1";
					}
				}
			//load xml
				fillStyles(curStyle);
				if (top.HEURIST) {
					top.HEURIST.registerEvent(this,"heurist-selectionchange",onSelectionChange);
					top.HEURIST.registerEvent(this,"heurist-selectall",onSelectAll);
					top.HEURIST.registerEvent(this,"heurist-pagechange",onPageChange);
				}
			}

			var relatedRecListXSL;

			function displayRelatedRecords(recID,parentDiv){
				var showRelatedLink = parentDiv.firstChild;
				if (parentDiv.className.match(new RegExp('(\\s|^)loaded(\\s|$)'))) {
					if (parentDiv.className.match(new RegExp('(\\s|^)show(\\s|$)'))) {
						parentDiv.className = parentDiv.className.replace(" show", "");
						showRelatedLink.innerHTML = "Show related records";
						return;
					} else {
						parentDiv.className += " show";
						showRelatedLink.innerHTML = "Hide related records";
						return;
					};
				};

				if (parentDiv.className == "related-records show" ) {
					parentDiv.className = parentDiv.className.replace(" show", "");
					showRelatedLink.innerHTML = "Show related records";
					return;
				} else {
					showRelatedLink.className += " wait";
					showRelatedLink.innerHTML = "Loading related records";
					parentDiv.className += " show";

					var xmlRecDepth1 = loadXMLDocFromFile(top.HEURIST.baseURL+
										"export/xml/hml.php?q=ids:"+recID+"&depth=1&woot=1"+
										(top.HEURIST.database.name? "&db=" + top.HEURIST.database.name:""));
					if (!xmlRecDepth1) return;
					if (!relatedRecListXSL) {
						relatedRecListXSL = loadXMLDocFromFile("xsl/relatedRecList.xsl");
					}
					var xhtmlResultDoc;
					if (window.ActiveXObject){
						var xmlResultStr = xmlRecDepth1.transformNode(relatedRecListXSL);
						xhtmlResultDoc=new ActiveXObject("Microsoft.XMLDOM");
						xhtmlResultDoc.async="false";
						xhtmlResultDoc.loadXML(xmlResultStr);
					// code for Mozilla, Firefox, Opera, etc.
					}else {
						var xsltProcessor=new XSLTProcessor();
						xsltProcessor.importStylesheet(relatedRecListXSL);
						xhtmlResultDoc = xsltProcessor.transformToFragment(xmlRecDepth1,document);
					}
					parentDiv.appendChild(xhtmlResultDoc);
					parentDiv.className += " loaded";

					showRelatedLink.className = parentDiv.firstChild.className.replace(" wait", "");
					showRelatedLink.innerHTML = "Hide related records";
					}
				}

			// this function takes the same search but attemps an asynchronous load of the entire result set
			function asyncLoadSearchPages(){
				if (!loadCount || loadCount <=0) return; //nothing to load
				//find next page to load
				loadingPage = null;
				for (var i=1; i <= pageCount; i++){
					if (!pageXMLs[i]) {
						loadingPage = i;
						break;
					}
				}
				if (!loadingPage) { // we are done loading
					loadCount = 0;
					return;
				}
				//set query limits
				aquery = query.replace(/limit=[^#&=]*/,"limit=" + resultsPerPage).replace(/offset=[^#&=]*/,"offset=" + (loadingPage-1)*resultsPerPage);
				var url = hBase + "export/xml/hml.php"+aquery;
				var errorMsg = "Error loading " + url + " using XMLHttpRequest";
				try {
					aReq = new XMLHttpRequest();
				} catch (trymicrosoft) {
					try {
						aReq = new ActiveXObject("Msxml2.XMLHTTP");
					} catch (othermicrosoft) {
						try {
							aReq = new ActiveXObject("Microsoft.XMLHTTP");
						} catch (failed) {
							aReq = false;
						}
					}
				}
				if (aReq) {
					try{
						aReq.open("GET", url, true);
						aReq.onreadystatechange = updateXMLPages;
						aReq.send("");
					}catch(e){
						alert(errorMsg + " Hint : " + e);
					}
				}else{
					alert("Your browser doesn'tsupport asynch loading. Unable to view complete content.");
				}
			}

			function updateXMLPages(){
				if (aReq.readyState == 4) {
					if (aReq.status == 404) {
						alert("Request for full record results failed - URL not found - likely the server is temporarily out of service");
					} else if (aReq.status != 200) {
						//alert("Error: loading page "+ loadingPage +" status code is " + aReq.status + " please contact the system administrator.");
					}else{
						pageXMLs[loadingPage] = aReq.responseXML;
						if (currentPage == loadingPage){
							displayResultPage(curStyle,curPage);
						}
						loadCount -= 1;
						asyncLoadSearchPages(); // try and load the next page
					}
				}
			}

			function objFromArr(arr)
			{
				var obj = {};
				for(var i=0;i<arr.length;i++)
				{
					obj[arr[i]]="";
				}
				return obj;
			}

			var newSelectionIds, newSelectionMap, alreadySelectedMap;

			function onPageChange(eventType, argList) {// saw TODO change this to update the selection for levels
																// if a level is not loaded then load synch
				clearAndDisplayLoading();
				//if page xml not loaded then load sync
				if (eventType == "heurist-pagechange"){
					var page = 0;
					if (argList && argList.match("pageNum")) {
						var page = argList.match("pageNum=(\\d+)")
						page = page[1];
					}else if (top.HEURIST.search.currentPage > 0) {
						page = top.HEURIST.search.currentPage;
					}
					if (page > 0  && page != currentPage && page <= pageCount){
						currentPage = page;
						if (!pageXMLs[page]){ //load pageXML now
							var pageQuery = query;
							pageQuery = pageQuery.replace(/limit=[^#&=]*/,"limit=" + resultsPerPage).replace(/offset=[^#&=]*/,"offset=" + (page-1)*resultsPerPage);
							var url = top.HEURIST.baseURL+ "export/xml/hml.php" + pageQuery;
							var errorMsg = "Error loading " + url + " using XMLHttpRequest";
							pageXMLs[page] = loadXMLDocFromFile(url);
						}
						xml = pageXMLs[page];
						selectedIds = [];
						displayResultPage(curStyle,page);
					}
				}
			}

			function onSelectAll(eventType, argList) {
				function getNodeContents(elem, nodeName,index) {
					if(!elem) return elem;
					var nodes = elem.getElementsByTagName(nodeName);
					if (!isNaN(index)){
						return nodes[index];
					}
					return elem;
				}
				//if page xml not loaded then load sync
				if (eventType == "heurist-selectall"){
					var tempXML,recordsNode;
					for (var page = 1; page <= pageCount; page++){
						if (!pageXMLs[page]){ //load pageXML now
							var pageQuery = query;
							pageQuery = pageQuery.replace(/limit=[^#&=]*/,"limit=" + resultsPerPage).replace(/offset=[^#&=]*/,"offset=" + (page-1)*resultsPerPage);
							var url = top.HEURIST.baseURL+ "export/xml/hml.php" + pageQuery;
							var errorMsg = "Error loading " + url + " using XMLHttpRequest";
							pageXMLs[page] = loadXMLDocFromFile(url);
						}
						if (page == 1){
							tempXML = pageXMLs[page].cloneNode(true); //saw TODO  check if this clones or not
							if(!tempXML){
								tempXML = pageXMLs[page];
							}
							recordsNode = getNodeContents(tempXML,"records",0);
						}else{
							tempXML = pageXMLs[page].cloneNode(true); //saw TODO  check if this clones or not
							if(!tempXML){
								tempXML = pageXMLs[page];
							}
							var recordNodes = getNodeContents(tempXML,"records",0);
							if (!recordsNode) {
								recordsNode = recordNodes;
							}else{
								for (var i =1; i<recordNodes.childNodes.length; i++) {
									recordsNode.appendChild(recordNodes.childNodes[i].cloneNode(true));
								}
							}
						}
					}
					pageXMLs[0] = recordsNode;
					selectedIds = [];
					displayResultPage(curStyle,0);
				}
			}

			function onSelectionChange(eventType, argList) {
				if (eventType == "heurist-selectionchange"){	// saw TODO change this to update the selection for levels
																// if a level is not loaded then load synch
					newSelectionIds = [];
					if (top.HEURIST.search.getSelectedRecIDs().get().length > 0) {
						newSelectionIds = top.HEURIST.search.getSelectedRecIDs().get();
					}else if (argList && argList.match("selectedIds")) {
						var ids = argList.match("selectedIds=(\\d+(?:,\\d+)*)");
						if (ids && ids[1]) newSelectionIds = ids[1].split(",");
					}
					newSelectionMap = objFromArr(newSelectionIds);
					var limit = newSelectionIds.length;
					if (!limit) {
						// todo clear and display no records selected
						return;
					}
						clearAndDisplayLoading();
					var pageQuery = "?w=all&a=1&depth=1&q=ids:"+ newSelectionIds.join(",")+"&limit=" + limit;
					var url = top.HEURIST.baseURL+ "export/xml/flathml.php" + pageQuery;
						var errorMsg = "Error loading " + url + " using XMLHttpRequest";
					xml = loadXMLDocFromFile(url);
					selectedIds = newSelectionIds;
					displayResultDoc(curStyle,xml);
/*
					var selDivs = $('div[class~=selected]');
					if (selDivs) selDivs.map(function(a){ return this.id;}).map(function(i){
																						if (newSelectionMap[this]) {
																							alreadySelectedMap[this] = "";
																						}else{
																							$('div#'+ this).removeClass("selected");
																						}
																					});
					$(newSelectionIds).map(function(i){
													if (!alreadySelectedMap[this]){
														$('div#'+ this).addClass("selected");
													}
												});
					if (selectedIds && selectedIds.length > 0 &&
							$('div#'+selectedIds[selectedIds.length-1],
								$('iframe[id=viewer-frame]',top.document).get(0).contentDocument).length > 0) {
						$('div#'+selectedIds[selectedIds.length-1],$('iframe[id=viewer-frame]',top.document).get(0).contentDocument).get(0).scrollIntoView();
					}
*/				}
			}

			function updateSelection(){// saw TODO change this to update the selection for levels
				if(selectedIds && selectedIds.length>0) {
					for (var i = 0; i < selectedIds.length; i++) {
						$('div[class~=record]').filter('div[id='+ selectedIds[i] +']').addClass("selected");
					}
				}
			}

			function clearAndDisplayLoading(){
				var resultDiv =document.getElementById("displayResult");
				while (resultDiv.childNodes[0]) resultDiv.removeChild(resultDiv.childNodes[0]);
				var loadingDiv = document.createElement("div");
					loadingDiv.id = "loading";
				resultDiv.appendChild(loadingDiv);
			}

			function displayResult(style){
				curStyle = style;
				displayResultDoc(style,xml);
			}

			function displayResultDoc(style,xmlDoc){
				var resultDiv =document.getElementById("displayResult");
				var xhtmlResultDoc = "";
				function clearResult(resultDiv) {
					while (resultDiv.childNodes[0]) resultDiv.removeChild(resultDiv.childNodes[0]);
				}

				if (style == "genericXML") {
					var genXML = $("<xml>").append(xmlDoc.documentElement).html();
					xhtmlResultDoc = document.createTextNode(genXML);
				}else{
					if (!xsls[style]){
						xsls[style]=loadXMLDocFromFile("xsl/" +style +".xsl");
					}
					if (!xsls[style]) {
						alert("Unable to read .xsl file, check to see if this style sheet is readable in your browser or another browser.");
						return;
					}
					// code for IE
					if (window.ActiveXObject){// saw TODO change this transform a combined document for related results
						var xmlResultStr = xmlDoc.transformNode(xsls[style]);
						xhtmlResultDoc=new ActiveXObject("Microsoft.XMLDOM");
						xhtmlResultDoc.async="false";
						xhtmlResultDoc.loadXML(xmlResultStr);
					// code for Mozilla, Firefox, Opera, etc.
					}else {
						var xsltProcessor=new XSLTProcessor();// saw TODO change this transform a combined document for related results
						xsltProcessor.importStylesheet(xsls[style]);
						xhtmlResultDoc = xsltProcessor.transformToFragment(xmlDoc,document);
					}
				}
				clearResult(resultDiv);
				resultDiv.appendChild(xhtmlResultDoc);
				updateSelection();
			}

			function displayResultPage(style,page){
				var resultDiv =document.getElementById("displayResult");
				var xhtmlResultDoc = "";
				function clearResult(resultDiv) {
					while (resultDiv.childNodes[0]) resultDiv.removeChild(resultDiv.childNodes[0]);
				}

				if (style == "genericXML") {
					xhtmlResultDoc = pageXMLs[page].documentElement;
				}else{
					if (!xsls[style]){
						xsls[style]=loadXMLDocFromFile("xsl/" +style +".xsl");
					}
					if (!xsls[style]) {
						alert("Unable to read .xsl file, check to see if this style sheet is readable in your browser or another browser.");
						return;
					}
					// code for IE
					if (window.ActiveXObject){// saw TODO change this transform a combined document for related results
						var xmlResultStr = pageXMLs[page].transformNode(xsls[style]);
						xhtmlResultDoc=new ActiveXObject("Microsoft.XMLDOM");
						xhtmlResultDoc.async="false";
						xhtmlResultDoc.loadXML(xmlResultStr);
					// code for Mozilla, Firefox, Opera, etc.
					}else {
						var xsltProcessor=new XSLTProcessor();// saw TODO change this transform a combined document for related results
						xsltProcessor.importStylesheet(xsls[style]);
						xhtmlResultDoc = xsltProcessor.transformToFragment(pageXMLs[page],document);
					}
				}
				clearResult(resultDiv);
				resultDiv.appendChild(xhtmlResultDoc);
				updateSelection();
			}
		</script>

	</head>
	<body onLoad="init()">
		<div class="banner">
		<select id="style_select" style="width: 180px;" onChange="displayResult(this.options[this.selectedIndex].value);">
		</select>
		<A HREF="javascript:window.print()"><div id="printingLink"></div></a>
		</div>
		<div id="displayResult" ></div>
	</body>
</html>
