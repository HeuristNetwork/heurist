<!--

/**
 * filename, brief description, date of creation, by whom
 * @copyright (C) 2005-2010 University of Sydney Digital Innovation Unit.
 * @link: http://HeuristScholar.org
 * @license http://www.gnu.org/licenses/gpl-3.0.txt
 * @package Heurist academic knowledge management system
 * @todo
 **/

-->
<html>
	<head>
		<link rel="stylesheet" href="../../common/css/printview.css"/>
		<link rel="stylesheet" href="../../common/css/printview_print.css" media="print"/>
		<script src="../js/annotationHighlight.js"></script>
		<script src="../js/getAnnotationPointers.js"></script>
		<script type="text/javascript" src="../../external/jquery/jquery.js"></script>
		<script type="text/javascript" src="../../external/yui/2.8.2r1/build/yahoo-dom-event/yahoo-dom-event.js"></script>

		<script src="loadPrintFormats.php"></script>
		<script>
			function loadXMLDocFromFile(filename)
			{
				var xmlDoc=null;
				var errorMsg = "Error loading " + filename + " using XMLHttpRequest";
				var d;
				try {
					d = new XMLHttpRequest();
				} catch (trymicrosoft) {
					try {
						d = new ActiveXObject("Msxml2.XMLHTTP");
					} catch (othermicrosoft) {
						try {
							d = new ActiveXObject("Microsoft.XMLHTTP");
						} catch (failed) {
							d = false;
						}
					}
				}
				if (d) {
					try{
						d.open("GET", filename, false);
						d.send("");
						xmlDoc=d.responseXML;
					}catch(e){
						alert(errorMsg + " Hint : " + e);
					}
				}else{
					alert("Your browser doesn't process XSL. Unable to view content.");
				}
				return xmlDoc;
			}

			function fillStyles(s) {
				var styleSelectElt = document.getElementById("transform_select");
				styleSelectElt.options[0] = new Option("Select a style...", "");
				styleSelectElt.options[0].disabled = true;
				for (var grpIndex in top.HEURIST.transforms.groupOrder) {
					var grpName = top.HEURIST.transforms.groupOrder[grpIndex];
					var firstInGroup = true;
					for (var index in top.HEURIST.transforms.groups[grpName]){
						var transformID = top.HEURIST.transforms.groups[grpName][index];
						var transform = top.HEURIST.transforms.byID[transformID];
						if (transform["type"] && transform["type"].search(/XSLT/) !== -1) {
							if (firstInGroup){
								//create opt group
								var grp = document.createElement("optgroup");
								grp.label = grpName;
								styleSelectElt.appendChild(grp);
								firstInGroup = false;
							}
							styleSelectElt.appendChild( new Option(transform["label"],transformID));
							if (transform["label"] == s) {
								styleSelectElt.selectedIndex = styleSelectElt.options.length -1;
							}
						}
					}
				}
				styleSelectElt.appendChild(new Option("Generic XML", "0"));
			}

			var xml;
			var pageXMLs = {};
			var aReq;
			var selectedIds;
			var xsls = {};
			var query;
			var aquery;
			var loadingPage;
			var loadCount;	// to restict the number of pages that are loaded. Some queries gives all records.
			var maxLoadPages = 10;
			var curStyle = top.HEURIST.util.getDisplayPreference("defaultPrintView"); //saved default stylesheet
			if (!top.HEURIST.transforms.nameLookup[curStyle]){
				curStyle = "default";
			}
			var curQueryURL;
			var currentPage = 1;
			var totalRecordCount = 0;
			var resultsPerPage = 50;
			var pageCount = 0;
			var hBase = "http://" + window.location.host +
						(top && top.HEURIST && top.HEURIST.basePath? top.HEURIST.basePath : window.location.pathname.match(/^\/[^\/]+\//));
			var database = (top && top.HEURIST && top.HEURIST.database? top.HEURIST.database.name :
								(location.search.match(/db=([^&]+)/) ? location.search.match(/db=([^&]+)/)[1]: ""));

			function init() {
			//initialize parameters
				if (top.HEURIST && top.HEURIST.search) {
				// style
					if (location.search.match(/style=([^&=#]*)/)) {
						var temp = location.search.match(/style=([^&=#]*)/)[1];
						if (top.HEURIST.transforms.nameLookup[temp] || temp == "Generic XML") { //check if there is a template for this style
							curStyle = temp;
							top.HEURIST.util.setDisplayPreference("defaultPrintView",temp);
						}
					}
				//selection
					if (location.search.match(/selectedIds=([0-9,]*)/)){
						selectedIds = location.search.match(/selectedIds=([0-9,]*)/);
						if (selectedIds) {
							selectedIds = selectedIds.split(",");
						}
					}else if (top.HEURIST.search.getSelectedRecIDs().get().length > 0) {
						selectedIds = top.HEURIST.search.getSelectedRecIDs().get();
					}
				//query
					query = location.search.replace(/&?selectedIds=([0-9,]*)/,"");
					query = query.replace(/&?style=[^&=#]*/,"");
					query = query.replace(/\?&/,"?");
					var q = query.match(/q=([^&=#]*)/);
					if (!q && top.HEURIST.parameters['q']){ //no query passed in so build one from HEURIST.params
						query = "?";
						for ( var paramName in top.HEURIST.parameters) {
							if (query.length ==1) {
								query += paramName + "=" + top.HEURIST.parameters[paramName];
							}else{
								query += "&" + paramName + "=" + top.HEURIST.parameters[paramName];
							}
						}
						//set paging parameters to match
						if (top.HEURIST.search.results.totalQueryResultRecordCount) totalRecordCount = top.HEURIST.search.results.totalQueryResultRecordCount;
						if (top.HEURIST.search.resultsPerPage) resultsPerPage = top.HEURIST.search.resultsPerPage;
						pageCount = Math.ceil(totalRecordCount / resultsPerPage);
						if (top.HEURIST.search.currentPage) currentPage = top.HEURIST.search.currentPage;
						offset = (currentPage -1)*resultsPerPage;
						if (query.search("limit")> -1) {
							query = query.replace(/limit=[^#&=]*/,"limit=" + resultsPerPage);
						}else{
							query += "&limit=" + resultsPerPage;
						}
						if (query.search("offset")>-1) {
							query = query.replace(/offset=[^#&=]*/,"offset=" + offset);
						}else{
							query += "&offset=" + offset;
						}
					}

					if (query && query.search("db")== -1){
						query += "&db=" + database;
					}
					if (query && query.search("a=")== -1){
						query += "&a=1";
					}
					if (query && query.search("f=")== -1){
						query += "&f=1";
					}
					if (query && query.search("stub=")== -1){
						query += "&stub=1";
					}
					if (query && query.search("woot=")== -1){
						query += "&woot=1";
					}
				}
			//load xml
				fillStyles(curStyle);

			//set event handlers
				if (top.HEURIST) {
					top.HEURIST.registerEvent(this,"heurist-selectionchange",onSelectionChange);
					top.HEURIST.registerEvent(this,"heurist-selectall",onSelectAll);
					top.HEURIST.registerEvent(this,"heurist-pagechange",onPageChange);
				}
				if(!selectedIds || selectedIds.length == 0){
					clearAndDisplayNoRecordSelected();
				}else{

				}
			}

			var relatedRecListXSL;

			function displayRelatedRecords(recID,parentDiv){
				var showRelatedLink = parentDiv.firstChild;
				if (parentDiv.className.match(new RegExp('(\\s|^)loaded(\\s|$)'))) {
					if (parentDiv.className.match(new RegExp('(\\s|^)show(\\s|$)'))) {
						parentDiv.className = parentDiv.className.replace(" show", "");
						showRelatedLink.innerHTML = "Show related records";
						return;
					} else {
						parentDiv.className += " show";
						showRelatedLink.innerHTML = "Hide related records";
						return;
					};
				};

				if (parentDiv.className == "related-records show" ) {
					parentDiv.className = parentDiv.className.replace(" show", "");
					showRelatedLink.innerHTML = "Show related records";
					return;
				} else {
					showRelatedLink.className += " wait";
					showRelatedLink.innerHTML = "Loading related records";
					parentDiv.className += " show";

					var xmlRecDepth1 = loadXMLDocFromFile(top.HEURIST.baseURL+
										"export/xml/flathml.php?q=ids:"+recID+"&depth=1&woot=1"+
										(top.HEURIST.database.name? "&db=" + top.HEURIST.database.name:""));
					if (!xmlRecDepth1) return;
					if (!relatedRecListXSL) {
						relatedRecListXSL = loadXMLDocFromFile("xsl/relatedRecList.xsl");
					}
					var xhtmlResultDoc;
					if (window.ActiveXObject){
						var xmlResultStr = xmlRecDepth1.transformNode(relatedRecListXSL);
						xhtmlResultDoc=new ActiveXObject("Microsoft.XMLDOM");
						xhtmlResultDoc.async="false";
						xhtmlResultDoc.loadXML(xmlResultStr);
					// code for Mozilla, Firefox, Opera, etc.
					}else {
						var xsltProcessor=new XSLTProcessor();
						xsltProcessor.importStylesheet(relatedRecListXSL);
						xhtmlResultDoc = xsltProcessor.transformToFragment(xmlRecDepth1,document);
					}
					parentDiv.appendChild(xhtmlResultDoc);
					parentDiv.className += " loaded";

					showRelatedLink.className = parentDiv.firstChild.className.replace(" wait", "");
					showRelatedLink.innerHTML = "Hide related records";
					}
				}

			// this function takes the same search but attemps an asynchronous load of the entire result set
			function asyncLoadSearchPages(){
				if (!loadCount || loadCount <=0) return; //nothing to load
				//find next page to load
				loadingPage = null;
				for (var i=1; i <= pageCount; i++){
					if (!pageXMLs[i]) {
						loadingPage = i;
						break;
					}
				}
				if (!loadingPage) { // we are done loading
					loadCount = 0;
					return;
				}
				//set query limits
				aquery = query.replace(/limit=[^#&=]*/,"limit=" + resultsPerPage).replace(/offset=[^#&=]*/,"offset=" + (loadingPage-1)*resultsPerPage);
				var url = hBase + "export/xml/flathml.php"+aquery;
				var errorMsg = "Error loading " + url + " using XMLHttpRequest";
				try {
					aReq = new XMLHttpRequest();
				} catch (trymicrosoft) {
					try {
						aReq = new ActiveXObject("Msxml2.XMLHTTP");
					} catch (othermicrosoft) {
						try {
							aReq = new ActiveXObject("Microsoft.XMLHTTP");
						} catch (failed) {
							aReq = false;
						}
					}
				}
				if (aReq) {
					try{
						aReq.open("GET", url, true);
						aReq.onreadystatechange = updateXMLPages;
						aReq.send("");
					}catch(e){
						alert(errorMsg + " Hint : " + e);
					}
				}else{
					alert("Your browser doesn'tsupport asynch loading. Unable to view complete content.");
				}
			}

			function updateXMLPages(){
				if (aReq.readyState == 4) {
					if (aReq.status == 404) {
						alert("Request for full record results failed - URL not found - likely the server is temporarily out of service");
					} else if (aReq.status != 200) {
						//alert("Error: loading page "+ loadingPage +" status code is " + aReq.status + " please contact the system administrator.");
					}else{
						pageXMLs[loadingPage] = aReq.responseXML;
						if (currentPage == loadingPage){
							displayResultPage(curStyle,curPage);
						}
						loadCount -= 1;
						asyncLoadSearchPages(); // try and load the next page
					}
				}
			}

			function objFromArr(arr)
			{
				var obj = {};
				for(var i=0;i<arr.length;i++)
				{
					obj[arr[i]]="";
				}
				return obj;
			}

			var newSelectionIds, newSelectionMap, alreadySelectedMap;

			function onPageChange(eventType, argList) {// saw TODO change this to update the selection for levels
																// if a level is not loaded then load synch
				if (parent.document.getElementById("p").className == "yui-hidden") {
					return false;
				}
				clearAndDisplayLoading();
				//if page xml not loaded then load sync
				if (eventType == "heurist-pagechange"){
					var page = 0;
					if (argList && argList.match("pageNum")) {
						var page = argList.match("pageNum=(\\d+)")
						page = page[1];
					}else if (top.HEURIST.search.currentPage > 0) {
						page = top.HEURIST.search.currentPage;
					}
					if (page > 0  && page != currentPage && page <= pageCount){
						currentPage = page;
						if (!pageXMLs[page]){ //load pageXML now
							var pageQuery = query;
							pageQuery = pageQuery.replace(/limit=[^#&=]*/,"limit=" + resultsPerPage).replace(/offset=[^#&=]*/,"offset=" + (page-1)*resultsPerPage);
							var url = top.HEURIST.baseURL+ "export/xml/flathml.php" + pageQuery;
							var errorMsg = "Error loading " + url + " using XMLHttpRequest";
							pageXMLs[page] = loadXMLDocFromFile(url);
						}
						xml = pageXMLs[page];
						selectedIds = [];
						displayResultPage(curStyle,page);
					}
				}
			}

			function onSelectAll(eventType, argList) {
				function getNodeContents(elem, nodeName,index) {
					if(!elem) return elem;
					var nodes = elem.getElementsByTagName(nodeName);
					if (!isNaN(index)){
						return nodes[index];
					}
					return elem;
				}
				//if page xml not loaded then load sync
				if (parent.document.getElementById("p").className == "yui-hidden") {
					return false;
				}else if (eventType == "heurist-selectall"){
					var tempXML,recordsNode;
					for (var page = 1; page <= pageCount; page++){
						if (!pageXMLs[page]){ //load pageXML now
							var pageQuery = query;
							pageQuery = pageQuery.replace(/limit=[^#&=]*/,"limit=" + resultsPerPage).replace(/offset=[^#&=]*/,"offset=" + (page-1)*resultsPerPage);
							var url = top.HEURIST.baseURL+ "export/xml/flathml.php" + pageQuery;
							var errorMsg = "Error loading " + url + " using XMLHttpRequest";
							pageXMLs[page] = loadXMLDocFromFile(url);
						}
						if (page == 1){
							tempXML = pageXMLs[page].cloneNode(true); //saw TODO  check if this clones or not
							if(!tempXML){
								tempXML = pageXMLs[page];
							}
							recordsNode = getNodeContents(tempXML,"records",0);
						}else{
							tempXML = pageXMLs[page].cloneNode(true); //saw TODO  check if this clones or not
							if(!tempXML){
								tempXML = pageXMLs[page];
							}
							var recordNodes = getNodeContents(tempXML,"records",0);
							if (!recordsNode) {
								recordsNode = recordNodes;
							}else{
								for (var i =1; i<recordNodes.childNodes.length; i++) {
									recordsNode.appendChild(recordNodes.childNodes[i].cloneNode(true));
								}
							}
						}
					}
					pageXMLs[0] = recordsNode;
					selectedIds = [];
					displayResultPage(curStyle,0);
				}
			}

			var FlatHMLQuery = {'filter':"",'query':"",'maxDepth':0,'selectIDs':""};
			function onSelectionChange(eventType, argList) {
				if (parent.document.getElementById("p").className == "yui-hidden") { //if tab not current ignore event
					return false;
				}else if (eventType == "heurist-selectionchange"){	// saw TODO change this to update the selection for levels
																// if a level is not loaded then load synch
					var layoutString = top.HEURIST.search.getLayoutString();
					var selFilter = top.HEURIST.search.getSelectedString();
					var rtFilter = top.HEURIST.search.getPushDownFilter("rectype");
					var rleFilter = top.HEURIST.search.getPushDownFilter("reltype");
					var ptrFilter = top.HEURIST.search.getPushDownFilter("ptrtype");
					var filter = "" + (rtFilter.length > 0 &&  rtFilter[1] != "" ? "&" + rtFilter[1] : "")
									+ (rleFilter.length > 0 &&  rleFilter[1] != "" ? "&" + rleFilter[1] : "")
									+ (ptrFilter.length > 0 &&  ptrFilter[1] != "" ? "&" + ptrFilter[1] : "");
/*					newSelectionIds = [];
					if (top.HEURIST.search.getLevelSelectedRecIDs("0").get().length > 0) {
						newSelectionIds = top.HEURIST.search.getLevelSelectedRecIDs("0").get();
					}else if (argList && argList.match("selectedIds")) {
						var ids = argList.match("selectedIds=(\\d+(?:,\\d+)*)");
						if (ids && ids[1]) newSelectionIds = ids[1].split(",");
					}*/
					var maxDepth = Math.max(layoutString[0],0);
					var newSelectionIDs = top.HEURIST.search.getSelectedRecIDs();
					newSelectionIDs = newSelectionIDs.toArray().join();
					if (FlatHMLQuery.filter != filter || FlatHMLQuery.maxDepth < maxDepth ||FlatHMLQuery.query != top.HEURIST.parameters['q']) {
						var pageQuery = "?w=all&a=1&depth="+ maxDepth +
											"&q=" +(top.HEURIST.parameters['q']&& top.HEURIST.parameters['q'].length >0 ? top.HEURIST.parameters['q'] :"")+
											(filter.length > 0 ? filter : "") +
											(layoutString.length > 0 &&  layoutString[1] != "" ? "&" + layoutString[1] : "") +
											(selFilter.length > 0 &&  selFilter[1] != "" ? "&" + selFilter[1] : "") +
											($("#expandColl:checked").length > 0 ? "&expandColl=1" : "") +
											(top.HEURIST.database.name? "&db=" + top.HEURIST.database.name:"");
						curQueryURL = top.HEURIST.baseURL+ "export/xml/flathml.php" + pageQuery;
						var errorMsg = "Error loading " + curQueryURL + " using XMLHttpRequest";
						clearAndDisplayLoading();
						xml = loadXMLDocFromFile(curQueryURL);
						FlatHMLQuery.filter = filter;
						if (FlatHMLQuery.maxDepth < maxDepth) {
							FlatHMLQuery.maxDepth = maxDepth;
						}
						FlatHMLQuery.query = top.HEURIST.parameters['q'];
					}else if(FlatHMLQuery.selectIDs != newSelectionIDs){
						//replace xml selids node with new ids.
						xml.getElementsByTagName("selectedIDs").item(0).firstChild.nodeValue = newSelectionIDs;
						var selIds = newSelectionIDs.split();
						$("record[selected='yes']",$(xml)).attr("selected","no");
						$("record[selected='no']",$(xml)).each(function(i,rec){
																var recID = $(rec).children("id").text();
																if(selIds.indexOf(recID) > -1) $(rec).attr("selected","yes");
															})
					}
					FlatHMLQuery.selectIDs = newSelectionIDs;
					selectedIds = newSelectionIDs;
					displayResultDoc(curStyle,xml);
/*
					var selDivs = $('div[class~=selected]');
					if (selDivs) selDivs.map(function(a){ return this.id;}).map(function(i){
																						if (newSelectionMap[this]) {
																							alreadySelectedMap[this] = "";
																						}else{
																							$('div#'+ this).removeClass("selected");
																						}
																					});
					$(newSelectionIds).map(function(i){
													if (!alreadySelectedMap[this]){
														$('div#'+ this).addClass("selected");
													}
												});
					if (selectedIds && selectedIds.length > 0 &&
							$('div#'+selectedIds[selectedIds.length-1],
								$('iframe[id=viewer-frame]',top.document).get(0).contentDocument).length > 0) {
						$('div#'+selectedIds[selectedIds.length-1],$('iframe[id=viewer-frame]',top.document).get(0).contentDocument).get(0).scrollIntoView();
					}
*/
				}
			}

			function updateSelection(){//Mark any record divs id in selected as class selected (visible)
				if(selectedIds && selectedIds.length>0) {
					for (var i = 0; i < selectedIds.length; i++) {
						$('div[class~=record]').filter('div[id='+ selectedIds[i] +']').addClass("selected");
					}
				}
			}

			function clearAndDisplayLoading(){
				var resultDiv =document.getElementById("displayResult");
				while (resultDiv.childNodes[0]) resultDiv.removeChild(resultDiv.childNodes[0]);
				var loadingDiv = document.createElement("div");
					loadingDiv.id = "loading";
				resultDiv.appendChild(loadingDiv);
			}

			function clearAndDisplayNoRecordSelected(){
				var resultDiv =document.getElementById("displayResult");
				while (resultDiv.childNodes[0]) resultDiv.removeChild(resultDiv.childNodes[0]);
				var noSelectedDiv = document.createElement("div");
					noSelectedDiv.id = "errorMsg";
					noSelectedDiv.innerHTML = "<div style='height:50%'></div><span>No Records Selected from Search Results</span>";
				resultDiv.appendChild(noSelectedDiv);
			}

			function changeTransform(transformID){
				if (transformID == 0) {
					curStyle = "Generic XML";
				}else if (top.HEURIST.transforms.byID[transformID]) {
					curStyle = top.HEURIST.transforms.byID[transformID].label;
				}else{
					curStyle = "default";
				}
				top.HEURIST.util.setDisplayPreference("defaultPrintView",curStyle);
				displayResultDoc(curStyle,xml);
			}

			function displayResultDoc(style,xmlDoc){
				var resultDiv =document.getElementById("displayResult");
				var xhtmlResultDoc = "";
				function clearResult(resultDiv) {
					while (resultDiv.childNodes[0]) resultDiv.removeChild(resultDiv.childNodes[0]);
				}

				if (style == "Generic XML") {
					var genXML = $("<xml>").append(xmlDoc.documentElement).html();
					xhtmlResultDoc = document.createTextNode(genXML);
				}else{
					if (!xsls[style]){
						if (top.HEURIST.transforms.nameLookup[style]){
							var transID = top.HEURIST.transforms.nameLookup[style];
							var uri = top.HEURIST.transforms.byID[transID].uri;
							xsls[style]=loadXMLDocFromFile(top.HEURIST.baseURL + "viewers/printview/loadXSLTemplate.php?style=" + uri);
						}else{
							xsls[style]=loadXMLDocFromFile(top.HEURIST.baseURL + "viewers/printview/loadXSLTemplate.php?style=" + style);
						}
					}
					if (!xsls[style]) {
						alert("Unable to read '"+ style +"' file, check to see if this style sheet is readable in your browser or another browser.");
						return;
					}
					// code for IE
					if (window.ActiveXObject){// saw TODO change this transform a combined document for related results
						var xmlResultStr = xmlDoc.transformNode(xsls[style]);
						xhtmlResultDoc=new ActiveXObject("Microsoft.XMLDOM");
						xhtmlResultDoc.async="false";
						xhtmlResultDoc.loadXML(xmlResultStr);
					// code for Mozilla, Firefox, Opera, etc.
					}else {
						var xsltProcessor=new XSLTProcessor();// saw TODO change this transform a combined document for related results
						xsltProcessor.importStylesheet(xsls[style]);
						xhtmlResultDoc = xsltProcessor.transformToFragment(xmlDoc,document);
					}
				}
				clearResult(resultDiv);
				createTools(style);
				resultDiv.appendChild(xhtmlResultDoc);
				updateSelection();
			}

			function displayResultPage(style,page){
				var resultDiv =document.getElementById("displayResult");
				var xhtmlResultDoc = "";
				function clearResult(resultDiv) {
					while (resultDiv.childNodes[0]) resultDiv.removeChild(resultDiv.childNodes[0]);
				}

				if (style == "Generic XML") {
					xhtmlResultDoc = pageXMLs[page].documentElement;
				}else{
					if (!xsls[style]){
						xsls[style]=loadXMLDocFromFile(styles[style][2]);
					}
					if (!xsls[style]) {
						alert("Unable to read .xsl file, check to see if this style sheet is readable in your browser or another browser.");
						return;
					}
					// code for IE
					if (window.ActiveXObject){// saw TODO change this transform a combined document for related results
						var xmlResultStr = pageXMLs[page].transformNode(xsls[style]);
						xhtmlResultDoc=new ActiveXObject("Microsoft.XMLDOM");
						xhtmlResultDoc.async="false";
						xhtmlResultDoc.loadXML(xmlResultStr);
					// code for Mozilla, Firefox, Opera, etc.
					}else {
						var xsltProcessor=new XSLTProcessor();// saw TODO change this transform a combined document for related results
						xsltProcessor.importStylesheet(xsls[style]);
						xhtmlResultDoc = xsltProcessor.transformToFragment(pageXMLs[page],document);
					}
				}
				clearResult(resultDiv);
				resultDiv.appendChild(xhtmlResultDoc);
				updateSelection();
			}

			//scroll viewer back to top
			function backToTop(){
				var resultDiv =document.getElementById("displayResult");
				resultDiv.scrollTop = 0;
			}

			var annoSymbology = {}; //default is to add "comment" annotations  with lightBlue highlight

			function createTools(style){
				var buttonBar = $("#buttonBar");
				// remove all buttons
				buttonBar.html("");
				annoSymbology = {};
				//check if this style is a transform
				if (top.HEURIST.transforms.nameLookup[style]) {
					var transID = top.HEURIST.transforms.nameLookup[style];
					//check if there are tools for this transform
					if (top.HEURIST.tools.byTransform[transID]){
						var toolIDs = top.HEURIST.tools.byTransform[transID];
						//for each tool add button to bar and if annotation tool then add symbology
						for (var i in toolIDs) {
							var tool = top.HEURIST.tools.byId[toolIDs[i]];
							// if tool is for annotations then capture the symbology
							if (top.HEURIST.magicNumbers['RT_ANNOTATION'] &&
								tool.rt == top.HEURIST.rectypes.typedefs[top.HEURIST.magicNumbers['RT_ANNOTATION']].commonFields[top.HEURIST.rectypes.typedefs.commonNamesToIndex['rty_ConceptID']]){
								annoSymbology[tool.value] = tool.colour;
								//todo : set icon or superscript or subscript
							}
							var a = document.createElement("a");
							a.href = tool.command;
							var divTool = document.createElement("div");
							a.appendChild(divTool);
							divTool.className = "annotationLink"; //inherit standard stuff
							divTool.title = tool.name;
							if (tool.colour) {
								divTool.style.backgroundColor = tool.colour;
							}
							if (tool.img) {
								divTool.style.backgroundImage = "url('" + tool.img + "')";
							}
							buttonBar.append(a);
						}
					}
				}
				//set annoSymbology
				setAnnoSymbology(annoSymbology);
			}

			// read transform structure for buttons bar commands
			//
			function addAnnotation(annoType){
				if (!annoType) {
					annoType = 'Comment';
				}
				var contentDivs = $(".annotatedDocument div.content").get();
				if (!contentDivs[0]){
					alert("No content container element was found. Please use format that allows annotation. Try TeiView. ");
					return;
				}
				var annoStruct = window.findSelectionAddressInDocs(contentDivs);
				if (!annoStruct || !annoStruct.addr) {
					alert("No selection was found. Please make a selection and then press Annotation Button.");
					return;
				}
				var recTitle = $(annoStruct.docElem).attr("recTitle");
				var recID = $(annoStruct.docElem).attr("recID");
				/*
				confirm(" Would you like to add an annotation to '" +recTitle+ "' as follows:\n " +
							"Start  Elem:" + annoStruct.addr.startElems.join(":") +
							" Word:" + annoStruct.addr.startWord + "\n" +
							"End  Elem:" + annoStruct.addr.endElems.join(":") +
							" Word:" + annoStruct.addr.endWord)+ " ?"; */
				var title = "Add new record "+top.HEURIST.util.getRectypeIconAndName(top.HEURIST.magicNumbers['RT_ANNOTATION']);

				top.HEURIST.util.popupURL(window, top.HEURIST.basePath +'records/add/formAddRecordPopup.html?rectype='+
							top.HEURIST.magicNumbers['RT_ANNOTATION']+
										'&addr='+annoStruct.addr.startElems.join(",") +":"+
												annoStruct.addr.startWord +":"+
												annoStruct.addr.endElems.join(",") +":"+
												annoStruct.addr.endWord +
										(recID ? '&trgRecID='+recID : "") +	//TODO SAW : need to change this to conform to new annotation style
										(annoStruct.addr.text != ""  ? '&text='+ annoStruct.addr.text : "") +
										(recTitle ? '&trgRecTitle='+recTitle : "") +
										(annoType ? '&type='+annoType : "") +
										'&db='+ (window.HEURIST && window.HEURIST.parameters && window.HEURIST.parameters.db ? window.HEURIST.parameters.db :
														(top.HEURIST.parameters.db?top.HEURIST.parameters.db:
															(top.HEURIST.database.name? top.HEURIST.database.name:''))),
									{	title: title,
										callback: function(title, bd, bibID) {
													if (bibID) {
														//save scroll location
														//reload Document
														xml = loadXMLDocFromFile(curQueryURL);
														displayResultDoc(curStyle,xml);
														//setScroll location
													} else {
														alert("annotation didn't save please try again");
													}
												}
									});

			}
			function editAnnotation(annoID){
				if (!annoID) {
					return;
				}
				top.HEURIST.util.popupURL(window, top.HEURIST.basePath +'records/edit/formEditRecordPopup.html?recID='+annoID ,
									{	width: 800,
										height: 600,
										callback: function(title, bd) {
													if (bd) {
														//save scroll location
														//reload Document
														xml = loadXMLDocFromFile(curQueryURL);
														displayResultDoc(curStyle,xml);
														//setScroll location
													} else {
														alert("annotation didn't save please try again");
													}
												}
									});

			}
		</script>

	</head>
	<body onLoad="init()">

		<div class="banner">
			<select id="transform_select" style="width: 180px;" onChange="changeTransform(this.options[this.selectedIndex].value);">
			</select>
			<a href="javascript:window.print()"><div id="printingLink"></div></a>
			<div id="buttonBar">
			</div>
			<input type="checkbox" id="expandColl" />
			<label for="expandColl">Expand Collections</label>
			<a href="javascript:window.backToTop()" style="float: right;">to top</a>
		</div>
		<div id="displayResult" ></div>
	</body>
</html>
