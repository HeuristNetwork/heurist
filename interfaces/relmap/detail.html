<html>
 <head>
  <title>Edit Record</title>

<script src="../heurist/php/js/load-hapi.php"></script>

  <script>
  var path ="http://heuristscholar.org/heurist/";
  var rec_id = getHeuristId();

  isEmpty = function (object){
   for (var o in object){ return false;}
   return true;
  }

  function getHeuristId (){
  var regexS = "[\\?&]id=([^&#]*)";
  var regex = new RegExp( regexS );
  var results = regex.exec( window.location.search );
  if( results == null )
    return;
  else
    return results[1];
  }


function init(){
var spanTitle = document.getElementById("edit-title");
spanTitle.innerHTML = "<h3>Edit Record</h3>";

spanTitle.innerHTML += "<input type=\"radio\" id=\"formradio\" name=\"formsearch\" checked=\"true\" onclick=\"selectForm();\"></input>Form &nbsp; &nbsp";
spanTitle.innerHTML += "<input type=\"radio\" id=\"searchradio\" name=\"formsearch\" onclick=\"selectSearch();\"></input>Add relationships";

doRecSearch(rec_id, 'primary');


}

	function doRecSearch(id, option, detId, extra, constn) { //surely there must be a more elegant way of recycling the bugger
	var mysearch = new HSearch("ids:" + id);

		var loader = new HLoader(
			function(s,r) {
			//case loading?
			   switch (option){

			    case "primary":
				displayPrimaryResults(r[0]);
				break;

				case "resource":
				if (r[0]){
				 drawResourceDetails(r[0], detId, extra, constn);
				 }
				break;

			   }

			},
			function(s,e) {
				alert("load failed: " + e);
			});
		HeuristScholarDB.loadRecords(mysearch, loader);
	}



	function displayPrimaryResults(r) {
		var div = document.getElementById("results");
		var dets = document.getElementById("details");
		div.innerHTML = "";

		    var recImage = r.getRecordType().getID();
			var recTitle = r.getRecordType().getName();
			var refId = r.getID();
			var refTitle =r.getTitle();



			div.innerHTML += "<span class=rec><img src='"+ path +"img/reftype/"+recImage+".gif' align=absmiddle> "+recTitle +"</span><span class=rec-title>"+refTitle+"</span>";

			dets.innerHTML += "<table class=detail>";
	        var refDets =HDetailManager.getDetailTypesForRecordType(r.getRecordType()); //get all detail types for this record type

		     for (var i = 0; i < refDets.length; i++) {  //two loops, need to fully load "skin" before details, otherwise overwrites

		       var bb =drawInputForm(refDets[i], r);
			    if (bb) dets.innerHTML += bb;
			  }

			 for (var b = 0; b < refDets.length; b++) {
			  //console.log("DRAWING"+refDets[b].getID());
			   drawInputFormDetails(refDets[b].getID(), r.getID());
			 }
			dets.innerHTML += "</table>";
			drawRepeats();
			var button = document.getElementById("tab-edit").appendChild(document.createElement("input"));
			button.type = "button";
			button.value = "save record";
			button.onclick = function() { editRecord(r); };//editRecords(r.getRecordType()); };

	}


function drawInputForm(z,record){

var detailId =z.getID();
var recType = record.getRecordType(); //HRecordType object
var detailType =  HDetailManager.getDetailTypeById(detailId); // HDetailType object

var detName =  HDetailManager.getDetailNameForRecordType(recType, detailType);
var detPrompt = HDetailManager.getDetailPromptForRecordType (recType, detailType);
var detRequiremence = HDetailManager.getDetailRequiremence(recType, detailType);
var isRepeatable = HDetailManager.getDetailRepeatable(recType, detailType);

//var Url = record.getURL();
//console.log(Url);

var reqText = "";
var reqClass = "";

switch (detRequiremence){
 case "Y":
 reqText = "Required";
 reqClass = "required";
 break;

 case "R":
 reqText = "Recommended";
 reqClass = "recommended";
 break;

 case "O":
 reqText = "Optional";
 reqClass = "optional";
 break;

 default:
 reqText = "Optional";
 reqClass = "optional";
 break;

}


//build template
var html = "";
html += "<tr>";
html += "<td id=sub-res-type class=\""+reqClass+"\">"+detName+"</td>";
if (isRepeatable)
 html += "<td class=\"rep\"><img id= \"img"+detailId +"\" src=\""+path+"/img/duplicate.gif\" border=0></td>";
else
 html += "<td class=\"rep\"></td>";
html += "<td class=\""+reqClass+"\"><div class=pad id=sel"+detailId+"></div><div class=hint>"+detPrompt+"</div></td>";
html += "<td class=\""+reqClass+"\"><div id=lookup"+detailId+"></div></td>";
html += "</tr>";


return html;

}


function drawInputFormDetails(detailId,rid){

var record = HeuristScholarDB.getRecord(rid);
var recType = record.getRecordType(); //HRecordType object
var detailType =  HDetailManager.getDetailTypeById(detailId); // HDetailType object
var detVariety = detailType.getVariety();
var detail = record.getDetails(detailType);

switch (detVariety){
 case 'literal':
  if (detailId == 191 || detailId == 303)
   drawTextArea (detailId, detail);
  else
  drawInputField(detailId, detail);
 break;

 case 'reference': //ATTENTION: not an efficient way of outputing resource pointers! FIXME!
 var constRecType;
  if (detailType.getConstrainedRecordType()) constRecType = detailType.getConstrainedRecordType().getID();
  drawResource(detailId, detail, constRecType);
 break;

 case 'file':
 drawFile(detailId, detail);
 break;

 case 'enumeration':
 drawEnums(detailId, detail);
 break;

 case 'geographic': //TODO: proper GEO rendering
 drawRest(detailId, detail);
 break;

 case 'boolean':
 drawBool(detailId, detail);
 break;

 case 'date': //TODO: add calendar
 drawInputField(detailId, detail);
 break;

 default:
drawRest(detailId, detail);
 break;
}

}


function drawFile(id, detail){
 var sel = document.getElementById("sel"+id);
 var html ="";

 if (!isEmpty(detail)){ //files
  for (i in detail){
   var thumb = detail[i].getThumbnailURL();
   var url = detail[i].getURL();
   var filename = detail[i].getOriginalName();
   var size = detail[i].getSize();
  html += "<div class=\"inp-div\"><input type=hidden name=\""+id+"\" id=\""+id+"\" value=file extra=\""+detail[i].getID()+"\"><img src = \""+thumb+"\"><img src=\""+path+"/img/cross.gif\" onclick=\"remFile("+id+","+detail[i].getID()+");\"><br><a href=\""+url+"\">"+filename+"</a></div>";
  }
 }else{ //upload box
  html += "<div class=\"inp-div\"><input type=file  name=\""+id+"\" id=\""+id+"\" value=\"\" extra=\"\" onchange=\"uploadFile("+id+");\"></div>";
 }
  sel.innerHTML += html;
}

function drawInputField(id, detail){
  var sel = document.getElementById("sel"+id);
  var html ="";
    if (!isEmpty(detail)){
      for (i in detail){
        html += "<div class=\"inp-div\"><input type=text  name=\""+id+"\" id=\""+id+"\" value=\""+detail[i]+"\"></div>";
      }
    }else{
      html += "<div class=\"inp-div\"><input type=text  name=\""+id+"\" id=\""+id+"\" value=\"\"></div>";
    }
  sel.innerHTML += html;
}

function drawResource(id, detail, constRecType){

var sel = document.getElementById("sel"+id);
var  html = "";

if (!isEmpty(detail)){
  html = ""; //reset
  var count=0;
  for (z in detail){
   count ++;
   html +=  "<div class=\"inp-div\"><input class=\"resource\" mode=resource type=text recid=\"\" extra="+count+" id=\""+id+"\" name=\""+id+"\" value=\"\" ><img src=\""+path+"/img/cross.gif\" onclick=\"remResource("+id+","+count+");\"></div>";
   doRecSearch(detail[z].getID(), "resource", id, count, constRecType);
  }
  sel.innerHTML += html;
 }else{

 html += "<div class=\"inp-div\"><input class=\"resource\" mode=resource type=text  extra=1 name=\""+id+"\" id=\""+id+"\" value=\"\" onclick=\"window.open('searchRes.html?id="+id+"&t="+constRecType+"&ext=1&q=', 'mywin','width=700, height=400, scrollbars=yes,resizable=yes'); \" onchange=\"onchangeResource("+id+",1);\"><img src=\""+path+"/img/cross.gif\" onclick=\"remResource("+id+",1);\"></div>";
 sel.innerHTML += html;
 //drawResourceDetails(null, id, 1, constRecType); // FAILS MISERABLY> WHY??? this would have been a tidier way of doing it.
 }
}

function remResource(id, extra){
 var allInputs = document.getElementsByName(id);
 var size = allInputs.length;
  for (i=0; i<allInputs.length; i++){
   if (allInputs[i].getAttribute("extra") == extra){
    var div = allInputs[i].parentNode;
	if (size > 1 && extra > 1){
	div.innerHTML="";
	}else{ //if its an only field in the series, remove value and recid attributes only
	 allInputs[i].value = "";
	 if (allInputs[i].getAttribute("recid") != "") {
	 allInputs[i].removeAttribute("recid");
	 }
	}
   }
 }
}
function onchangeResource(id, extra){
var elts = document.getElementsByName(id);
      for (l = 0;  l<elts.length; l++ ){
      if (elts[l].getAttribute("extra") == extra){
        doRecSearch(elts[l].getAttribute("recid"), "resource", id);
      }
     }
}
function drawResourceDetails(record, id, extra, constRecType){

var recTitle="";
var recid = "";
 if (record != null) {
 recTitle = record.getTitle(); //HRecordType object
 recid = record.getID();
 }
 var allInputs = document.getElementsByName(id);

 for (i=0; i<allInputs.length; i++){
   if (allInputs[i].getAttribute("extra") == extra){
   console.log("are we here?"+id);
    allInputs[i].value = recTitle;
	allInputs[i].readOnly = true;
	allInputs[i].setAttribute("class", "resource");
	allInputs[i].setAttribute("mode", "resource");
	allInputs[i].setAttribute("recid", recid);
	allInputs[i].onclick = function (){  window.open('searchRes.html?id='+id+'&t='+constRecType+'&ext='+extra+'&q='+recTitle+'', 'mywin','width=700, height=400'); };
	allInputs[i].onchange = function() {
	 var elts = document.getElementsByName(id);
      for (l = 0;  l<elts.length; l++ ){
      if (elts[l].getAttribute("extra") == extra){
        doRecSearch(elts[l].getAttribute("recid"), "resource", id);
      }
     }
	}
   }
 }

}


function drawTextArea(id, detail){
var sel = document.getElementById("sel"+id);
  var html ="";
    if (!isEmpty(detail)){
      for (i in detail){
        html += "<div class=\"inp-div\"><textarea name=\""+id+"\" id=\""+id+"\">"+detail[i]+"</textarea></div>";
      }
    }else{
      html += "<div class=\"inp-div\"><textarea name=\""+id+"\" id=\""+id+"\"></textarea></div>";
    }
  sel.innerHTML += html;
}

function drawRest(id, text){

var html = "<input disabled type=text value=\""+text+"\" name=\""+id+"\" id=\""+id+"\">";
var sel = document.getElementById("sel"+id);
sel.innerHTML = html;

}



function drawEnums(id, detail){
  var enums =[];
  enums = HDetailManager.getDetailTypeById(id).getEnumerationValues();
  var sel = document.getElementById("sel"+id);

if (!isEmpty(detail)){
for (d in detail){
 var recSelect = document.createElement("select");
 recSelect.id = id;
 recSelect.name = id;
 recSelect.setAttribute("mode", "enum");
 var opt = document.createElement("option");
		opt.disabled = false;
		recSelect.appendChild(opt);

		for (var i in enums) {
		    opt = document.createElement("option");
			opt.value = enums[i];
			opt.innerHTML = enums[i];
			if (detail[d] == enums[i]){
			 opt.defaultSelected = true;
			}
			recSelect.appendChild(opt);
		}

  sel.appendChild(recSelect);
 }
}else{
var recSelect = document.createElement("select");
 recSelect.id = id;
 recSelect.name = id;
 recSelect.setAttribute("mode", "enum");
 var opt = document.createElement("option");
		opt.disabled = false;
		recSelect.appendChild(opt);

		for (var i in enums) {
		    opt = document.createElement("option");
			opt.value = enums[i];
			opt.innerHTML = enums[i];
			if (detail == enums[i]){
			 opt.defaultSelected = true;
			}
			recSelect.appendChild(opt);
		}

  sel.appendChild(recSelect);
 }
}

function drawBool(id, detail){
var sel = document.getElementById("sel"+id);
var vals = new Array("true", "false");
if (!isEmpty(detail)){
for (d in detail){
var recSelect = document.createElement("select");
recSelect.setAttribute("mode", "boolean");
recSelect.id = id;
recSelect.name = id;
var opt = document.createElement("option");
		opt.disabled = false;
		recSelect.appendChild(opt);

		for (var i in vals) {
		    opt = document.createElement("option");
			var optText ="";
			if (vals[i] == "true") optText = "yes";
			if (vals[i] == "false") optText = "no";
			opt.value = vals[i];
			opt.innerHTML = optText;
			if (detail[d] == vals[i]){
			 opt.defaultSelected = true;
			}
			recSelect.appendChild(opt);
		}
    sel.appendChild(recSelect);
  }
 }else{
 var recSelect = document.createElement("select");
 recSelect.id = id;
 recSelect.name = id;
 recSelect.setAttribute("mode", "boolean");
 var opt = document.createElement("option");
		opt.disabled = false;
		recSelect.appendChild(opt);

		for (var i in vals) {
		    opt = document.createElement("option");
			var optText ="";
			if (vals[i] == "true") optText = "yes";
			if (vals[i] == "false") optText = "no";
			opt.value = vals[i];
			opt.innerHTML = optText;
			recSelect.appendChild(opt);
		}
    sel.appendChild(recSelect);
 }
}



function createRecords(recType) {
		var hrecord = new HRecord();
		hrecord.setRecordType(recType);
		var details = document.getElementsByTagName("input");  //NOT FULLY WORKING, WHAT ABOUT TEXTAREA??
		for (i in details){
		 if (details[i].type == "text" && details[i].value){
		  var detailType = HDetailManager.getDetailTypeById(details[i].id);
		  hrecord.addDetail(detailType, details[i].value);
		 }
		}

       var saver = new HSaver(
			function(r) {
			//document.getElementById("records-div").innerHTML = "<b>" + r.length + "</b> records saved";
			console.log(r);
			},
			function(r,e) {
			console.log("record save failed: " + e);
			});
		HeuristScholarDB.saveRecord(hrecord, saver); ///PAY ATTENTION @@@@@@@@@@@@@@@@@@@@@@@@@@@
}

function checkRequired(record){
var recordType = record.getRecordType();
var reqDetails = HDetailManager.getRequiredDetailTypesForRecordType(recordType);
var errors = "";
for (r in reqDetails){
         var field = document.getElementById(reqDetails[r].getID());
         if (reqDetails[r].getID() == field.id){
		  if (!field.value || field.value ==""){
		    errors += "Please provide a value for "+ reqDetails[r].getName() +" field\n";
		  }
		 }
		}
 if (errors !="" ) {
  alert(errors);
  return false;
 }else{
  return true;
 }
}


function createOnclickEvent (id, replink){ //test Repeatable textareas and dropdowns // REWRITE THIS TO USE ORIGINAL LOADING FUNCTIONS!!
     var fields = document.getElementsByName(id);//build a new field based on current attributes

	 var thisfield = fields[fields.length-1];

	 replink.onclick = function () {
	 if (thisfield.getAttribute("extra"))
	  var extra = parseInt(thisfield.getAttribute("extra"))+1;
	 else
	  var extra = 1;

	 var type = thisfield.type;
	 var constRecType ="";
	 if (HDetailManager.getDetailTypeById(id).getConstrainedRecordType())constRecType = HDetailManager.getDetailTypeById(id).getConstrainedRecordType().getID();
	 var q = "";
	 var newField;
	  switch (type){
	   case "text":
	    newField = document.createElement("input");
		newField.type = type;

		var div = thisfield.parentNode;
		var divClass = div.getAttribute("class");
		var newdiv =document.createElement("div");
		newdiv.setAttribute("class", divClass);
		newField.setAttribute("extra", extra);
	    newField.id = id;
	    newField.name = id;
		newdiv.appendChild(newField);

		if (thisfield.getAttribute("mode")== "resource"){ //resource pointers
		 var im = document.createElement("img");
	     im.src = path+"/img/cross.gif";
	     im.onclick = function () { remResource(id,extra); }
		 newdiv.appendChild(im);
		 div.parentNode.appendChild(newdiv);
		 drawResourceDetails(null, id, extra, constRecType);
		}else{
		 div.parentNode.appendChild(newdiv);
		}
	   break;

	   case "file":
	    drawFile(id, "");
	   break;

	   case "hidden": //for files and geo objects
        drawFile(id, "");
	   break;

	   case "select-one": //dropdowns
	    if (thisfield.getAttribute("mode")=="boolean")
        drawBool(id, "");
		if (thisfield.getAttribute("mode")=="enum")
		drawEnums(id, "");
	   break;

	   case "textarea":
	   drawTextArea(id, "");
	   break;

	   default:
	   newField = document.createElement(type);
	   break;
	  }
	 // if (type=="text") type = "input";
	  console.log("Type"+ type);



	};
}

function drawRepeats(){

var replinks = document.getElementsByTagName("img");
 for (i=0; i<replinks.length; i++){
  if (replinks[i].id.toString().match("img")){
  var replink = replinks[i].id.toString().split("img");
  createOnclickEvent(replink[1], replinks[i]);

  }
 }
}

function uploadFile(id){
var files = document.getElementsByName(id);
for (f in files){
 if (files[f].type == "file") var file = files[f];
}
var fileCallback = function(fInput, hFile) {
		var record = HeuristScholarDB.getRecord(rec_id);
		record.addDetail(HDetailManager.getDetailTypeById(id), hFile);
		HeuristScholarDB.saveRecord(record, new HSaver(recordCallback, fileUploadErrorCallback));
	};
 var recordCallback = function(record) {
		var detail = record.getDetails(HDetailManager.getDetailTypeById(id));
		document.getElementById("sel"+id).innerHTML= "";
		drawFile(id, detail);
	};

	var fileUploadErrorCallback = function(record, error) {
		console.log(error);
	};
	HeuristScholarDB.saveFile(file, new HSaver(fileCallback, fileUploadErrorCallback));

}

function remFile(id, fid){
	var record = HeuristScholarDB.getRecord(rec_id);
	var details = record.getDetails(HDetailManager.getDetailTypeById(id));
	record.removeDetails(HDetailManager.getDetailTypeById(id));
	for (d in details){
	 if (details[d].getID() != fid){
	  record.addDetail(HDetailManager.getDetailTypeById(id), details[d]);
	 }
	}
	remResource(id, fid);
}

function editRecord(record) {
        var checked = checkRequired(record);
		if (!checked) return;

		var details = [];
		var recordType = record.getRecordType();

		var detTypes = HDetailManager.getDetailTypesForRecordType(record.getRecordType());
		 for (d in detTypes){
		  var detailVariety = detTypes[d].getVariety();

		  var fields = document.getElementsByName(detTypes[d].getID());
		  if (fields.length === 0) continue;

		  for (f=0; f<fields.length; f++){
		    if (fields[f].type != "hidden"){ //files and geo objects????
		     if (fields[f].value || fields[f].value=="")
			 record.removeDetails(detTypes[d]);
		    }
		   }

		   for (f=0; f<fields.length; f++){
			if (fields[f].value){
			console.log("here "+fields[f].value);
		     switch(detailVariety){

			  case "literal":
		      record.addDetail(detTypes[d], fields[f].value);
		      break;

			  case "boolean":
			  if (fields[f].value == "false"){
			   record.addDetail(detTypes[d], 0);
			   }else{
		       record.addDetail(detTypes[d], 1);
			   }
		      break;
		      case "enumeration":
			  var enums = detTypes[d].getEnumerationValues();
		      for (n in enums){
		       if (fields[f].value == enums[n])
		       record.addDetail(detTypes[d], fields[f].value);
		      }
			  break;

		      case "reference":
		      console.log("DB"+HeuristScholarDB.getRecord(fields[f].getAttribute("recid")));
		      record.addDetail(detTypes[d], HeuristScholarDB.getRecord(fields[f].getAttribute("recid")));
		      break;

			  case "date":
			  var theDate= fields[f].value.replace(/-/g, ",");
			  record.addDetail(detTypes[d], new Date(theDate)); //yyyy, mm, dd
		      break;
		      }
		     }
			}

		 }



       var saver = new HSaver(
			function(r) {
			alert ("Saved");
			//window.location = "search.html";
			window.close();
			},
			function(r,e) {
			alert("record save failed: " + e);
			});
		HeuristScholarDB.saveRecord(record, saver); ///PAY ATTENTION @@@@@@@@@@@@@@@@@@@@@@@@@@@
}

// added by nan. used for adding relationship

//This function is used to hide form and show search
function selectSearch(){
    document.getElementById("formdiv").style.display='none';
	document.getElementById("searchdiv").style.display='';
	document.getElementById("divresult").style.display='';
	document.getElementById("existingdiv").style.display='';
	document.getElementById("existingdiv").innerHTML="";
	document.getElementById("divresult").innerHTML="";
	var div=document.getElementById("searchdiv");
	div.innerHTML = "";
    div.innerHTML = "</br><input type=\"text\" id=\"search-string\"></input>";
	div.innerHTML += "<input type=\"button\" value=\"search\" onclick=\"doRelatedSearch();\"></input> &nbsp;&nbsp;&nbsp;";
	div.innerHTML += "<input type=\"checkbox\" id=\"ExistingCheck\" onclick=\"loadFirstRecord();\"></input>Show existing relationships";
}

//This function is used to hide search and show form
function selectForm(){
    document.getElementById("searchdiv").style.display='none';
	document.getElementById("divresult").style.display='none';
	document.getElementById("existingdiv").style.display='none';
	document.getElementById("formdiv").style.display='';

}
function strcmp(a,b) { var x = a.getTitle(), y = b.getTitle(); return (x < y)? -1 : (x > y)? 1 : 0; }
//this function is used to show all the existing relationships if the check box is checked

var chosenRecord;
//The relationships records must be loaded before they can be returned
function loadFirstRecord(){
    chosenRecord = HeuristScholarDB.getRecord(rec_id);
	//if (! chosenRecord.relatedLoaded) {
         HeuristScholarDB.loadRecords(new HSearch("relationsfor:"+chosenRecord.getID()),
		                              new HLoader(showExistingRelationships));
		// chosenRecord.relatedLoaded = true;
	//}
	/*
	else {
		showExistingRelationships();
	}
	*/


}
function showExistingRelationships(){

    var div = document.getElementById("existingdiv");
	div.innerHTML = "";
	if(document.getElementById("ExistingCheck").checked) {

	   div.innerHTML += "<br/><h3>"+HeuristScholarDB.getRecord(rec_id).getTitle()+"</h3>";


	var relnType;
	var relations,relationsByType, recordTypes, relns;
	var list;
	var rec, recType, relType;
    var relationship_id; //this is a HRelationship id

	relations = chosenRecord.getRelationships();

	if (relations.length > 0) {
		relationsByType = {};
		recordTypes = [];

		for (i=0; i < relations.length; ++i) {

			if (relations[i].getPrimaryRecord().getID() === chosenRecord.getID()) {
				rec = relations[i].getSecondaryRecord().getRecord();
				if(!rec) continue;
				relType = relations[i].getType();
				recType = rec.getRecordType().getID();
			}
			else {
				rec = relations[i].getPrimaryRecord().getRecord();
				if(!rec) continue;
				relType = relations[i].getInverseType();
				recType = rec.getRecordType().getID();
			}
			if (! rec) { continue; }

			if (relationsByType[recType]) {
				if (relationsByType[recType][relType]) {
					relationsByType[recType][relType].push(rec);
				}
				else {
					relationsByType[recType][relType] = [ rec ];
				}
			}
			else {
				recordTypes.push(recType);
				relationsByType[recType] = {};
				relationsByType[recType][relType] = [ rec ];
			}
		}

		recordTypes.sort(function(a,b){return a-b;});
		for (var j=0; j < recordTypes.length; ++j) {
		    recType = recordTypes[j];

		    div.appendChild(document.createElement("hr"));


		    for (relnType in relationsByType[recType]) {
			relns = relationsByType[recType][relnType];
			relns.sort(strcmp);

			var newDiv = document.createElement("div");
			newDiv.className = "relation_type";
			newDiv.appendChild(document.createTextNode(relnType));
			div.appendChild(newDiv);


			for (i=0; i < relns.length; ++i) {
				displayExistingRelationships(div, relns[i]);

			}

			div.appendChild(document.createElement("br"));

		    }
		}
	}
	else {
		div.innerHTML = "<i>No related records</i>";

	}



 }
}
function displayExistingRelationships(rrList,record){

	var newTable = document.createElement("table");
	newTable.className = "table";
	var newTr = newTable.appendChild(document.createElement("tbody")).appendChild(document.createElement("tr"));

	var newTd2 = newTr.appendChild(document.createElement("td"));
	newTd2.className = "relationshiptd";

	//var newTd1 = newTr.appendChild(document.createElement("td"));  //this td contains a "delete" link
	//newTd1.className = "deletetd";
	//newTd1.id="delRel"+record.getID();


    var newA2 = newTd2.appendChild(document.createTextNode(record.getTitle()));

	//newTd1.innerHTML = "<a href=\"#\"  onclick=\"deleteRelationship(this)\">delete relationship</a>";
	rrList.appendChild(newTable);


}

//this funtion responds to the event of deleting a relationship

function deleteRelationship(a){

	confirm("Are you sure you want to delete it?");

	var str= a.parentNode.id;
	var secondrecord_id=str.substr(6,(str.length-5));
	var primaryRecord=HeuristScholarDB.getRecord(rec_id);
	var secondRecord=HeuristScholarDB.getRecord(secondrecord_id);

	var relations=primaryRecord.getRelationships();

	for (i=0; i < relations.length; ++i) {
	    if(relations[i].getSecondaryRecord().getID()==secondrecord_id){

		     HeuristScholarDB.removeRelationship(relations[i],  new HSaver(
			   function(r) {
			     alert("relationships deleted");
			      console.log(r);

			   },
			  function(r,e) {
			     alert("relationships deletion failed:"+e);
				 console.log("record deletion failed: " + e);

			}));




		}
	}




}


//This function is used to search result
function doRelatedSearch(){

    var mysearch = new HSearch(document.getElementById("search-string").value);

		var loader = new HLoader(
			function(s,r) {
				displayResults(r);
			},
			function(s,e) {
				alert("load failed: " + e);
			});
		HeuristScholarDB.loadRecords(mysearch, loader);
}
//This function is used to display searched results
function displayResults(r) {
    var div=document.getElementById("divresult");

	div.innerHTML="";
	for (var i = 0; i < r.length; i++) {
			addRelatedRecordLink(div,r[i]);
		 }


	if(r.length>=1){

		div.appendChild(document.createTextNode("Relationships "));
	    var relationshipsDrop=document.createElement("select");          //create dropdown list
		relationshipsDrop.id="RelationshipsDrop";
		var relationshipTypes=HRelationship.getRelationshipTypes();
		for(var j=0;j<relationshipTypes.length;j++){
		    relationshipsDrop.appendChild(document.createElement("option")).appendChild(document.createTextNode(relationshipTypes[j]));
		}
		div.appendChild(relationshipsDrop);
		//div.innerHTML += "Title(<font color=\"red\">required</font>) <input type=\"text\" id=\"titleBox\"/>";
		div.innerHTML += "<input type=\"button\" value=\"Add relationship\" onclick=\"addRelationships();\"/>";


	}
	else{
	   div.innerHTML+="<br> <h3>no records found </h3>";
	}
		//document.getElementById("searchresults").style.overflow='auto';
}

function addRelatedRecordLink(rrList, record) {
	var newTable = document.createElement("table");
	newTable.className = "table";
	var newTr = newTable.appendChild(document.createElement("tbody")).appendChild(document.createElement("tr"));

	var newTd1 = newTr.appendChild(document.createElement("td"));
	newTd1.className="checkboxtd";
	var newTd2 = newTr.appendChild(document.createElement("td"));
	newTd2.className="relationshiptd";


	var newA1 = newTd1.appendChild(document.createElement("input"));
	newA1.type="checkbox";
	newA1.name="primaryReBox";
	newA1.id=record.getID();

	var newA2 = newTd2.appendChild(document.createTextNode(record.getTitle()));



	rrList.appendChild(newTable);
}

var relationshipssaved=true;
function addRelationships(){

    var secondRecords=document.getElementsByName("primaryReBox");   //get all the checkbox
	var relationDrop=document.getElementById("RelationshipsDrop");   //get relationship dropdown list
	var relationType=relationDrop.options[relationDrop.selectedIndex].text;  //get selected value from dropdown list
	var havingChecked=false;
	for(var i=0;i<secondRecords.length;i++){
	    if(secondRecords[i].checked){
		    havingChecked=true;
			saveRelationships(rec_id,relationType,secondRecords[i].id);
		}
	}

	if(!havingChecked)   //if none of the records is selected
	   alert("Plaese selcet at least one record!");
	if(relationshipssaved) { //if all the relationships are saved
       alert("relationships saved");
	   loadFirstRecord();
	   }
}

//This function is used to save a HRelationship record
function saveRelationships(primaryId,relationType,secondId){
    var primaryRecord=HeuristScholarDB.getRecord(primaryId);
	var secondRecord=HeuristScholarDB.getRecord(secondId);


	var hrelationship=new HRelationship(primaryRecord,relationType,secondRecord);
	hrelationship.addDetail( HDetailManager.getDetailTypeById(160), "Relationship" );

	var saver = new HSaver(
			function(r) {
			   //alert("relationships saved");
			   console.log(r);

			},
			function(r,e) {
			     alert("relationships save failed:"+e);
				 console.log("record save failed: " + e);
				 relationshipssaved=false;
			});
	HeuristScholarDB.saveRecord(hrelationship,saver); ///PAY ATTENTION @@@@@@@@@@@@@@@@@@@@@@@@@@@

}
  </script>
  <link rel="stylesheet" type="text/css" href="london-higher.css">

 </head>

 <body onLoad="init();">

  <span id=edit-title>

  </span>
  <div id="searchdiv">
  </div>
  <div id="existingdiv">
  </div>
  <div id="divresult">
  </div>
  <div id="formdiv">
  <table id=tab-edit class="edit" cellpadding="0" cellspacing="0">
  <tr><td class="panel-header" id=results></td>
  </tr>
  <tr>
  <td id=details></td>
  </tr>
  </table>
  </div>

 </body>

</html>
