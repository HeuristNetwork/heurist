<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>

<title>Heurist generic relationship mapper</title>

<link rel=stylesheet type=text/css href=http://acl.arts.usyd.edu.au/projects/networkmap/styles.css>
<style>
img.icon { margin-right: 4px; }

.sliderInput {
  	height:20;
    width:40;
  	font-family : Arial, Helvetica, sans-serif;
	color:#003366;
  	font-size : 10px;
	align:middle;
  }
  

</style>


<script src=../php/js/load-hapi.php></script>
<script src=/hapi/02/goi.js></script>

<script src="http://maps.google.com/maps?file=api&amp;v=2.105&amp;key=ABQIAAAAGZugEZOePOFa_Kc5QZ0UQRQUeYPJPN0iHdI_mpOIQDTyJGt-ARSOyMjfz0UjulQTRjpuNpjk72vQ3w" type="text/javascript"></script>
<script src="http://simile.mit.edu/timeline/api/timeline-api.js" type="text/javascript"></script>
<xscript src="main-105.js"></xscript>
<script type="text/javascript" src="http://www.blueshoes.org/_bsJavascript/lib/LibCrossBrowser.js"></script>
<script type="text/javascript" src="http://www.blueshoes.org/_bsJavascript/lib/EventHandler.js"></script>
<script type="text/javascript" src="http://www.blueshoes.org/_bsJavascript/core/form/Bs_FormUtil.lib.js"></script>
<script type="text/javascript" src="http://www.blueshoes.org/_bsJavascript/core/gfx/Bs_ColorUtil.lib.js"></script>
<script type="text/javascript" src="http://www.blueshoes.org/_bsJavascript/components/slider/Bs_Slider.class.js"></script>
<script>
var map, cacheMap;
window.console = window.firebug;

GMap2.prototype.cs = function(){this.Ef=true;if(this.ia()){this.nc(null,null,null)}};

GMap2.prototype.zoomAndPan = function(bounds, newZoom) {
	var currentCenter = this.getCenter();
	var newCenter = bounds.getCenter();

	cacheMap.setZoom(newZoom);
	cacheMap.setCenter(newCenter);

	var currentZoom = this.getZoom();

	if (newZoom > currentZoom) {
		// Need to zoom in

		for (var i=currentZoom+1; i <= newZoom; ++i) {
			setTimeout(makeNewTimeoutFunction(newCenter, true, 300 * (i - (currentZoom+1))));       
		}

		var handle = GEvent.addListener(map, "zoomend", function(_, endZoom) {
			if (endZoom != newZoom) { return; }
			GEvent.removeListener(handle);
		});
	}
	else if (newZoom < currentZoom) {
		// Need to zoom out

		/* This can get complicated:
		 * Google Maps' smooooooth animation (continuous zoom) goes ugly if the
		 * "focus point" of the zoom out is not actually visible
		 * (i.e. within the bounds of the map)
		 * So, we use a series of midpoints at geometrically increasing intervals.
		 */

		var totalN = (1 << (currentZoom - newZoom)) - 1;
		var n = 0, nIncrement = 1;
		for (var i=currentZoom-1; i >= newZoom; --i) {
			n += nIncrement;
			nIncrement *= 2;
			setTimeout(makeNewTimeoutFunction(calculateMidwayPoint(currentCenter, newCenter, n / totalN), false, 300 * ((currentZoom+1) - i)));
		}
		var handle = GEvent.addListener(map, "zoomend", function(_, endZoom) {
			if (endZoom != newZoom) { return; }
			GEvent.removeListener(handle);
			map.panTo(newCenter);
		});
	}
	else {
		if (! map.fromLatLngToDivPixel(newCenter).equals(map.fromLatLngToDivPixel(currentCenter))) {
			map.panTo(newCenter);
		}
		else {
			/* we don't have to move at all -- we're all done, stop the loading animation */
			moveEndCallback();
		}
	}
};


function GMarkerClusterManager(map) {
	if (map.clusterManager) { return map.clusterManager; }
	this.markers = {};
	this.clusterMarkers = {};

	this.map = map;
	this.collapseIcon = new GIcon(baseIcon);
	this.collapseIcon.image = "http://" + window.location.host + "/hapi/samples/collapso-circle.gif";
	this.expandIcon = new GIcon(baseIcon);
	this.expandIcon.image = "http://" + window.location.host + "/hapi/samples/expando-circle.gif";
	this.expandedClusters = [];

	map.clusterManager = this;

	GEvent.bind(map, "zoomend", this, this.redrawAllClusters);
}
GMarkerClusterManager.prototype.addMarker = function(marker) {
	var location = marker.getLatLng();
	var index = location.lat() + "," + location.lng();
	marker.originalLatLng = marker.getLatLng();
	
	var expanded;
	if(this.markers[index]){
	    
		if (this.markers[index].length > 1) {
			if(this.clusterMarkers[index].expanded){   //if the cluster marker is expanded,collapse it
				expanded = true;
				this.collapseCluster(this.clusterMarkers[index]);
				
				
			}
	
	     }
	} 
  
	if (! this.markers[index]) {
	   
		this.markers[index] = [ marker ];
		this.map.addOverlay(marker);
		
	}
	else {
		if (this.markers[index].length === 1) {
		    
			// just added a marker to an existing site where there was only one marker before
			
			if (this.markers[index][0].getTitle() != marker.getTitle()) {
				this.map.removeOverlay(this.markers[index][0]);
				this.setupClusterMarker(location, index);
			}
		}
		
		var exists = false;
		for (var i = 0; i < this.markers[index].length; ++i) {
			if (this.markers[index][i].getTitle() == marker.getTitle()) {
				exists = true;
				break;
			}
		}
        
		if (! exists) {
			this.markers[index].push(marker);
		}

		if (this.markers[index].length > 1) {
			if(expanded){                         //if originally, the cluster marker is expanded,expand it
			   this.expandCluster(this.clusterMarkers[index]);
			   
			}

		} 
		
	}
	
	
};
GMarkerClusterManager.prototype.removeMarker = function(marker) {
	var location = marker.originalLatLng;
	var index = location.lat() + "," + location.lng();
			// We have just removed the penultimate marker at this point: remove the cluster, restore the original marker
	var expanded;
	
	if(this.markers[index] && this.markers[index].length > 1){
		if(this.clusterMarkers[index].expanded){   //if the cluster marker is expanded,collapse it
					expanded = true;
					this.collapseCluster(this.clusterMarkers[index]);
					
				}
	}
	if(this.markers[index] && this.markers[index].length == 1){
	  
	 
	   this.map.removeOverlay(this.markers[index][0]);
	    if (this.markers[index][0].connectingLine) {
		     this.map.removeOverlay(this.markers[index][0].connectingLine);
	    }
		
	    //for(var j=0; j<markers.length; j++){
		//  if (this.markers[index][0] == marker) {
			 
		    delete this.markers[index];
			//break;
			//}
		//}
			
		
		    
	  
		
		
	}
	
	if(this.markers[index] && this.markers[index].length > 1){
		
		
		for (var i=0, len=this.markers[index].length; i < len; ++i) {
			if (this.markers[index][i] === marker) {
				this.markers[index].splice(i, 1);
				break;
			}
		}
		
		
		
			
		this.map.removeOverlay(marker);
		if (marker.connectingLine) {
			this.map.removeOverlay(marker.connectingLine);
		}
		
		if (this.markers[index].length === 1) {
			// We have just removed the penultimate marker at this point: remove the cluster, restore the original marker
			
			if(this.clusterMarkers[index].expanded){
				this.collapseCluster(this.clusterMarkers[index]);
			}
	
			this.map.removeOverlay(this.clusterMarkers[index]);
			GEvent.removeListener(this.clusterMarkers[index].clickListener);
			
	
			this.map.addOverlay(this.markers[index][0]);
			
		} 
		
		
			
			
		
			
	
			
		
  }
		if(this.markers[index] && this.markers[index].length > 1){
		    if(expanded){                         //if originally, the cluster marker is expanded,expand it
				this.expandCluster(this.clusterMarkers[index]);
			    
			}
		}
	  //if(this.markers[index])
	  //alert(this.markers[index][0].getTitle());
	
};
GMarkerClusterManager.prototype.removeAllMarkers = function() {
	var i, j, len;
	var marker;
	for (j in this.markers) {
		for (i=0, len=this.markers[j].length; i < len; ++i) {
			marker = this.markers[j][i];
			this.map.removeOverlay(marker);
			if (marker.connectingLine) {
				this.map.removeOverlay(marker.connectingLine);
				marker.connectingLine = null;
			}
		}
	}
	this.markers = {};

	for (i in this.clusterMarkers) {
		GEvent.removeListener(this.clusterMarkers[i].clickListener);
		this.map.removeOverlay(this.clusterMarkers[i]);
	}
	this.clusterMarkers = {};

	this.expandedClusters = [];
};

GMarkerClusterManager.prototype.setupClusterMarker = function(location, index) {
	var clusterMarker = new GMarker(location, { icon: this.expandIcon, title: "Click to see all markers at this point" });
	this.clusterMarkers[index] = clusterMarker;
	clusterMarker.index = index;
	clusterMarker.expanded = false;

	var manager = this;
	clusterMarker.clickListener = GEvent.addListener(clusterMarker, "click", function() { manager.handleClusterClick(this); });

	this.map.addOverlay(clusterMarker);
};

GMarkerClusterManager.prototype.handleClusterClick = function(clusterMarker) {
	if (! clusterMarker.expanded) {
		this.expandCluster(clusterMarker);
	}
	else {
		this.collapseCluster(clusterMarker);
	}
};

GMarkerClusterManager.prototype.expandCluster = function(clusterMarker) {
	clusterMarker.expanded = true;

	this.redrawCluster(clusterMarker, true);
	clusterMarker.setImage(this.collapseIcon.image);

	this.expandedClusters.push(clusterMarker);
};

GMarkerClusterManager.prototype.collapseCluster = function(clusterMarker) {
	var markers = this.markers[clusterMarker.index];

	var markerCount = markers.length;
	for (var i=0; i < markerCount; ++i) {
		markers[i].setLatLng(markers[i].originalLatLng);
		this.map.removeOverlay(markers[i].connectingLine);
		markers[i].connectingLine = null;

		this.map.removeOverlay(markers[i]);
		markers[i].connectingLine = null;
	}
    
	for (i=0; i < this.expandedClusters.length; ++i) {
		if (this.expandedClusters[i] === clusterMarker) {
			this.expandedClusters.splice(i, 1);
			break;
		}
	}

	clusterMarker.setImage(this.expandIcon.image);

	clusterMarker.expanded = false;
};

GMarkerClusterManager.prototype.redrawCluster = function(clusterMarker, isNewCluster) {
	var markers = this.markers[clusterMarker.index];
	var latlng, point;
	var radius = Math.max(30, 8 * markers.length);	// approximation in pixels
	var centerLatLng = clusterMarker.getLatLng();
	var center = this.map.fromLatLngToDivPixel(centerLatLng);

	var hiddenMarker = null;

	var markerCount = markers.length;
	var angle, angleOffset = centerLatLng.lat() * centerLatLng.lng();
	for (var i=0; i < markerCount; ++i) {
	      
			angle = angleOffset + i * Math.PI * 2 / markerCount;
			point = new GPoint( center.x + radius*Math.cos(angle), center.y + radius*Math.sin(angle) );
			latlng = this.map.fromDivPixelToLatLng(point);
	
			markers[i].setLatLng(latlng);
			this.map.addOverlay(markers[i]);
	
			if (! isNewCluster) {
				this.map.removeOverlay(markers[i].connectingLine);
			}
			markers[i].connectingLine = new GPolyline([ centerLatLng, latlng ], "#FF0000", 5, 0.7);
			this.map.addOverlay(markers[i].connectingLine);
		
	}

	if (isNewCluster) {
		/* for a new cluster, move the centre of the map a teeny-tiny bit so we can see it better */
		this.map.panTo(calculateMidwayPoint(map.getCenter(), centerLatLng, 0.1));
	}
};

GMarkerClusterManager.prototype.redrawAllClusters = function() {
	for (var i=0; i < this.expandedClusters.length; ++i) {
		this.redrawCluster(this.expandedClusters[i]);
	}
};



function calculateMidwayPoint(point1, point2, fraction) {
	/* calculate the point some fraction of the way between point1 and point2 */
	return new GLatLng(fraction * point2.lat() + (1-fraction) * point1.lat(), 
	                   fraction * point2.lng() + (1-fraction) * point1.lng());
}

function makeNewTimeoutFunction(center, zoomIn) {
	return function() {
		if (zoomIn) { 
			map.ok(1, true, center, true); 
		}
		else {
			map.ok(-1, true, center, true); 
		}
	}
}



function load() {
	if (! HCurrentUser.isLoggedIn()) {
		
		// need to use the host as found in the first line of code at the top of this script to make sure
		// users are redirected to the correct login
		alert("You are not logged in to Heurist.\nRedirecting you now ...");
		location.replace("http://"+window.location.host+"/heurist/php/login.php?last_uri=" + encodeURIComponent(location.href));
	}
	// only in the general EUProjects implementation is this required 
	//else if (! HCurrentUser.isInWorkgroup(HWorkgroupManager.getWorkgroupById(19))) {
	//	alert("You are not in the EUProject workgroup.\nSome records may not be visible to you.");
	//}

	if (GBrowserIsCompatible()) {
		// preload images
		cacheMap = new GMap2(document.getElementById("cache-map"));
		cacheMap.setCenter(new GLatLng(52, 10), 4);
		cacheMap.setMapType(G_PHYSICAL_MAP);

		map = new GMap2(document.getElementById("map"));
		map.enableDoubleClickZoom();
		map.enableContinuousZoom();
		map.enableScrollWheelZoom();
		map.addControl(new GSmallMapControl());
		map.setCenter(new GLatLng(52, 10), 4);
		map.setMapType(G_PHYSICAL_MAP);
		GEvent.addListener(map, "moveend", moveEndCallback);

		new GMarkerClusterManager(map);
	}

	loadAllRecords("ids:"+initialID, null, new HLoader(
		function(search, records) {
			for (var i=0; i < records.length; ++i) { processNewRecord(records[i]); }
			chooseRecord(records[0]);
			 
		},
		function(search, error) {
			alert("search failed: " + error);
		}));
		
	//loadTimeline();  //load timeline band
	
}

//added by nan li for search
var nancheck=2; //nan
function doSearch() {
    nancheck=1;
	legendCheck=2;
		var loader = new HLoader(	
			function(s,r) {
				displayResults(r);
			},
			function(s,e) {
				alert("load failed: " + e);
			});
		loadAllRecords(document.getElementById("search-string").value + " -type:52", null, loader);
	}

	function displayResults(r) {
	    document.getElementById("searchresults").style.display='';
		document.getElementById("contentframe").style.display='none';
		document.getElementById("legend").style.display='none';
		
		var div = document.getElementById("searchresults");
		div.style.height = "0px";
		div.style.height = (document.getElementById("contentcell").offsetHeight +50)+"px";
		document.getElementById("legendlink").style.display = '';
		div.innerHTML = "";
		for (var i = 0; i < r.length; i++) {
			addRelatedRecordLink(div,r[i]);
		}
	   
		document.getElementById("searchresults").style.overflow='auto';
	}
	function hideSearchResult(){
	    //document.getElementById("searchresults").innerHTML="";
		
		nancheck=2;
		
	    document.getElementById("searchresults").style.display='none';
		document.getElementById("contentframe").style.display='';         //relationtype
		
	}
	
// added by nan for search	

//the following function is used to load timeline
var mySlider;
var minValue=1999;
var maxValue=2010;
function initslider() {

 			mySlider = new Bs_Slider();
 			 mySlider.width         = 420;
 			 mySlider.height        = 25;
 			 mySlider.imgDir   = "slider/";
 			 mySlider.setBackgroundImage('slider_yardstick1.gif', 'no-repeat');
			 mySlider.attachOnChange (timeChange);
			 mySlider.attachOnInputChange (timeChange);
			// mySlider.attachOnInputBlur (timeChange);
			 
 			 mySlider.fieldName     = "slider_start";
 			 mySlider.minVal        = 1999;
 			 mySlider.maxVal        = 2010;
 			 mySlider.valueInterval = 1;
 			 mySlider.valueDefault  = minValue;
 			 mySlider.setSliderIcon('slider2.gif', 13, 25);
 			 mySlider.useInputField = 3;
 			 mySlider.styleValueFieldClass = "sliderInput";
	
			 mySlider.useSecondKnob        = true;
			 mySlider.preventValueCrossing = true;
			 mySlider.wheelAmount        = 0; //disable mouse wheeling cause we have 2 knobs.
	
			 mySlider.fieldName2     = "slider_end";
  			 mySlider.minVal2        = 1999;
  			 mySlider.maxVal2        = 2010;
 			 mySlider.valueInterval2 = 1;
 			 mySlider.valueDefault2  = maxValue;
			 mySlider.setSliderIcon2('slider2.gif', 13, 25);
 			 mySlider.useInputField2 = 3;
 			 mySlider.styleValueFieldClass2 = "sliderInput";
	
			mySlider.colorbar = new Object({ type:'between', color:'#6699CC', offsetLeft:6, height:11, offsetTop:12});
			


	
 			 mySlider.drawInto('my-timeline');
			 loadRelationships();
		}

function loadRelationships(){
    var relations=chosenRecord.getRelatedRecords();
	
	for (var i=0; i<relations.length;i++) {
	     if(relations[i].getRecordType().getID()==63){   
		     if(!relations[i].relatedLoaded){
				
				HeuristScholarDB.loadRecords(new HSearch("relationsfor:"+relations[i].getID()),
                                  new HLoader(function(s,r){}));
				//relations[i].relatedLoaded = true;
			}
		 }
	}
}

function timeChange() {
    
    
	
		var startDate, endDate;
	  
	   
		if (document.getElementById("filter").checked) {
			
			
	//		startDate = band.getMinVisibleDate().getFullYear() + 1;
	//		endDate = band.getMaxVisibleDate().getFullYear();
			startDate = Number(mySlider.getValue(1));
			endDate = Number(mySlider.getValue(2));
			
	       
			timeFilterRecords(startDate, endDate);
			minValue = Number(mySlider.getValue(1));
			maxValue = Number(mySlider.getValue(2));
		}
		else{
		      for(i=0; i<markers.length;i++){
                markers[i].added=false;
              }
			  timeFilterRecords();
			  minValue = Number(mySlider.getValue(1));
			  maxValue = Number(mySlider.getValue(2));
		}
	
}


function timeFilterRecords(startDate, endDate) {
     //document.getElementById("loadingmessage").innerHTML="filtering ...";
	var filteredRecordCount = 0;
	//var parseDate = eventSource._events.getUnit().getParser(null);
	var rs, re;
	
	var relations=chosenRecord.getRelatedRecords();
	
	for (var i=0; i<relations.length;i++) {
	     if(relations[i].getRecordType().getID()==63){                                      // look at relationships
			rs = relations[i].getDetail(HDetailManager.getDetailTypeById(177)); // get the start date of the relationship
			re = relations[i].getDetail(HDetailManager.getDetailTypeById(178)); // get the end date of the relationship
			rs = ((rs || "") + "").replace(/^(\d+)-(\d+)-(\d+)/, "$1/$2/$3");
			re = ((re || "") + "").replace(/^(\d+)-(\d+)-(\d+)/, "$1/$2/$3");
			rs= rs.substring(0,4);
			re = re.substring(0,4)
			if(!rs)
			   rs="1000";
			if(!re)
			   re="3000";
			   
			//rs = parseDate(rs);
			//re = parseDate(re);
			var hidden = arguments  &&  (rs  &&  (rs > endDate  ||  re < startDate));
            
			for (var k=0; k < relations[i].locations.length; ++k) {
			      for(var n=0; n<markers.length; n++){
				       if(markers[n].getTitle()==relations[i].getTitle()){
							var location = markers[n].getLatLng();
							var index = location.lat() + "," + location.lng();
							if (hidden) {
							   
								if (markers[n].connectingLine) {
								 
									 map.removeOverlay(markers[n].connectingLine);
								
								}
							  
								if(flag[n]==1) {
								
									map.clusterManager.removeMarker(markers[n]);
									
									    
										for(var m=0;m<lines.length;m++){
										    
											if(lines[m].getVertex(0).equals(chosenRecord.locations[0]) && lines[m].getVertex(1).equals(relations[i].locations[0]))
											{
												if(!map.clusterManager.markers[index]){
													lines[m].hide();
												}
											
											}
										 }
									
									filterRemoveOrganizations(relations[i]);
									
									
									flag[n] = 2;
								}
							
							// markers[n].hide();
							
							}
			              else {
						       
						       if(flag[n]==2) {
							     
								  
						          map.clusterManager.addMarker(markers[n]);
								  for(var m=0;m<lines.length;m++){
					
								   if(lines[m].getVertex(0).equals(chosenRecord.locations[0]) && lines[m].getVertex(1).equals(relations[i].locations[0]))
								   {
			                          lines[m].show();
									  
								   }
					              }
								  filterAddOrganizations(relations[i]);
								  
								  flag[n] = 1;         
							   }
						    
						  }
						  
					  }
					
					 
					}
			
				
			    }
	      }
			
	}
	
	
}


function filterRemoveOrganizations(pro){
  
								
  
    var relations = pro.getRelatedRecords();
	
	for(var i=0; i<relations.length; i++){
	    // alert(pro.getTitle()+" "+relations[i].getTitle());
	    if(relations[i].getRecordType().getID()==53 && !(relations[i]==chosenRecord)){
		
		   //for (var k=0; k < relations[i].locations.length; ++k) {
					  for(var n=0; n<markers.length; n++){
						   if(markers[n].getTitle()==relations[i].getTitle()){
						       
						        var location = markers[n].getLatLng();
	                            var index = location.lat() + "," + location.lng();
								map.clusterManager.removeMarker(markers[n]);
								markers[n].added=false;
								
								for(var m=0;m<lines.length;m++){
					              
								   if(lines[m].getVertex(0).equals(chosenRecord.locations[0]) && lines[m].getVertex(1).equals(relations[i].locations[0]))
								   {
			                          if(!map.clusterManager.markers[index]){
									      
									      lines[m].hide();
										 
									   }
									 
								   }
					              }
								break;
						   }
					  }
					  
			//}		
			
	    }
	}
   
}
function filterAddOrganizations(pro){
   
	
	var relations = pro.getRelatedRecords();
	
	//alert(pro.getTitle()+" "+relations.length);
	for(var i=0; i<relations.length; i++){
	  
	    if(relations[i].getRecordType().getID()==53  && !(relations[i]==chosenRecord)){
		   
		  // for (var k=0; k < relations[i].locations.length; ++k) {
					  for(var n=0; n<markers.length; n++){
					       
						   if(markers[n].getTitle()==relations[i].getTitle()){
						        var location = markers[n].getLatLng();
	                            var index = location.lat() + "," + location.lng();
						       
								//var newMarker = new GMarker(markers[n].getLatLng(), { icon: markers[n].getIcon(), title: markers[n].getTitle() });
								if(markers[n].added){
								    for(var si=0; si<markers.length;si++){
		                               if(markers[si].getTitle()==markers[n].getTitle())
			                           markers[si].added=false; 
	                                }
								   continue;
								}
								map.clusterManager.addMarker(markers[n]);
								
								
								for(var m=0;m<lines.length;m++){
					
								   if(lines[m].getVertex(0).equals(chosenRecord.locations[0]) && lines[m].getVertex(1).equals(relations[i].locations[0]))
								   {
			                          lines[m].show();
									  
								   }
					              }
								var duplicate = markers[n];
							    for(var t=n+1;t<markers.length; t++){
								   if(markers[t].getTitle()==duplicate.getTitle())
								      markers[n].added=true;  
								 
								  
								}
								break;
						   }
					  }
					 
			//}		  
	    }
	}
    
}



function changeDateFormat(startdate){
    if(startdate){
	var monthname=new Array("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec");
	var syear = startdate.substring(0,4);
	
	var smonth= startdate.substring(5,7);
	if(smonth.charAt(0)=="0")
	   smonth = smonth.substring(1,2);
	   
	var sday= startdate.substring(8,10);
	
    var sdate = monthname[smonth-1]+" "+sday+" "+syear+" 00:00:00 GMT";
	return sdate;
	}
	else
	return;
	 
}

//this function is used to get min start date from a bunch of projects
function getMinDate(startArr){   
   
	startArr.sort();
	return startArr[0];
}

//this function is used to get max end date from a bunch of projects
function getMaxDate(endArr){   
    
	endArr.sort();
	return endArr[endArr.length-1];
}
//build a function to replace all string in one variable.
 function replaceAll(str,from,to) {
    
    var idx=str.indexOf(from);  //get the index of from in str
    //replace all from in str to to
    while(idx>-1) {
        str=str.replace(from,to);
        idx=str.indexOf(from);
    }
    
    return str;

}

function showLegend(){
   
    if(nancheck == 1){
		document.getElementById("searchresults").style.height = "0px";
		document.getElementById("searchresults").style.height =  (document.getElementById("contentcell").offsetHeight+15 )+"px";
	}
	if(nancheck == 2){
		document.getElementById("contentframe").style.height =  "0px";
		document.getElementById("contentframe").style.height =  (document.getElementById("contentcell").offsetHeight+15 )+"px";
	}
    document.getElementById("legendlink").style.display = 'none';
	document.getElementById("legend").style.display = '';
	legendCheck = 2;
	
	
}
</script>

</head>
<body class=mainpage onload="load();"  style="margin-bottom: 0; margin-top:0">
<script>
var initialID = location.search.replace(/.*id=(\d+).*/, "$1") || 2;
var chosenRecord = null;
var recordStack = [];	// a list of all the previous records that have been visited
var recordStackIndex = 0;

var relatedDepth = 0;
var knownRecordIDs = [], knownRecordIDsMap = {};
var XField = HDetailManager.getDetailTypeById(210);
var YField = HDetailManager.getDetailTypeById(211);
var geoField = HDetailManager.getDetailTypeById(230);
var orgTypeField = HDetailManager.getDetailTypeById(364);	// actually category!

function processNewRecord(record) {
	var id = record.getID();
	var i;
	var x, y, geo;
	if (! knownRecordIDsMap[id]) {
		knownRecordIDsMap[id] = true;
		knownRecordIDs.push(id);
	}
}

// restrict all searches, loads etc to just the records with a kwd:18004
var BaseSearch = HSearch;
HAPI.Search = HSearch = function(query, options) {
	// don't reload known records
	var excludeIDs = "";
	if (knownRecordIDs) { excludeIDs = "-ids:" + knownRecordIDs.join(",") + " "; }
	BaseSearch.call(this, query+" "+excludeIDs, options);
//        BaseSearch.call(this, "kwd:18004 "+excludeIDs+query, options);
};
HSearch.getClass = function() { return "HSearch"; };
HAPI.inherit(HSearch, BaseSearch);


function chooseRecordCallback() {
	// Callback for GMarker: used with GEvent.bind such that (this) is an HRecord
	chooseRecord(this);
}


function chooseRecord(record, dontAlterStack) {
	var crt = document.getElementById("current-record-title");
	var crl = document.getElementById("current-record-link");
	var cri = document.getElementById("current-record-image");
	var rrList = document.getElementById("other-records");
	//var rrlistSear=document.getElementById("searchresults"); //nan

	crt.innerHTML = "";
	rrList.innerHTML = "Loading ...";
	//rrListSear.innerHTML = "Loading ...";  //nan
	document.getElementById("loading-div").style.display = "block";

	crt.appendChild(document.createTextNode(record.getTitle()));
	crl.href = "detail.html?id=" + record.getID();
	var orgType = record.getDetails(orgTypeField);
	if (orgType  &&  orgType[0]) {
		cri.src = getOrgTypeIcon(orgType[0], false);
	} else {
		cri.src = "http://heuristscholar.org/heurist-test/img/reftype/" + (record.getRecordType().getID() || "questionmark") + ".gif";
	}
	cri.style.display = "";
	cri.style.verticalAlign = "baseline";

	chosenRecord = record;
	if (! dontAlterStack) {
		// The record stack keeps track of which records we've previously chosen,
		// but in order to navigate back and forth between records already on the stack we need an override
		// (see gotoPreviousRecord and gotoNextRecord)

		if (recordStackIndex+1 >= recordStack.length) {
			// easy case: we are already looking at the last record on the stack, push the new record on the end
			recordStack.push(chosenRecord);
		}
		else {
			// harder case: there are other records lurking on the stack ABOVE (not including) our current position,
			// and we want to replace those all with one single record (the new record)
			recordStack.splice(recordStackIndex+1, recordStack.length-recordStackIndex-1, chosenRecord);
		}
		recordStackIndex = recordStack.length-1;
	}

	relatedDepth = 0;
	if (! chosenRecord.relatedLoaded) {
		++relatedDepth;
//sm.loadRecords(new HSearch("relatedto:"+_id+" OR linkto:"+_id+" OR linkedto:"+_id), loader);
                //sm.loadRecords(new HSearch("relationsfor:"+_id), loader);

		loadAllRecords("relationsfor:"+chosenRecord.getID(), null, new HLoader(addAllRelatedLinks));

//		chosenRecord.loadRelated(HeuristScholarDB, new HLoader(addAllRelatedLinks));
		chosenRecord.relatedLoaded = true;
	}
	else {
		addAllRelatedLinks();
		
	}
}


function loadAllRecords(query, options, loader) {
	var records = [];
	var baseSearch = new HSearch(query, options);
	var bulkLoader = new HLoader(
		function(s, r) {	// onload
			records.push.apply(records, r);
			if (r.length < 100) {
				// we've loaded all the records: invoke the loader's onload
				loader.onload(baseSearch, records);
			}
			else {
				// might be more records to load: do a search with an offset specified
				var search = new HSearch(query + " offset:"+records.length, options);
				HeuristScholarDB.loadRecords(search, bulkLoader);
			}
		},
		loader.onerror
	);
	HeuristScholarDB.loadRecords(baseSearch, bulkLoader);
}


var legendCheck = 1; //this var is used to set the height of contentframe
function addAllRelatedLinks(search, recordSet) {
	clearMap();

	loadPointsAndLines(chosenRecord.getID());

	var i;
	if (search) {
		for (i=0; i < recordSet.length; ++i) { processNewRecord(recordSet[i]); }
	}
	relatedDepth = 0;

	var rrList = document.getElementById("other-records");
	rrList.innerHTML = "&nbsp;";
	
	document.getElementById("contentframe").style.height="0px";
	if(legendCheck<2)  //when the page is loaded first time
	    document.getElementById("contentframe").style.height =  (document.getElementById("contentcell").offsetHeight+15) + "px";
	else{
		document.getElementById("legend").style.display='none';
		document.getElementById("legendlink").style.display = '';
		document.getElementById("contentframe").style.height =  (document.getElementById("contentcell").offsetHeight+50 )+"px";
	}
	 if(nancheck == 1){
		document.getElementById("searchresults").style.height = "0px";
		document.getElementById("searchresults").style.height =  (document.getElementById("contentcell").offsetHeight+50 )+"px";
	}
	legendCheck++;
	
	var rrlistSear=document.getElementById("searchresults"); //nan
	rrlistSear.innerHTML=""; //nan

	rrList.innerHTML = "";

	var relnType;
	var relations, relationsByType, recordTypes, relns;
	var list;
	var rec, recType, relType;

	relations = chosenRecord.getRelationships();
	
	if (relations.length > 0) {
		relationsByType = {};
		recordTypes = [];

		for (i=0; i < relations.length; ++i) {
			if (relations[i].getPrimaryRecord().getID() === chosenRecord.getID()) {
			    rec = relations[i].getSecondaryRecord().getRecord();
				if(!rec) continue;
				relType = relations[i].getType();
				recType = rec.getRecordType().getID();
			}
			else {
				rec = relations[i].getPrimaryRecord().getRecord();
				if(!rec) continue;
				relType = relations[i].getInverseType();
				recType = rec.getRecordType().getID();
			}
			if (! rec) { continue; }

			var hasDuplicated = false;
			if (relationsByType[recType]) {
				if (relationsByType[recType][relType]) {
				    for(var z=0;z<relationsByType[recType][relType].length;z++){
					    if(relationsByType[recType][relType][z]==rec){
						    hasDuplicated = true;                             //get rid of duplicated record
						    break;
						}
						 
					}
					if(!hasDuplicated){
					   relationsByType[recType][relType].push(rec);
					   }
					
				}
				else {
					relationsByType[recType][relType] = [ rec ];
				}
			}
			else {
				recordTypes.push(recType);
				relationsByType[recType] = {};
				relationsByType[recType][relType] = [ rec ];
			}
		}

		recordTypes.sort(function(a,b){return a-b;});
		for (var j=0; j < recordTypes.length; ++j) {
		    recType = recordTypes[j];

		    rrList.appendChild(document.createElement("hr"));
			if(nancheck==1)
			rrlistSear.appendChild(document.createElement("hr"));  //nan

		    for (relnType in relationsByType[recType]) {
			relns = relationsByType[recType][relnType];
			relns.sort(strcmp);

			
			var newDiv = document.createElement("div");
			newDiv.className = "relation_type";
			newDiv.appendChild(document.createTextNode(relnType));
			rrList.appendChild(newDiv);
			
			//added by nan to add relation type, such as  "is related to"
			var newDiv1 = document.createElement("div");
			newDiv1.className = "relation_type";
			newDiv1.appendChild(document.createTextNode(relnType));
			if(nancheck==1)
			rrlistSear.appendChild(newDiv1); //nan
			

			for (i=0; i < relns.length; ++i) {
				addRelatedRecordLink(rrList, relns[i]);
				if(nancheck==1)
				addRelatedRecordLink(rrlistSear,relns[i]);  //nan
			}

			rrList.appendChild(document.createElement("br"));
			if(nancheck==1)
			rrlistSear.appendChild(document.createElement("br")); //nan
		    }
		}
	}
	
	else {
		rrList.innerHTML = "<i>No related records</i>";
		rrlistSear.innerHTML = "<i>No related records</i>"; //nan
	}
	
	document.getElementById("filter").checked = false;
	initslider();  // load timeline for a record that has "project" relationship
	
	
}
function strcmp(a,b) { var x = a.getTitle(), y = b.getTitle(); return (x < y)? -1 : (x > y)? 1 : 0; }

function addRelatedRecordLink(rrList, record) {
	var newTable = document.createElement("table");
	newTable.className = "resource_table";
	var newTr = newTable.appendChild(document.createElement("tbody")).appendChild(document.createElement("tr"));

	var newTd1 = newTr.appendChild(document.createElement("td"));
	var newTd2 = newTr.appendChild(document.createElement("td"));
	var newTd3 = newTr.appendChild(document.createElement("td"));

	var newA1 = newTd1.appendChild(document.createElement("a"));
	newA1.title = "View resource details";
    //added by nanli
	newA1.href = "#";
	newA1.onclick= function(){window.open('detail.html?id='+record.getID(),'form','width=600,height=400,scrollbars=yes');}; 
	//added by nan
	var newImg = newA1.appendChild(document.createElement("img"));
	var orgType = record.getDetails(orgTypeField);
	if (orgType  &&  orgType[0]) {
		newImg.src = getOrgTypeIcon(orgType[0], false);
	} else {
		newImg.src = "http://heuristscholar.org/heurist-test/img/reftype/" + (record.getRecordType().getID() || "questionmark") + ".gif";
	}
	newImg.className = "icon";

	var newA2 = newTd2.appendChild(document.createElement("a"));
	newA2.className = "resource_link";
	newA2.title = "View related resources";
	newA2.href = "#";
	newA2.onclick = function() {
		chooseRecord(record);
		
		return false;
	};
	newA2.appendChild(document.createTextNode(record.getTitle()));

	if (record.getURL()) {
		var newA3 = newTd3.appendChild(document.createElement("a"));
		newA3.title = "View resource details";
		newA3.target = "_blank";
		newA3.href = record.getURL();
		var newImg = newA3.appendChild(document.createElement("img"));
		newImg.src = "http://heuristscholar.org/heurist-test/img/external_link_16x16.gif";
		newImg.className = "icon";
	}

	rrList.appendChild(newTable);
}


function gotoPreviousRecord() {
	if (recordStackIndex === 0) { return; }	// no previous record

	var previousRecord = recordStack[--recordStackIndex];
	chooseRecord(previousRecord, /* dontAlterStack = */ true);
}
function gotoNextRecord() {
	if (recordStackIndex+1 >= recordStack.length) { return; }	// no "next" record

	var nextRecord = recordStack[++recordStackIndex];
	chooseRecord(nextRecord, /* dontAlterStack = */ true);
}




var markers = [];
var lines = [];
var flag=[]; //added by nan
var removeflag=[]; //added by nan
var addflag=[]; //added by nan
var addArr=[];
var iconsByRecordType = {};
var iconsByOrgType = {};
var gifsByOrgType = {};
var baseIcon = new GIcon();
    baseIcon.image = "http://heuristscholar.org/heurist/img/circle.png";
    baseIcon.shadow = "http://heuristscholar.org/heurist/img/circle-shadow.png";
    baseIcon.iconAnchor = new GPoint(13, 13);
    baseIcon.infoWindowAnchor = new GPoint(13, 13);
    baseIcon.iconSize = new GSize(26, 26);
    baseIcon.shadowSize = new GSize(48, 28);
var bounds;


function clearMap() {
	var i;

/*
	for (i=0; i < markers.length; ++i) {
		//map.removeOverlay(markers[i]);
		map.clusterManager.removeMarker(markers[i]);
	}
*/
	map.clusterManager.removeAllMarkers();

	for (i=0; i < lines.length; ++i) {
		map.removeOverlay(lines[i]);
	}
	markers = [];
	lines = [];
}

function getOrgTypeIcon(orgType, icon) {
	if (! iconsByOrgType[orgType]) {
		iconsByOrgType[orgType] = new GIcon(baseIcon);
		switch(orgType) {
		case "Assoc London":
			iconsByOrgType[orgType].image = "http://heuristscholar.org/heurist-test/LondonHigher/img/AssocLondon.png";
			gifsByOrgType[orgType] = "http://heuristscholar.org/heurist-test/LondonHigher/img/AssocLondon.gif";
			break;
		case "Assoc other":
			iconsByOrgType[orgType].image = "http://heuristscholar.org/heurist-test/LondonHigher/img/AssocOther.png";
			gifsByOrgType[orgType] = "http://heuristscholar.org/heurist-test/LondonHigher/img/AssocOther.gif";
			break;
		case "Business London":
			iconsByOrgType[orgType].image = "http://heuristscholar.org/heurist-test/LondonHigher/img/BusinessLondon.png";
			gifsByOrgType[orgType] = "http://heuristscholar.org/heurist-test/LondonHigher/img/BusinessLondon.gif";
			break;
		case "Business other":
			iconsByOrgType[orgType].image = "http://heuristscholar.org/heurist-test/LondonHigher/img/BusinessOther.png";
			gifsByOrgType[orgType] = "http://heuristscholar.org/heurist-test/LondonHigher/img/BusinessOther.gif";
			break;
		case "FE London":
			iconsByOrgType[orgType].image = "http://heuristscholar.org/heurist-test/LondonHigher/img/FELondon.png";
			gifsByOrgType[orgType] = "http://heuristscholar.org/heurist-test/LondonHigher/img/FELondon.gif";
			break;
		case "FE other":
			iconsByOrgType[orgType].image = "http://heuristscholar.org/heurist-test/LondonHigher/img/FEOther.png";
			gifsByOrgType[orgType] = "http://heuristscholar.org/heurist-test/LondonHigher/img/FEOther.gif";
			break;
		
		case "HE other":
			iconsByOrgType[orgType].image = "http://heuristscholar.org/heurist-test/LondonHigher/img/HEother.png";
			gifsByOrgType[orgType] = "http://heuristscholar.org/heurist-test/LondonHigher/img/HEother.gif";
			break;
		case "London Higher":
		case "London Higher Parent":
			iconsByOrgType[orgType].image = "http://heuristscholar.org/heurist-test/LondonHigher/img/HELondon.png";
			gifsByOrgType[orgType] = "http://heuristscholar.org/heurist-test/LondonHigher/img/HELondon.gif";
			break;
		case "Res London":
			iconsByOrgType[orgType].image = "http://heuristscholar.org/heurist-test/LondonHigher/img/ResLondon.png";
			gifsByOrgType[orgType] = "http://heuristscholar.org/heurist-test/LondonHigher/img/ResLondon.gif";
			break;
		case "Res other":
			iconsByOrgType[orgType].image = "http://heuristscholar.org/heurist-test/LondonHigher/img/ResOther.png";
			gifsByOrgType[orgType] = "http://heuristscholar.org/heurist-test/LondonHigher/img/ResOther.gif";
			break;
		}
	}
	return icon ? iconsByOrgType[orgType] : gifsByOrgType[orgType];
}

function plotMap() {
	var i, j, k;
	var recordType;
	var records;
	var marker;
	var orgType;

	// clear any existing markers
	clearMap();

	records = chosenRecord.getRelatedRecords();
	for (i=0; i < chosenRecord.locations.length; ++i) {
		// if (chosenRecord.locations[i].depth > 0) { continue; }	// an inherited location
		for (j=0; j < records.length; ++j) {
			if (! records[j].locations) { continue; }
			for (k=0; k < records[j].locations.length; ++k) {
				if (records[j].locations[k].depth > 1) { continue; }	// an inherited location
				if (chosenRecord.locations[i].equals(records[j].locations[k])) { continue; }
				lines.push(new GPolyline([ chosenRecord.locations[i], records[j].locations[k] ], "#0000CC", 3, 0.5));
			}
		}
	}

	var newMarker;
	for (j=0; j < records.length; ++j) {
		recordType = records[j].getRecordType().getID();
		if (! iconsByRecordType[recordType]) {
			iconsByRecordType[recordType] = new GIcon(baseIcon);
			iconsByRecordType[recordType].image = "http://heuristscholar.org/heurist/img/reftype-png/" + recordType + ".png";
		}
		orgType = records[j].getDetails(orgTypeField);
		var orgIcon = null;
		if (orgType  &&  orgType[0]) {
			orgIcon = getOrgTypeIcon(orgType[0], true);
		}
		if (! records[j].locations) { continue; }
		for (k=0; k < records[j].locations.length; ++k) {
			if (records[j].locations[k].depth > 1) { continue; }
			newMarker = new GMarker(records[j].locations[k], { icon: orgIcon || iconsByRecordType[recordType], title: records[j].getTitle() });  //get the markers for related records
			GEvent.bind(newMarker, "click", records[j], chooseRecordCallback);
			markers.push(newMarker);
		}
	}

	recordType = chosenRecord.getRecordType().getID();
	if (! iconsByRecordType[recordType]) {
		iconsByRecordType[recordType] = new GIcon(baseIcon);
		iconsByRecordType[recordType].image = "http://heuristscholar.org/heurist/img/reftype-png/" + recordType + ".png";
	}
	orgType = chosenRecord.getDetails(orgTypeField);
	var orgIcon = null;
	if (orgType  &&  orgType[0]) {
		orgIcon = getOrgTypeIcon(orgType[0], true);
	}

	for (i=0; i < chosenRecord.locations.length; ++i) {
		newMarker = new GMarker(chosenRecord.locations[i], { icon: orgIcon || iconsByRecordType[recordType], title: chosenRecord.getTitle() });  // get the marker(one or more than one, based on how many locations the chosen record has) for the chosen record
		markers.push(newMarker);
	}

	for (i=markers.length-1; i >= 0; --i) {
//map.addOverlay(markers[i]);
		map.clusterManager.addMarker(markers[i]);
		flag[i] = 1; //added by nan
		removeflag[i] = 1; //added by nan
		addflag[i] = 1; //added by nan
	}
	 
	for(var i=0;i<markers.length;i++)
	addArr[i]=markers[i];
	for (i=0; i < lines.length; ++i) { map.addOverlay(lines[i]); }

//	map.setZoom(Math.min(map.getBoundsZoomLevel(bounds), 13));
//	map.panTo(bounds.getCenter());
	map.zoomAndPan(bounds, Math.min(map.getBoundsZoomLevel(bounds), 13));
}


function moveEndCallback() {
	document.getElementById("loading-div").style.display = "none";
}


function pointsCallback(vals) {
	var record;
	var i;
	var point;

	bounds = new GLatLngBounds();
	for (var bibID in vals) {
		record = HeuristScholarDB.getRecord(bibID);
		if (! record) { continue; }

		record.locations = [];
		for (i=0; i < vals[bibID].length; ++i) {
			point = new GLatLng(parseFloat(vals[bibID][i][1]), parseFloat(vals[bibID][i][0]));
			point.depth = vals[bibID][i][2];
			record.locations.push(point);
			bounds.extend(point);
		}
	}

	plotMap();
}


function loadPointsAndLines(id) {
	HAPI.XHR.sendRequest("get_points.php?bib_id=" + id, pointsCallback);
}

</script>

<div id=container>
 <div id=banner></div>
 <div id=center style="height:750px;" style="padding-right:0px">
  <div id=mapcontainer >
   <div id=loading-div style="position: absolute; width: 500px; z-index: 100000;"><img src=../loading-animation.gif style="position: absolute; right: 10px; top: 10px;"></div>
   <div id=map style="width: 500px; height: 700px;"></div>
   <div id="my-timeline" style="width: 500px; height: 20px;"></div>
   <div id=info style="height: 30px;">
    <label for=filter><input type=checkbox id=filter onclick="timeChange()"> Filter to blue bar extent</label>
	&nbsp; &nbsp; <span id="loadingmessage"> </span>
   </div>
   <div id=cache-map style="position: absolute; visibility: hidden; top: -1000px; width: 500px; height: 640px;"></div>

   
   
  </div>
 
 </div>
 
 <div id=right style="height:750px;" style="padding-right:0px">
  <table border=0 cellpadding=0 cellspacing=0 style="width: 100%; height: 100%;"><tbody>
   <tr><td style="height: 20px;">
    <h2>
     <a href=# onclick="gotoPreviousRecord(); return false;" style="float: left; padding: 0 1ex;">back</a>
     <a href=# onclick="gotoNextRecord(); return false;" style="float: left; padding: 0 1ex;">forward</a>
     Resources
    </h2>
   </td></tr>
    

   <tr><td style="height: 20px;">
    <table class=resource_table ><tr>
     <td ><h3><a id=current-record-link title="View resource details" href=#
            onclick="window.open(this.href, '', 'status=1,scrollbars=1,width=600,height=500'); return false;"><img id=current-record-image style="display: none;"></a>
         &nbsp;</h3>
     </td>
     <td>
      <h3 id=current-record-title></h3>
     </td>
	
 <!-- added by nan-->
  <td width="30px"></td>
  <td width="200px" style="padding-top:18px;">
  
      <form onsubmit="doSearch(); return false;">
          <input type="text" id="search-string" onclick="hideSearchResult();"></input>
          <input type="submit" value="search" onclick="doSearch();"></input>
      </form>	
  
  </td>
  <!-- added by nan-->
  
  
    </tr>
	
	</table>
  </td></tr>

  
  <tr><td style="vertical-align: top;  height:570px" id="contentcell">
  
    <!-- added by nan -->
   <div id="searchresults"  class="content" style="overflow:auto;">
   </div>
   <!-- added by nan -->
  
  <div id=contentframe style="overflow: auto;">
   <div class=content>
    <div id=other-records></div>
   </div>
  </div>
  
  </td></tr>
  <tr><td valign="top">
  <div id="legend" style="height: 40px;">
     <table border=0 cellpadding="0" cellspacing="3" height="40px">
	    <tr >
			<td width="17px" style=" padding-left:10px " valign="top" rowspan="2">
			  <img src="img/HELondon.gif" />
			</td>
			<td align="left" width="55px" valign="bottom">London<br>Higher</td>
			
			<td width="17px"  valign="top" rowspan="2">
			  <img src="img/ResLondon.gif" />
			</td>
			<td align="left" width="55px" valign="bottom">Research<br>London</td>
			
			 <td width="17px"  valign="top" rowspan="2">
			  <img src="img/BusinessLondon.gif" />
			</td>
			<td align="left" width="55px" valign="bottom">Business<br>London</td>
			
			  <td width="17px"  valign="top" rowspan="2">
			  <img src="img/AssocLondon.gif"  />
			</td>
			<td align="left" width="55px" valign="bottom">Association<br>London</td>
			
			 <td width="17px"  valign="top" rowspan="2">
			  <img src="img/FELondon.gif" />
			</td>
			<td align="left" width="55px" valign="bottom">FE<br>London</td>
		</tr>
		<tr valign="top">
		    <td align="left" valign="top"></td>
			<td align="left" valign="top"></td>
			<td align="left" valign="top"></td>
			<td align="left" valign="top"></td>
			<td align="left" valign="top"></td>
		</tr>
		 <tr valign="top">
			<td width="17px" rowspan="2" style=" padding-left:10px;">
			  <img src="img/HEother.gif" />
			</td>
			<td align="left">HE<br>other</td>
			
			<td width="17px" rowspan="2">
			  <img src="img/ResOther.gif" />
			</td>
			<td align="left">Research<br>other</td>
			
			 <td width="17px" rowspan="2">
			  <img src="img/BusinessOther.gif" />
			</td>
			<td align="left">Business<br>other</td>
			
			  <td width="17px" rowspan="2">
			  <img src="img/AssocOther.gif" />
			</td>
			<td align="left">Association<br>other</td>
			
			 <td width="17px" rowspan="2">
			  <img src="img/FEOther.gif" />
			</td>
			<td align="left">FE<br>other</td>
		</tr>
		<tr>
		    <td align="left" valign="top"></td>
			<td align="left" valign="top"></td>
			<td align="left" valign="top"></td>
			<td align="left" valign="top"></td>
			<td align="left" valign="top"></td>
		</tr>
		    
		
		
	 </table>
	 </div>
	 <div id="legendlink" style="display:none"><a href="#" onclick="showLegend()" title="show legend"><br>-legend-</a>
	 </td>
	 </tr>
  
 </tbody></table>
 
 </div>
 
</div>


</body>
</html>
