<html>
 <head>
  <script>
	window.opener.HAPI.importSymbols(window.opener, this);
	var record;
	var annotation_type;
	var related_id;
	var related;
	var ref;
	var record_type;
	var detail_types;
	var linked_record, image_record;

function init() {
	record_type = HRecordTypeManager.getRecordTypeById(99);
	detail_types = HDetailManager.getDetailTypesForRecordType(record_type);
	var matches = window.location.href.match(/[?&]id=([0-9]+)/);
	if (matches) {
		load_annotation(matches[1]);
	} else {
		fill_form();
	}
}


function load_annotation(id) {
	var loader = new HLoader(
		function(s,r) {
			record = r[0];
			annotation_loaded();
		},
		function(s,e) {
			alert("load failed: " + e);
		});
	HeuristScholarDB.loadRecords(new HSearch("id:" + id), loader);
}

function annotation_loaded() {
	    var title;
		document.getElementById("pagetitle").innerHTML = "Add/edit annotation";
		for (var i in detail_types) {
			var val = record.getDetail(detail_types[i]);
			switch (detail_types[i].getID()) {
				case 160: document.getElementById("title").value = val; break;
				case 191: document.getElementById("notes").value = val; break;
				case 322: break; // tei document reference - no need to load
				case 539: document.getElementById("start_e").value = val; break;
				case 540: document.getElementById("end_e").value = val; break;
				case 329: document.getElementById("start_w").value = val; break;
				case 330: document.getElementById("end_w").value = val; break;
				case 199: if(val){setRecord(val.getID(), val.getTitle(), "linked");} break;
				case 508: if(val){setRecord(val.getID(), val.getTitle(), "image");} break;
			}
		}
}


function fill_form() {

		var matches = window.location.href.match(/[?&]refid=([0-9]+)/);
		if (matches) {
			related_id = matches[1];
		}

		document.getElementById("pagetitle").innerHTML = "Add/edit annotation";

		// disable section inputs
		document.getElementById("start_e").disabled = true;
		document.getElementById("end_e").disabled = true;
		document.getElementById("start_w").disabled = true;
		document.getElementById("end_w").disabled = true;

		var root = window.opener.document.getElementById("tei");
		ref = window.opener.getSelectionAddress(root);
		if (ref) {
			document.getElementById("start_e").value = ref.startElems.join(",");
			if (ref.endElems.join(",") != ref.startElems.join(",")) {
				document.getElementById("end_e").value = ref.endElems.join(",");
			}
			document.getElementById("start_w").value = ref.startWord;
			if (ref.endWord != ref.startWord)
				document.getElementById("end_w").value = ref.endWord;
		}

		var refdoc_title;

		try {
			refdoc_title = window.opener.getSelection().toString();
		} catch (e) { }

		
		document.getElementById("title").value = refdoc_title;
		


		var loader = new HLoader(
			function(s,r) {
				related = r[0];
			},
			function(s,e) {
				alert("load failed: " + e);
			});
		HeuristScholarDB.loadRecords(new HSearch("id:" + related_id), loader);
}


function saveRecord() {
		if (! record) {
			record = new HRecord();
			record.setRecordType(record_type);

			if (related && related.getWorkgroup()) {
				record.setWorkgroup(related.getWorkgroup());
				record.setNonWorkgroupVisible(true);
			}

		}

		var start_e = document.getElementById("start_e").value;
		var end_e = document.getElementById("end_e").value;
		var start_w = document.getElementById("start_w").value;
		var end_w = document.getElementById("end_w").value;

		for (var i in detail_types) {

			var val = null;
			switch (detail_types[i].getID()) {
				case 160: val = document.getElementById("title").value; break;
				case 191: val = document.getElementById("notes").value; break;
				case 322: val = related; break;
				case 539: val = start_e; break;
				case 540: val = end_e != start_e ? end_e : null; break;
				case 329: val = start_w; break;
				case 330: val = end_w != start_w ? end_w : null; break;
				case 199: val = linked_record;  break;
				case 508: val = image_record; break;
			}

			if (val)
				record.setDetails(detail_types[i], [val]);
		}

		var saver = new HSaver(
			function(r) {
				if (window.opener) {
					window.opener.location.reload();
					setTimeout(window.close, 10);
				}
			},
			function(r,e) {
				alert("record save failed: " + e);
			});

		HeuristScholarDB.saveRecord(record, saver);
}

function doSearch(active) {
	    var q = document.getElementById(active + "-search").value;
		if (!q) {
			alert ("Enter a search string");
			return;
		}

		if (active == "image") {
			q = q + " type:74";
		} 

		var loader = new HLoader(
			function(s,r) {
				displayResults(r, active);
			},
			function(s,e) {
				alert("load failed: " + e);
			}
		);
		HeuristScholarDB.loadRecords(new HSearch(q), loader);
}
	
function displayResults(r, active) {
		document.getElementById(active +"-results-div").style.display = "block";
		var div = document.getElementById(active +"-results");
		var innerHTML = "";
		for (var i = 0; i < r.length; i++) {
			if (r[i].getRecordType().getID() != 52) {
				innerHTML += "<img src=/heurist/img/reftype/"+r[i].getRecordType().getID()+".gif> ";
				innerHTML += "<a href=# onclick=\"setRecord("+r[i].getID()+", this.innerHTML, '" + active +"'); return false;\">" + r[i].getTitle() + "</a><br/>";
			}
		}
		if (innerHTML.length) {
			div.innerHTML = innerHTML;
		} else {
			div.innerHTML = "No matching records";
		}
		var b;
		b = document.createElement("input");
		b.type = "button";
		
		if (active == "image") {
			b.value = "Add multimedia record";
			b.onclick = function () {
				document.getElementById("active-search").value = "image";
				window.open("edit.html?typeId=74","","status=0,scrollbars=1,resizable=1,width=800,height=600");
			}
		} else {
			b.value = "Add a record";
			b.onclick = function () {
				document.getElementById("active-search").value = "";
				//HERE IT WILL BREAK
				window.open("edit.html?typeId=","","status=0,scrollbars=1,resizable=1,width=800,height=600");
			}
		}
		div.appendChild(b);

}

function setRecord(id, title, active) {
		document.getElementById(active +"-record-span").innerHTML = "\"" + title + "\"";
		document.getElementById(active +"-search-span").style.display = "none";
		document.getElementById(active +"-display-span").style.display = "inline";
		document.getElementById(active +"-results-div").style.display = "none";
		doSet(active, HeuristScholarDB.getRecord(id));
}

function change(active) {
		document.getElementById(active +"-search-span").style.display = "inline";
		document.getElementById(active +"-display-span").style.display = "none";
		document.getElementById(active +"-results-div").style.display = "none";
		doSet (active, null);
}
	
function doSet(active, value) {
		if (active == "linked") {
			linked_record = value;
		}
		if (active == "image") {
			image_record = value;
		}
}

function typeChanged() {
		change();
}

  </script>
  <style>
  	html, table, td, input{
   	font-family: Arial, Helvetica, sans-serif;
	font-size: 12px;
   }
	#linked-record-span,
	#image-record-span {
		font-size: 90%;
	}
	#linked-results-div
	#image-results-div {
		margin-top: 3px;
		font-size: 90%;
	}
	#linked-results,
	#image-results {
		border: 1px solid black;
		padding: 5px;
		height: 100px;
		overflow: auto;
	}
  </style>
 </head>
  <title>Add / edit annotation</title>

 <body onload="init();">

  <h2 id="pagetitle"></h2>

  <table cellspacing=10px>
   <!--tr>
    <td>Select record type: </td><td><select id="record_type_select" onchange="changeType();"/></td>
   </tr-->

   <tr>
    <td>Title</td><td colspan=3><input type=text id=title style="width: 60ex;"/></td>
   </tr>
   <tr>
    <td>Caption</td><td colspan=3><textarea id=notes style="width: 70ex; height: 20ex;"></textarea></td>
   </tr>
   <tr><td>&nbsp;</td></tr>
   <form id="linked-search-form" onSubmit="doSearch('linked'); return false;">
    <tr id="linked-record-tr">
    <td>Resource</td>
    <td colspan=3>

     <span id=linked-search-span>
      <input type=text id=linked-search style="width: 30ex;"/>
      <input type=submit value="search" id = "linked-search-button"/>

     </span>
     <span id=linked-display-span style="display: none;">
      <span id=linked-record-span></span>
      <input type=submit value=change onclick="change('linked');return false;"/>
     </span>
     <div id=linked-results-div style="display: none;">
      Search results (click to select):
      <div id=linked-results />
     </div>

    </td>
   </tr>
   </form>
   <form id="image-search-form" onSubmit="doSearch('image'); return false;">
   <tr>
    <td>Image reference</td>
    <td colspan=3>

     <span id=image-search-span>
      <input type=text id=image-search style="width: 30ex;" />
      <input type=submit value="search" id = "image-search-button"/>

     </span>
     <span id=image-display-span style="display: none;">
      <span id=image-record-span></span>
      <input type=button value=change  onclick="change('image'); return false;"/>
     </span>
     <div id=image-results-div style="display: none;">
      Search results (click to select):
      <div id=image-results />
     </div>

    </td>
   </tr>
   </form>
   <tr><td>&nbsp;</td></tr>
   <tr>
    <td style="padding-right: 10px;">Section</td>
	<td>
	 <table>
      <tr>
       <td>Start element</td><td><input type=text id=start_e style="width: 10ex;"/></td>
       <td>End element</td><td><input type=text id=end_e style="width: 10ex;"/></td>
      </tr>
      <tr>
       <td>Start word</td><td><input type=text id=start_w style="width: 10ex;"/></td>
       <td>End word</td><td><input type=text id=end_w style="width: 10ex;"/></td>
      </tr>
     </table>
    </td>
   </tr>
   <tr><td>&nbsp;</td></tr>
   <tr>
    <td><input type=button value=save onclick="saveRecord();"/>
	<input type="hidden" id="active-search" value=""/></td>
   </tr>
  </table>

 </body>
</html>
