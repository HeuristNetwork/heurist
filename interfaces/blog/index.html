<html>
<head>
<title>Heurist blog</title>
<link rel=stylesheet href="woot.css">
<link rel=stylesheet href="comments.css">
<link rel=stylesheet href="../../common/css/autocomplete.css">

<script src="../../external/jquery/jquery.js"></script>

<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAAGZugEZOePOFa_Kc5QZ0UQRQUeYPJPN0iHdI_mpOIQDTyJGt-ARSOyMjfz0UjulQTRjpuNpjk72vQ3w"></script>

<script src="../../common/php/load-hapi.php"></script>
<script src="../../hapi/js/goi.js"></script>

<script>
if (! HCurrentUser.isLoggedIn()) {
	window.location = HAPI.HeuristBaseURL + "common/connect/login.php";
}
</script>

<script src="../../data/comments/comments.js"></script>
<script src="../../external/tinymce/jscripts/tiny_mce/tiny_mce.js"></script>
<script src="../../data/woot/js/woot.js"></script>
<script src="blog.js"></script>

<script src="http://yui.yahooapis.com/2.5.2/build/yahoo/yahoo-min.js"></script>
<script src="http://yui.yahooapis.com/2.5.2/build/event/event-min.js"></script>
<script src="http://yui.yahooapis.com/2.5.2/build/history/history-debug.js"></script>

<script>

$(document).ready(function() {
	var user, group, record_type, query, matches;

	matches = location.href.match(/[?&]u=(\d+)/);	// extract the userID from the URI
	if (matches) {
		user = HUserManager.getUserById(matches[1]);
		$("#bloglogo a").attr("href", "?u=" + matches[1]);
	}
	if (! user) {
		matches = location.href.match(/[?&]g=(\d+)/);	// extract the groupID from the URI
		if (matches) {
			group = HWorkgroupManager.getWorkgroupById(matches[1]);
			$("#bloglogo a").attr("href", "?g=" + matches[1]);
		}
	}
	if (! (user || group)) { alert("user / group ID invalid or not provided"); return; }

	matches = location.href.match(/[?&]t=(\d+)/);	// extract the typeID from the URI
	if (matches) {
		record_type = HRecordTypeManager.getRecordTypeById(matches[1]);
	}

	matches = location.href.match(/[?&]q=([^&]+)/);
	if (matches) {
		query = unescape(matches[1]).replace(/\+/, ' ');
	}

	if (! record_type  &&  ! query) {
		record_type = HRecordTypeManager.getRecordTypeById(137);	// blog entry record type
	}

	if (user) {
		$("#blog-owner").text(user.getRealName());
		document.title += " - " + user.getRealName();
	} else {
		$("#blog-owner").text(group.getName());
		document.title += " - " + group.getName();
	}

	var nameSort = function(a,b) {
		var x = a.getName().toLowerCase();
		var y = b.getName().toLowerCase();
		return (x == y) ? 0 : ((x > y) ? 1 : -1);
	};

	// blog select
	$("<option value='u=" + HCurrentUser.getID() + "'>" + HCurrentUser.getRealName() + "</option>")
		.click(function () {
			location.href = "?" + this.value;
		})
		.appendTo("#blog-select");
	var wgs = HCurrentUser.getWorkgroups();
	wgs = wgs.sort(nameSort);
	for (var i = 0; i < wgs.length; ++i) {
		$("<option value='g=" + wgs[i].getID() + "'>" + wgs[i].getName() + "</option>")
			.click(function () {
				location.href = "?" + this.value;
			})
			.appendTo("#blog-select");
	}

	// record type select
	var rectypes = HRecordTypeManager.getRecordTypes().sort(nameSort);
	for (var i = 0; i < rectypes.length; ++i) {
		$("<option value='" + rectypes[i].getID() + "'>" + rectypes[i].getName() + "</option>").appendTo("#record-type");
	}
//	$("#record-type").val(record_type ? record_type.getID() : 0);
	$("#record-type").val(query ?  0 : record_type.getID());
	$("#record-type").change(function() {
		window.location.href = "?" + (user ? "u="+user.getID() : "g="+group.getID()) + "&t="+this.value;
	});

	// later?
	var search = {};
	matches = location.hash.match(/^#((\d+)|(\d{4}-\d{2})|tag:(.*))$/);
	if (matches) {
		if (matches[2]) search["record"] = matches[2];
		else if (matches[3]) search["date"] = matches[3];
		else if (matches[4]) search["tag"] = matches[4];
	}

	$("#login").append(HCurrentUser.getRealName() + " : <a href='"+ HAPI.HeuristBaseURL +"/login.php?logout=1'>log out</a>");
	$("#add-fav-link")[0].href += "&t=" + encodeURIComponent(document.title) + "&u=" + encodeURIComponent(window.location.href);

	if ((user  &&  HCurrentUser == user) ||
		(group  &&  HCurrentUser.isInWorkgroup(group))) {
		$("<input type='button' id='new-entry-button' value='New " + record_type.getName() + "'/>")
			.click(function() { Blog.newEntry(); })
			.insertAfter("#header");
	}

	$("#spiel,#hide-spiel-link").hide();
	$("#spiel,#spiel-leader").click(toggleSpiel);
	$("#show-spiel-link,#hide-spiel-link").click(function() { toggleSpiel(); return false; });

	window.onbeforeunload = function() {
		// check for existence of save and cancel buttons to determine if we're editing an entry
		if ($(".save-cancel-button-row").length) {
			return "Changes to the blog entry you are editing will not be saved.";
		} else {
			return null;
		}
	};

	var opts = { "type" : record_type };
	if (query) opts.query = query;
	if (user) opts.user = user;
	else if (group) opts.group = group;

	Blog.init(opts);
});

function toggleSpiel() {
	$("#spiel").slideToggle("slow", function() {
		$("#show-spiel-link,#hide-spiel-link").toggle();
	});
}

function reload() {
	location.reload();
}

</script>

<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.5.2/build/fonts/fonts-min.css">

<link rel="stylesheet" type="text/css" href="blog.css">

</head>
<body>
 <iframe id=yui-history-iframe src="../../common/images/hlogo-small-blog-only.gif"></iframe>
 <input id=yui-history-field type=hidden>

 <script src=autocomplete.js></script>

<div id=header>
 <div class=right>
  <div id=login></div>
  <div id=add-fav><a id=add-fav-link href="../../records/addrec/add.php?addref=1&amp;k=Favourites">Add page to favourites</a></div>
 </div>
 <div id=hlogo>
  <a href=..><img src="../../common/images/hlogo-small-return-to-heurist.gif"></a>
  Blogs
  <select id=blog-select>
   <option selected>select...</option>
  </select>
 </div>
 <div class=clearall></div>
 <div id=banner>
  <div id=bloglogo>
   <a><img src="../../common/images/hlogo-small-blog-only.gif"></a><br>
   <a>home</a>
  </div>
  <h1 id=blog-owner></h1>
  <p id=spiel-leader><strong>Heurist Blog: the blog with more ...</strong> <a id=show-spiel-link href="#">tell me</a><a id=hide-spiel-link href="#">hide</a></p>
 </div>
 <div id=spiel title="click to hide">
  <br>
  In most blogs a blog entry is just that - a blog entry, nothing more. In
  Heurist, a blog entry is a fully-fledged record in a Heurist database.
  That means you can re-use the data in many other ways:
  <ul>
   <li>
    Create relationships between a blog entry and people, events,
    bibliographic references or any of the other 70+ record types in Heurist;
   </li>
   <li>
    See all the entries related to each entry in your blog, view them
    as a blog, add a new related entry
   </li>
   <li>
    View any type of record in blog format, edit, add related records etc.
   </li>
   <li>
    Attach geographic and time locations to your blog entries (and
    create maps and timelines from them);
   </li>
   <li>
    Attach thumbnail images to your blog entries;
   </li>
   <li>
    Use Heurist's search and publishing engine to find, reformat and
    publish blog entries live to other web pages, or provide RSS feeds;
   </li>
   <li>
    Insert other Heurist records in the blog entry as dynamic content
    (including images and other media objects, bibliographic references,
    people, places, events etc.);
   </li>
   <li>
    Create extended blog entries with granular permissions (read and/or
    write) on individual paragraphs down to individual users or workgroups;
   </li>
   <li>
    Use a personal blog or a workgroup blog, show or hide records from a
    broader public
   </li>
   <li>
    Include records seamlessly in your personal blog simply by bookmarking
   </li>
  </ul>
  <p>
   For maximum control of a blog entry, click on 'Edit full record' link
  </p>
 </div>
</div>

<table id=page>
 <tr>
  <td id=main></td>
  <td id=right>
   <div>
    <table>
     <tr>
      <td>Show</td>
      <td>
       <select id=record-type>
        <option value=0 disabled>(search results)</option>
       </select>
      </td>
     </tr>
     <tr>
      <td></td>
      <td>
       <input type="button" value="&lt;&lt; Back" onclick="history.go(-1);">
      </td>
     </tr>
    </table>
   </div>
   <div id=tags></div>
   <div id=archives>
    <h4>Archives</h4>
   </div>
  </td>
 </tr>
</table>

</body>
</html>
