<html>
<head>
<title>Add Nyirti Record</title>
	
<script src=http://hapi.heuristscholar.org/load?instance=artsdigital&v=d&key=793186f5d85de18661d0cc5a45f8be153706e632></script>
<script src=http://hapi.heuristscholar.org/02/goi.js></script>
<script src=common-functions.js></script>	
<script>
	  
var path ="http://artsdigital.heuristscholar.org/heurist/";
var rec_id = getIdFromUrl(); 

if (!HCurrentUser.isLoggedIn()) window.location= path +"php/login.php";

function init(){
	var spanTitle = document.getElementById("edit-title");
	
	spanTitle.innerHTML = "<h3>Add record</h3>";
	
	if (rec_id && rec_id!="undefined") {
		document.getElementById("rec-type-select-div").style.display = "none";
		printDetails(rec_id);
	} else {
	 createRecTypeOptions();
	}
}
		
function doRecSearch(id, option, detId, extra, constn) { //surely there must be a more elegant way of recycling the bugger
	var mysearch = new HSearch("ids:" + id);
	var loader = new HLoader (	
	
	function(s,r) {
		switch (option){
		case "resource":
			if (r[0]){
				drawResourceDetails(r[0], detId, extra, constn);
			}
			break; 
		}
	},
	
	function(s,e) { alert("load failed: " + e); });
		HeuristScholarDB.loadRecords(mysearch, loader);
}
	
function createRecTypeOptions() {
	var e = document.getElementById("rec-type-select-div");
	e.appendChild(document.createTextNode("Select record type: "));
	recTypeSelect = e.appendChild(document.createElement("select"));
	recTypeSelect.id = "rec-type-select";
	recTypeSelect.onchange = function() {  printDetails(); };
	
	var opt = document.createElement("option");
	opt.innerHTML = "record type...";
	opt.disabled = true;
	opt.selected = true;
	recTypeSelect.appendChild(opt);
	
	var recTypes = HRecordTypeManager.getRecordTypes();
	recTypes.sort(strcmp);
	for (var i = 0; i < recTypes.length; i ++) {
		opt = document.createElement("option");
		opt.value = recTypes[i].getID();
		opt.innerHTML = recTypes[i].getName();
		recTypeSelect.appendChild(opt);
	}
}

function strcmp(a,b) { 
	var x = a.getName(), y = b.getName(); 
	return (x < y)? -1 : (x > y)? 1 : 0; 
}
		
function printDetails(r) {

	if (!r) {
		r = document.getElementById("rec-type-select").value;
		document.getElementById("rec-type-select-div").style.display = "none";
	}
	
	document.getElementById("body-div").style.display = "";
	var documentHeaderHelp = document.getElementById("help-td");
	var div = document.getElementById("results");
	var dets = document.getElementById("details");
	var but = document.getElementById("but");
	div.innerHTML = "";
	dets.innerHTML = "";
	but.innerTHML="";
	
	var recordType = HRecordTypeManager.getRecordTypeById(r); 
	var recImage = recordType.getID();
	var recTitle = recordType.getName();
	var url = drawUrlField();
	var lightbulb = document.createElement("img");
	lightbulb.src = path + "img/lb.gif";
	lightbulb.align = "absmiddle";
	lightbulb.border = 0;
	
	var helpA = document.createElement("a");
	helpA.href = "#";
	helpA.onclick = function() { window.open('help.html', 'help','width=700, height=400'); };
	helpA.appendChild(lightbulb); 
	helpA.appendChild(document.createTextNode(" Help")); 
	
	documentHeaderHelp.appendChild(helpA);
				
	div.innerHTML += "Add new <img src='"+ path +"img/reftype/"+recImage+".gif' align=absmiddle> "+recTitle +"</span>";
	dets.innerHTML += "<table class=detail>";
	dets.innerHTML += "<img src=\"img/wm_logo_80.png\" style=\"float:right;\"> ";
	if (url) dets.appendChild(url);
	var detailTypes =HDetailManager.getDetailTypesForRecordType(recordType); //get all detail types for this record type 
		
		for (var i = 0; i < detailTypes.length; i++) {  //two loops, need to fully load "skin" before details, otherwise overwrites
			var elts =drawInputForm(detailTypes[i], recordType);
			if (elts) dets.appendChild(elts);
		}
				 
		for (var b = 0; b < detailTypes.length; b++) {
			drawInputFormDetails(detailTypes[b].getID(), recordType);
		}
		
	dets.innerHTML += "</table>";  
	
	drawRepeats();
	
	var butTon = document.createElement("input");
	but.appendChild(butTon);
	butTon.type = "button";
	butTon.value = "add record";
	butTon.onclick = function() { addRecord(recordType); };
	
	var cbutton = document.createElement("input");
	cbutton.type = "button";
	cbutton.value = "cancel";
	cbutton.onclick = function() { window.location = "search.html?re=yes"; };
	but.appendChild(cbutton);
	//and only then add autosave function
	if (document.getElementById("auto-save-span")){
		record.setRecordType(recordType);
		setAutoSaveTimeout(record);
	}
				
}
	
function drawInputFormDetails(detailId,recType){
	var detailType =  HDetailManager.getDetailTypeById(detailId); // HDetailType object
	var detVariety = detailType.getVariety();
	var detail = "";
	
	switch (detVariety){
	case 'literal':
		drawInputField(detailId, detail);
		break;
	
	case 'reference': //ATTENTION: not an efficient way of outputing resource pointers! FIXME!
		var constRecType;
		if (detailType.getConstrainedRecordType()) constRecType = detailType.getConstrainedRecordType().getID(); 
	  	drawResource(detailId, detail, constRecType);
	 	break;
	 
	case 'file':
		drawFile(detailId, detail);
		break;
	 
	case 'enumeration':
		drawEnums(detailId, detail);
		break;
	 
	case 'geographic': 
     	drawGeo(detailId, detail);
    	break;
	 
	case 'boolean':
	 	drawBool(detailId, detail);
		break;
	 
	case 'date': //TODO: add calendar
		drawInputField(detailId, detail);
		break;
	 
	case 'blocktext':
	 	drawTextArea (detailId, detail);
	 	break;

	default:
		drawRest(detailId, detail);
		break;
	}
	
}
	
	
function addRecord(recordType) {

	record.setRecordType(recordType);
	saveRecord(record);
	
}
	
	
function uploadFile(id) {	//FIXME local override funciton, not good! should be combined with a function in common_functions.js
	var files = document.getElementsByName(id);
	
	for (f in files){
		
		if (files[f].type == "file") 
		var file = files[f];
	}
	
	var fileCallback = function(fInput, hFile) {
	record.addDetail(HDetailManager.getDetailTypeById(id), hFile);
	
	var detail = record.getDetails(HDetailManager.getDetailTypeById(id));
	document.getElementById("sel"+id).innerHTML= "";
	drawFile(id, detail); 
	
	};
	
	var recordCallback = function(record) {
	};
	
	var fileUploadErrorCallback = function(record, error) {
	console.log(error);
	};
	
	HeuristScholarDB.saveFile(file, new HSaver(fileCallback, fileUploadErrorCallback)); 
}



</script>
<link rel="stylesheet" type="text/css" href="editform.css">
</head>
	
	 <body onLoad="init();">
	  <table class="transparent">
 <tr>
  <td><span id=edit-title></span></td><td><span id=auto-save-span></span></td><td>&nbsp;</td>
  </tr>
  </table>
	  <div id="rec-type-select-div"></div>
	  <div id="body-div" style="display:none;">
	  <table id=tab-edit class="edit" cellpadding="0" cellspacing="0">
	  <tr><td class="panel-header" id=results></td><td class="panel-header" id="help-td"></td>
	  </tr>
	  <tr>
	  <td id=details></td>
	  </tr>
	  <tr>
	  <td id=but></td>
	  </tr>
	  </table>
	 </div>
	 </body>
	
	</html>
