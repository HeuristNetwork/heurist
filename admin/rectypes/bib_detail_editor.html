<html>
 <head>
  <title>Heurist - Record types</title>

  <link rel="icon" href="../../favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="../../favicon.ico" type="image/x-icon">

  <link rel="stylesheet" type="text/css" href="../../common/css/Popup.css">
  <script type="text/javascript" src="../../common/js/Popup.js"></script>

  <link rel="stylesheet" type="text/css" href="../../common/css/newshsseri.css">
  <style type="text/css">
	a img { border: 0; }
	.friendly_border { border: 1px dotted lightgray; background-color: #FFFFDD; border-collapse: collapse; }
	.delete_icon { cursor: pointer; }

	.rft_icon {
		margin-right: 5px;
		vertical-align: middle;
		cursor: pointer;
	}
	body.wg .base-only { display: none; }
  </style>

[literal]
  <script type="text/javascript">
   <!--

	var existing_details = new Object();

	function delete_bdr(rdr_id) {
		var delement = document.forms['edit_form'].elements['bdr_delete_del_field_'+rdr_id];
		if (delement) {
			delement.value = 1;
			delement.form.submit();
		}
	}

	var protect_div = null;
	function edit_enum_types(rdt_id) {
		var name_span = document.getElementById('name'+rdt_id);
		var name_span_pos = findPos(name_span);
		edit_enum_types_with_pos(rdt_id, name_span_pos);
	}

	function edit_enum_types_with_pos(rdt_id, pos) {
		popup_frame(pos, 'enums/select_enum_values.php?instance=[instance-name!]&amp;rdt_id='+rdt_id, finish_edit_enum_types);
	}

	function finish_edit_enum_types() {
		close_popup_frame();
	}

	function edit_constrain_reftype(rdt_id) {
		var name_span = document.getElementById('name'+rdt_id);
		var pos = findPos(name_span);
		popup_frame(pos, 'constraints/edit_constrain_reftype.php?instance=[instance-name!]&amp;rdt_id='+rdt_id, finish_edit_constrain_reftype);
	}

	function finish_edit_constrain_reftype() {
		close_popup_frame();
		document.location.replace('bib_detail_editor.php?instance=[instance-name!]');
	}

	function popup_frame(position, location, finish_fn) {
		var popup_frame_elt = document.getElementById('popup_frame_obj');
		var frameTop = position.y - 138;
		var overflow;
		popup_frame_elt.style.left = position.x - 8;
		popup_frame_elt.style.top = frameTop;
		popup_frame_elt.contentWindow.location.replace(location);

		protect_div = document.createElement('div');
		protect_div.style.position = 'absolute';
		protect_div.style.width = '100%';
		protect_div.style.height = '200%';
		protect_div.style.left = '0px';
		protect_div.style.top = '0px';
		protect_div.style.zIndex = 0;
		protect_div.style.backgroundColor = 'black';
		protect_div.style.MozOpacity = '0.3';
		protect_div.style.opacity = '0.3';
		protect_div.onclick = finish_fn;
		popup_frame_elt.parentNode.appendChild(protect_div);
		document.body.style.overflow = 'hidden';

		overflow = popup_frame_elt.offsetTop + popup_frame_elt.offsetHeight - window.innerHeight;
//		if (overflow > 0) {
//			popup_frame_elt.style.top = frameTop - overflow;
			popup_frame_elt.style.top = Math.max(frameTop - overflow, popup_frame_elt.ownerDocument.body.scrollTop);
//		}
	}

	function close_popup_frame() {
		if (protect_div) { protect_div.parentNode.removeChild(protect_div); protect_div = null; }
		var popup_frame_elt = document.getElementById('popup_frame_obj');
		popup_frame_elt.style.left = '-1000px';
		document.body.style.overflow = '';
	}

	function findPos(obj) {
		var curleft = 0;
		var curtop = 0;
		if (obj.offsetParent) {
			while (obj.offsetParent) {
				curleft += obj.offsetLeft;
				curtop += obj.offsetTop;

	//			if (obj.scrollLeft) curleft -= obj.scrollLeft;
	//			if (obj.scrollTop) curtop -= obj.scrollTop;
				if (obj.parentNode.scrollLeft  ||  obj.parentNode.scrollTop) {
					curleft -= obj.parentNode.scrollLeft;
					curtop -= obj.parentNode.scrollTop;
				}
				obj = obj.offsetParent;
			}

		} else if (obj.x  ||  obj.y) {
			curleft += obj.x;
			curtop += obj.y;
		}

		var cur = new Object();
		cur.x = curleft;
		cur.y = curtop;

		return cur;
	}

	function upload_icon(rt_id) {
		var img = document.getElementById('rt'+rt_id);

		top.popup_url('upload_reftype_icon.php?instance=[instance-name!]&amp;rt_id='+rt_id, 100, 300);
	}

	function icon_refresh(rt_id) {
		var img = document.getElementById('rt'+rt_id);
		img.src = img.src.replace(/\?.*/, '') + '?' + (new Date()).getTime();
	}

	function check_prompts() {
		/* don't think we need to check this for instance overrides
		if (! check_matches()) {
			alert("Please select at least one field for MATCHING records of this type");
			return false;
		}*/

		var detail_table = document.getElementById('bib_detail_table');
		if (! detail_table) return true;
		var inputs = detail_table.getElementsByTagName('input');
		if (! inputs) return true;
		var title;
		var fields = '';
		for (var i = 0; i < inputs.length; ++i) {
			if (inputs[i].getAttribute('title') == 'contextual name')
				title = inputs[i].value;
			if (inputs[i].getAttribute('title') == 'prompt') {
				var prompt = inputs[i].value;
				if (! prompt  ||  ! prompt.match(/[^ ]+ [^ ]+ [^ ]+/)) {
					fields += title + '\n';
				}
			}
		}
		if (fields.length > 0) {
			alert('Please provide prompts of at least three words for the following fields:\n\n' + fields);
			return false;
		}
		return true;
	}

	function check_matches() {
		if (window.reqMatchField) return true;	// high tech it ain't
		var inputs = document.getElementsByTagName("input");
		for (var i=0; i < inputs.length; ++i) {
			if (inputs[i].name.match(/^bdr_rdr_match_/)  &&  inputs[i].checked) return true;
		}
		return false;
	}

   //-->
  </script>
[end-literal]

 </head>

 <body>

  <script>
    if ([grp_id] > 0) document.body.className = "wg";
  </script>

  {PageHeader}

  <div id="main">

  <div>

<a href="../users/add.php?instance=[instance-name!]">User admin</a>
|
<a href="../verification/recalculate_title_masks.php?instance=[instance-name!]">Rebuild titles</a>
|
<a href="../verification/find_dupes.php?fuzziness=10&amp;instance=[instance-name!]">Find duplicates</a>
|
<a href="../workgroups/workgroup_keyword_manager.php?instance=[instance-name!]">Workgroup tags</a>
|
<a href="../users/usergroupadmin.php?instance=[instance-name!]">List all users</a>
|
<a href="../../search/search.html?q=_BROKEN_&amp;w=all&amp;instance=[instance-name!]">Records with broken urls</a>
|
<a href="../workgroups/wg_overrides.php?instance=[instance-name!]">Record types with overrides</a>
|
<a href="../workgroups/groups.php?instance=[instance-name!]">Take your hat off (exit group)</a>
<br>
<a href="../verification/xhtmlcheck.php?instance=[instance-name!]">Woot XHTML check</a>
|
<a href="../verification/invalidcharactercheck.php?instance=[instance-name!]" >invalid Character check</a>
|
<a href="../verification/invalidcharacterclean.php?instance=[instance-name!]">clean invalid Character</a>
|
<a href="../workgroups/edit_workgroups.php?instance=[instance-name!]">Add/edit workgroups</a>
|
<a href="../rollback/record-rollback.php?instance=[instance-name!]">Record rollback</a>

  </div>

  <div style="padding: 10px;">

   <span class="normal" id="asdf">

  [if : added-metadata-element]
   <p style="color: green; font-weight: bold;">New metadata element added</p>
  [end-if]

[if : editing_reftype]
<form method="get">
 <input type=hidden name=rt_id value="[select REFTYPE rts][rt_id][end-select]">
 Editing requirements for: [workgroup-dropdown!]
</form>
[end-if]

<form action="bib_detail_editor.php?instance=[instance-name!]" method="post" name="edit_form" onsubmit="return check_prompts();">
<input type=hidden name=grp_id value='[grp_id]'>
[update REFTYPE rt1]

  [errors]
  [if : edit-success]
   <p style="color: green; font-weight: bold;">Changes saved</p>
  [end-if]
  <div class="headline">Editing record type <span style="letter-spacing: -2px;">&lt;&lt;</span><b>[rt_name]</b><span style="letter-spacing: -2px;">&gt;&gt;</span></div>

  <p/>

  <div style="font-weight: bold; margin: 5px 0;">Base requirements:</div>
  <div>(Y = required, R = recommended, O = optional)</div>
  <table border="0">
   <thead>
    <tr><th>Code</th><th>Label</th><th>Type</th><th>Req</th><th>Rpt</th><th>Match</th><th>Default</th><th>Prompt</th></tr>
   </thead>
   <tbody>
[foreach BIB_DETAIL_REQ base_bdr : 1 order by rdr_order, rdr_id]
    <tr>
     <td>[select BIB_DETAIL_TYPE bdt][rdt_id][end-select]</td>
     <td>[rdr_name]</td>
     <td>[select BIB_DETAIL_TYPE bdt][rdt_type][end-select]</td>
     <td>[rdr_required]</td>
     <td style="text-align: center;"><script type="text/javascript">document.write([rdr_repeatable]?'1':'');</script></td>
     <td style="text-align: center;"><script type="text/javascript">document.write([rdr_match]?'1':'');</script></td>
[if:rdr_match]
<script>
window.reqMatchField = 1;
</script>
[end-if]
     <td>[rdr_default]</td>
     <td>[rdr_prompt]</td>
    </tr>
[end-foreach]
[not-found][end-not-found]
   </tbody>
  </table>
  <hr>

  <p class="base-only">
   <a href="../../help/bib_detail_editor.html" target=_blank><img src="../../common/images/lb.gif" style="vertical-align: bottom;"></a>
   <a href="../../help/bib_detail_editor.html" target=_blank>Explanation of functions</a>
  </p>

  <table border="0">
   <tr class="base-only">
    <td style="width: 100px; font-weight: bold; text-align: right; vertical-align: top;">Notes on this record type</td>
    <td style="width: 300px;">
     [textarea : rt_notes : notes : style="width: 500px;" rows="1"]
    </td>
   </tr>

   <tr class="base-only">
    <td style="font-weight: bold; text-align: right;">Icon</td>
	<td>
     <img src="../../common/images/reftype-icons/[rt_id].gif" style="vertical-align: middle;" class="rft_icon" onclick="upload_icon([rt_id]);">
     &nbsp;&nbsp;&nbsp;&nbsp;
     <span style="font-weight: bold; text-align: right;">Bibliographic record types</span>
     [checkbox : rt_primary : primary record type : style="margin: 0px;"]
    </td>
   </tr>

   <tr class="base-only">
    <td style="font-weight: bold; text-align: right; vertical-align: top;">New title mask</td>
    <td>
     <div style="font-size: 80%; padding-bottom: 4px; width: 60%;">
      The title mask is a string into which metadata elements are interpolated, e.g.
       <span style="font-family: fixed; padding: 4px;">&#91;Title&#93;, pp &#91;Start_Page&#93;-&#91;End_Page&#93;</span>
      The element names in square brackets should match field names for this record type.
      The interpolated value is used as the default title for spontaneously-created bibliographic records of this type.
      To insert a literal square-bracket, use two consecutive square-brackets (&#91;&#91; or &#93;&#93;).
     </div>
     [textbox : rt_title_mask : combination of bibliographic details to make a title : style="width: 60%;"]
     <div style="color: red; font-weight: bold; width: 80%;">[new-field-errors]</div>
    </td>
   </tr>

   <tr class="base-only">
    <td colspan="2">&nbsp;</td>
   </tr>

   <tr>
    <td style="font-weight: bold; text-align: right; vertical-align: top;">Bibliographic details</td>
    <td>
     <table id="bib_detail_table" border="0" cellspacing="0" style="border-collapse: collapse;">
	 [search BDR_OVERRIDES bdr_search]
	 [auto : rdr_rec_type : rt_id]
	 [auto : rdr_wg_id : grp_id]
     [foreach BDR_OVERRIDES bdr : 1 order by rdr_order, rdr_id]
      <tr class="friendly_border">
       <td style="vertical-align: top; font-weight: bold;">
        <img src="../../common/images/cross.gif" onclick="delete_bdr([rdr_id]);" class="delete_icon">
        [delete BDR_OVERRIDES bdr_delete][hidden required : del_field][end-delete]
        [select BIB_DETAIL_TYPE bdt][rdt_name] <span style="font-size: 80%; font-weight: normal;">([rdt_id])</span>[end-select]&nbsp;
</td>
<td style="padding-bottom: 1ex;">
<nobr>
        [update BDR_OVERRIDES bdr]
         &nbsp;&nbsp;&nbsp;label [textbox : rdr_name : contextual name : style="width: 200px;"]&nbsp;
[dropdown required : rdr_required : : select req_abbrev, req_full from requirements order by req_order : style="width: 90px;"]&nbsp;
<img src="../../common/images/10x10.gif">
         &nbsp;size [textbox : rdr_size : field width : style="width: 30px;"]
          &nbsp;<label>repeatable [checkbox : rdr_repeatable : repeatable : style="margin: 0px;"]</label>&nbsp;
          &nbsp;<label>matching [checkbox : rdr_match : is this field used for identifying possible matches? : style="margin: 0px;"]</label>&nbsp;
          &nbsp;order&nbsp;[textbox : rdr_order : : style="width: 30px; padding: 0px 2px;"]&nbsp;
         &nbsp;default [textbox : rdr_default : default value : style="width: 100px;"]&nbsp;
         [textarea : rdr_help : help text : style="height: 25px; width: 200px; vertical-align: top;"]
         </nobr>
         <nobr>prompt [textbox : rdr_prompt : prompt : style="width: 700px;"]&nbsp;
[select BIB_DETAIL_TYPE bdt]
         &nbsp;data&nbsp;type : [if-eq : rdt_type : "enum"]<a href="#" onclick="edit_enum_types_with_pos([rdt_id], findPos(this.parentNode)); return false;">[rdt_type]</a>[else][rdt_type][end-if-eq]
&nbsp;&nbsp;
		 detail type description: [rdt_description]
[end-select]
</nobr>
       </td>
        [end-update]

      </tr>
     [end-foreach]
	 [end-search]
     [not-found]
      <tr><td colspan="2">(none specified)</td></tr>
     [end-not-found]

      <tr><td colspan="2">&nbsp;</td></tr>
     </table>
    </td>
   </tr>

   <tr>
    [insert BDR_OVERRIDES new_bdr]
    <td style="font-weight: bold; text-align: right;">Add new detail to this type</td>
    <td>
     [dropdown required : rdr_rdt_id : : select rdt_id, concat(rdt_id,'  ',rdt_name) from rec_detail_types left join rec_detail_requirements_overrides on rdr_rec_type=[special-rt_id] and rdr_rdt_id=rdt_id and rdr_wg_id=[special-grp_id] where rdr_id is null order by rdt_name : onchange="document.getElementById('new_bdr_label').value = this.options&#91;this.selectedIndex&#93;.text.replace(/&#91;0-9&#93;+\s*/,''); document.getElementById('new_bdr_order').value = this.options&#91;this.selectedIndex&#93;.value;"]
     [auto : rdr_wg_id : grp_id]
     [hidden : rdr_name : : id="new_bdr_label"]
     [auto : rdr_rec_type : rt_id]
     [hidden : rdr_order : : id="new_bdr_order"]
     [auto : rdr_size : "30"]
     &nbsp;&nbsp;&nbsp;&nbsp;Additions override base requirements. Set "Not Permitted" to hide fields.
    </td>
    [end-insert]
   </tr>

   <tr>
    <td colspan="2">&nbsp;</td>
   </tr>

   <tr>
    <td></td>
    <td>
     <input type="submit" name="action" value="Save" style="font-weight: bold;">
     &nbsp;&nbsp;
     <input type="button" value="Return to list" onclick="window.location.href = 'bib_detail_editor.php?instance=[instance-name!]';">
    </td>
   </tr>
  </table>

[end-update]
</form>

[not-found]
<div class="headline">Record types</div>
<p>[edit-master-types-link!]</p>

<p/>
<form method="post">
<table border="0">
 <tr><td></td><td style="text-align: right;"><a href="../describe/bib_detail_dump.php?instance=[instance-name!]">print-friendly dump</a> | <a href="../verification/bib_errors.php?instance=[instance-name!]">records with errors</a></td></tr>
<tr><td>
 <p><b>Select a record type to edit:</b></p>

 <div style="width: 300px; height: 500px; overflow: auto; padding: 3px;" class="friendly_border">
  <table border="0">
   [foreach REFTYPE rtf : 1 order by (!rt_primary), rt_name]
    <tr><td><input type=checkbox name='active_rt[literal][[end-literal][rt_id][literal]][end-literal]' [select ACTIVE_REFTYPE art]checked[end-select][not-found][end-not-found]></td><td style="text-align: right;">[rt_id]</td><td><img src="../../common/images/reftype-icons/[rt_id].gif" id="rt[rt_id]" class="rft_icon" onclick="upload_icon([rt_id]);"><a href="?rt_id=[rt_id]&amp;instance=[instance-name!]">[rt_name]</a></td></tr>
   [end-foreach]
   [not-found][end-not-found]
  </table>
 </div>

</td>
<td>
 <p><b>Detail types (fields)</b></p>

 <div style="width: 450px; height: 500px; overflow: auto; padding: 3px;" class="friendly_border">
  <table border="0" style="width: 100%;">
   [foreach BIB_DETAIL_TYPE bdt : 1 order by rdt_type, rdt_name]
    <tr>
     <td>[rdt_id]</td>
     <td style="width: 200px;"><span id="name[rdt_id]">[rdt_name]</span></td>
     <td style="text-align: left;">[if-eq : rdt_type : "enum"]<a href="#" onclick="edit_enum_types([rdt_id]); return false;">[rdt_type]</a>[else][rdt_type][end-if-eq][if-eq : rdt_type : "resource"] ([if : rdt_constrain_rec_type][select REFTYPE rft][rt_name][end-select][else]unconstrained[end-if])[end-if-eq]</td>
    </tr>
   [end-foreach]
  </table>
 </div>

</td></tr></table>

 <p>Check the types you want visible in this Heurist instance, and click "save".</p>
 <input type=submit value=save style="font-weight: bold;">
 <input type=hidden name=update-active-rec-types value=1>
</form>

[end-not-found]

   </span>

  </div>

  <iframe name="popup_frame" id="popup_frame_obj" src="enums/select_enum_values.php?instance=[instance-name!]" style="z-index: 51; width: 520px; height: 300px; position: absolute; top: -500px; left: 0px;" frameborder="0"></iframe>

  </div>

 </body>
</html>
