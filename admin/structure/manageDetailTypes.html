<!--

/**
* manageDetailTypes.html
* add/edit detailType
* 2011-03-14
* @autor: Artem Osmakov
*
* @copyright (C) 2005-2010 University of Sydney Digital Innovation Unit.
* @link: http://HeuristScholar.org
* @license http://www.gnu.org/licenses/gpl-3.0.txt
* @package Heurist academic knowledge management system
* @todo
**/

-->
<html>
	<head>


		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<title>Heurist - Field Types</title>

		<link rel=stylesheet href="../../common/css/global.css">

		<!-- YUI -->
		<link rel="stylesheet" type="text/css" href="../../external/yui/2.8.2r1/build/fonts/fonts-min.css" />
		<link rel="stylesheet" type="text/css" href="../../external/yui/2.8.2r1/build/tabview/assets/skins/sam/tabview.css" />
		<script type="text/javascript" src="../../external/yui/2.8.2r1/build/yahoo-dom-event/yahoo-dom-event.js"></script>
		<script type="text/javascript" src="../../external/yui/2.8.2r1/build/element/element-min.js"></script>
		<script type="text/javascript" src="../../external/yui/2.8.2r1/build/tabview/tabview-min.js"></script>
		<script type="text/javascript" src="../../external/yui/2.8.2r1/build/history/history-min.js"></script>
		<script type="text/javascript" src="../../external/yui/2.8.2r1/build/json/json-min.js"></script>

		<!-- DATATABLE DEFS -->
		<link type="text/css" rel="stylesheet" href="../../external/yui/2.8.2r1/build/datatable/assets/skins/sam/datatable.css">
		<!-- datatable Dependencies -->
		<script type="text/javascript" src="../../external/yui/2.8.2r1/build/datasource/datasource-min.js"></script>
		<!-- OPTIONAL: Drag Drop (enables resizeable or reorderable columns) -->
		<script type="text/javascript" src="../../external/yui/2.8.2r1/build/dragdrop/dragdrop-min.js"></script>
		<!-- Source files -->
		<script type="text/javascript" src="../../external/yui/2.8.2r1/build/datatable/datatable-min.js"></script>
		<!-- END DATATABLE DEFS-->

		<!-- PAGINATOR -->
		<link rel="stylesheet" type="text/css" href="../../external/yui/2.8.2r1/build/paginator/assets/skins/sam/paginator.css">
		<script type="text/javascript" src="../../external/yui/2.8.2r1/build/paginator/paginator-min.js"></script>
		<!-- END PAGINATOR -->

		<!-- OVERLAYS
		<script type="text/javascript" src="../../external/yui/2.8.2r1/build/button/button-min.js"></script>
		<script type="text/javascript" src="../../external/yui/2.8.2r1/build/container/container-min.js"></script>
		END OVERLAYS -->

		<!-- <script type="text/javascript" src="../../external/jquery/jquery.js"></script> -->
		<script type="text/javascript" src="http://code.jquery.com/jquery-latest.js"></script>

		<style type="text/css">
			.tooltip {
				position:absolute;
				z-index:999;
				left:-9999px;
				top:0px;
				background-color:#dedede;
				padding:5px;
				border:1px solid #fff;
				min-width:200;
			}
			#yui-history-iframe {
				position:absolute;
				top:0; left:0;
				width:1px; height:1px; /* avoid scrollbars */
				visibility:hidden;
			}

			#modelTabs {
				position:absolute;
				z-index:0;
			}
			.yui-dt-dropdown {width:90px; border-style: none;}

			.yui-dt table {
    				width: 680px;
			}

		</style>

	</head>


	<body class="yui-skin-sam" style="overflow:auto;">

		<script src="../../common/js/utilsLoad.js"></script>
		<script src="../../common/php/displayPreferences.php"></script>
		<script src="../../common/php/loadCommonInfo.php"></script>

		<div class="tooltip" id="toolTip2"><p>popup popup</p></div>

		<div style="width:680;margin:auto;">

			<div>
				<h2 id="header2" style="display: inline-block;">Field Types</h2>
				<div style="float: right; padding-top: 15px"><label id="lblNoticeAboutChanges" style="display: inline-block;"></label>&nbsp;&nbsp;&nbsp;<input id="btnSave" type="button" value="Save Changes" style="float: right; display: none;"/></div>
			</div>

			<!--  style="position:absolute; z-index:0;"
			Static markup required by the browser history utility. Note that the
			iframe is only used on Internet Explorer. If this page is server
			generated (by a PHP script for example), it is a good idea to create
			the IFrame ONLY for Internet Explorer (use server side user agent sniffing) -->

			<input id="yui-history-field" type="hidden">

			<div id="modelTabs" class="yui-navset yui-navset-top">

				<script  type="text/javascript">
					YAHOO.util.Event.addListener(window, "load", function() {

						//var Dt = YAHOO.namespace('detailTypes');

						//keep tablea and source - to avoid repeat load and for filtering
						var arrTables = [];
						var arrDataSources = [];

						var colorBlue = false;
						var currentTipId;
						var needHideTip = true;

						var _groups = [],  //for dropdown list
							_deleted = []; //keep removed types to exclude on filtering

						//object to send changes (visibility and group belong) for update on server
						var _oDetailType = {detailtype:{
									colNames:{common:['dty_ShowInLists','dty_DetailTypeGroupID']},
									defs: {}
									}};

						var _lblNotice, //label that notify that some thing was changed - visibility of group
							_btnSave,   //button to send changes to server side
							_updatesCnt = 0;

						var tabView = new YAHOO.widget.TabView();
						var ind = 0;
						var showTimer,hideTimer;

						YAHOO.widget.DataTable.prototype.fixedWidth = true;

						// init tabview with names of group
						for (var dtg_ID in top.HEURIST.detailTypes.groups) {

							var grpName = top.HEURIST.detailTypes.groups[dtg_ID].name;

							_groups.push({value:dtg_ID, text:grpName});

							tabView.addTab(new YAHOO.widget.Tab({
								id: dtg_ID,
								label: grpName,
								content:
								('<div>'+                   //for="filter"
								'<div style="display:inline-block;"><label>Filter by name:</label>'+
								'<input type="text" id="filter'+ind+'" value="">'+
								'&nbsp;&nbsp;<input type="checkbox" id="filter'+ind+'vis" value="1" style="padding-top:5px;">&nbsp;Show visible only</div>'+
								'<div style="float:right; text-align:right">'+
								'<input type="button" id="btnAdd'+ind+'" value="Add Field Type"/></div></div>'+
								'<div id="tabContainer'+dtg_ID+'"></div></div>')
							}));

							arrTables.push(null);
							arrDataSources.push(null);
							ind++;
						} //for

						//last tab for addition of new group
						tabView.addTab(new YAHOO.widget.Tab({
								id: "newGroup",
								label: "+",
								content:
								('')
								}));

						tabView.appendTo("modelTabs");

						//!!! initTabView();//initTabContent(tabView.getTab(0));

		//
		// on changing of tab - create and fill datatable for particular group
		//
		function handleTabChange (e) {

			if(e.newValue.get("id")!="newGroup" && e.newValue!=e.prevValue)
			{
				initTabContent(e.newValue);
			}
		}

		//
		// assign event handler
		//
		function initTabView () {

				tabView.addListener("activeTabChange", handleTabChange);

				//init the content for the first tab (table and buttons)
				tabView.set("activeIndex", 0);
		}

		// =============================================== START DATATABLE INIT
		//
		// create the content of tab: buttons and datatable
		//
		function initTabContent(tab){

							var dtg_ID = tab.get('id');
							//alert('init>>>>'+dtg_ID);

							//does not work var dt = YAHOO.util.Dom.get("datatable"+dtg_ID);

							var currentTabIndex = tabView.get('activeIndex');
							var dt = arrTables[currentTabIndex];

							if(dt==undefined || dt==null){

								var arr = [];

								//create datatable and fill it valurs of particular group
								for (var dty_ID in top.HEURIST.detailTypes.typedefs) {
									if(dty_ID!="commomFieldNames")
									{
										var td = top.HEURIST.detailTypes.typedefs[dty_ID];
										var deftype = td.commonFields;
										//only for this group and  visible in UI
										if(deftype[7]==dtg_ID && deftype[5]==1){
											var aUsage = top.HEURIST.detailTypes.rectypeUsage[dty_ID];
											var iusage = aUsage == undefined ? 0 : aUsage.length;
											// add order in group, name, help, type and status,
											// doc will be hidden (for pop-up)
											// last 3 columns for actions
											arr.push([dty_ID, deftype[5],
											deftype[3],deftype[0],deftype[4],deftype[2],deftype[6],deftype[1],
												dtg_ID, iusage]);
										}
									}
								}
								//alert(' len:'+arr.length);

								var myDataSource = new YAHOO.util.LocalDataSource(arr,{
									responseType : YAHOO.util.DataSource.TYPE_JSARRAY,
									responseSchema : {
										fields: [ "id", "vis", "order", "name", "help",  "type", "status",
													"description", "grp_id", "usage"]
									},
									doBeforeCallback : function (req,raw,res,cb) {
										// This is the filter function
										var data  = res.results || [],
										filtered = [],
										i,l;

										if (req) {

											var fvals = req.split("|");

											var sByName   = fvals[0].toLowerCase();
											var iByVisibility = fvals[1];

											// when we change the table, the datasource is not changed
											// thus we need an additional filter to filter out the deleted rows
											// and rows that were moved to another groups
											var currentTabIndex = tabView.get('activeIndex');
											var dtg_ID = tabView.getTab(currentTabIndex).get('id');

											for (i = 0, l = data.length; i < l; ++i) {

												// when we change the table, the datasource is not changed
												//thus we need to update visibility manually
												var dty_ID = data[i].id;
												var df = _oDetailType.detailtype.defs[dty_ID];
												if(df!=undefined){
													data[i].vis = df.common[0];
													data[i].grp_id = df.common[1];
												}

												if ((data[i].name.toLowerCase().indexOf(sByName)>-1)
													&& (dtg_ID == data[i].grp_id)
													&& (_deleted.indexOf(dty_ID)<0)
													&& (iByVisibility==0 || data[i].vis==iByVisibility))
												{
													filtered.push(data[i]);
												}
											}
											res.results = filtered;
										}

										return res;
									}
								});

								/*var formatterDelete = function(elLiner, oRecord, oColumn, oData) {
								//if(oRecord.getData("field3") > 100) { YAHOO.util.Dom.replaceClass(elLiner.parentNode, "down", "up");
								elLiner.innerHTML = ' <img src="delete_icon.png">';
								};
								// Add the custom formatter to the shortcuts
								YAHOO.widget.DataTable.Formatter.formatterDelete = formatterDelete;*/

								var myColumnDefs = [
								{ key: "id", label: "<u>Code</u>", sortable:true, width:20, className:'left' },
								{ key: "vis", label: "Vis", sortable:false, width:20, formatter:YAHOO.widget.DataTable.formatCheckbox, className:'center' },
								{ key: "order", label: "<u>Order</u>", sortable:true, width:20, className:'left' },
								{ key: "grp_id", label: "Group", sortable:false, width:90,
									formatter:YAHOO.widget.DataTable.formatDropdown, dropdownOptions:_groups},
//									editor: new YAHOO.widget.DropdownCellEditor({ dropdownOptions:_groups}) },
//									formatter: function(elLiner, oRecord, oColumn, oData){
//elLiner.innerHTML = 						} },
								{ key: "name", label: "<u>Name</u>", sortable:true },
								{ key: "help", label: "Help", sortable:false},
								{ key: "type", label: "<u>Data Type</u>", sortable:true },
								{ key: "status", label: "<u>Status</u>", sortable:true },
								{ key: "description",   hidden:true},
								{ key: null, label: "Edit", sortable:false, width:20, formatter: function(elLiner, oRecord, oColumn, oData){
										elLiner.innerHTML = '<a href="#edit"><img src="../../common/images/edit_icon.png" width="16" height="16" border="0" title="Edit" /><\/a>'} },
								{ key: null, label: "Del", sortable:false, formatter: function(elLiner, oRecord, oColumn, oData){
										elLiner.innerHTML = '<a href="#delete"><img src="../../common/images/delete_icon.png" width="16" height="16" border="0" title="Delete" /><\/a>'} },
								//{ key: "info", label: "Info", sortable:false, formatter: function(elLiner, oRecord, oColumn, oData){
									//	elLiner.innerHTML = '<a href="#info"><img src="../../common/images/info_icon.png" width="16" height="16" border="0" title="Info" /><\/a>'} },
								{ key: "usage", label: "<u>Usage</u>", sortable:true, width:20 }
								];


								var myConfigs = {
									//selectionMode: "singlecell",
									paginator : new YAHOO.widget.Paginator({
										rowsPerPage: 100, // REQUIRED
										totalRecords: arr.length, // OPTIONAL

										// use an existing container element
										//containers: 'dt_pagination',

										// use a custom layout for pagination controls
										template: "{PageLinks} Show {RowsPerPageDropdown} per page",

										// show all links
										pageLinks: YAHOO.widget.Paginator.VALUE_UNLIMITED,

										// use these in the rows-per-page dropdown
										rowsPerPageOptions: [25, 50, 100]

									})
								};

								dt = new YAHOO.widget.DataTable('tabContainer'+dtg_ID, myColumnDefs, myDataSource, myConfigs);

								//dt.subscribe("cellClickEvent", this.singleCellSelectDataTable.onEventSelectCell);

								//click on action images
								dt.subscribe('linkClickEvent', function(oArgs){
									YAHOO.util.Event.stopEvent(oArgs.event);

									var elLink = oArgs.target;
									var oRecord = this.getRecord(elLink);
									var dty_ID = oRecord.getData("id");

									//                 alert("Action "+elLink.hash+" for:"+dty_ID);
									if(elLink.hash == "#edit"){

										_onAddEditFieldType(dty_ID, 0);

									}else if(elLink.hash == "#delete"){
										var iUsage = oRecord.getData('usage');
										if(iUsage<1){
											var r=confirm("Delete field type#"+dty_ID+" '"+oRecord.getData('name')+"?");
											if (r==true) {
												this.deleteRow(oRecord.getId(), -1);
												//@todo - call to saveStructure.php
												_deleted.push( dty_ID );
											}
										}else{
											alert("Impossible to delele field type in usage");
										}
									}

								});


				dt.subscribe('dropdownChangeEvent', function(oArgs){
				    var elDropdown = oArgs.target;
				    var record = this.getRecord(elDropdown);
					var column = this.getColumn(elDropdown);
					var newValue = elDropdown.options[elDropdown.selectedIndex].value;
					var oldValue = record.getData(column.key);
					var recordIndex = this.getRecordIndex(record);
					var recordKey = record.getData('recordKey');
					if(newValue!=oldValue){
						//this.deleteRow(recordIndex);
						var data = record.getData();
						data['grp_id'] = newValue;

						var newTabIndex = elDropdown.selectedIndex; //getTabIndexByGroup(newValue);
						var ndt = arrTables[newTabIndex];
						if(ndt!=null){
							// need to refill the destionation table,
							// otherwise datasource is not updated
							arrTables[newTabIndex] = null; //.addRow(record.getData(), 0);
						}

						//remove from this table and refresh another one
						window.setTimeout(function() {
										dt.deleteRow(record.getId(), -1);
										}, 100);

						//keep the track of changes in special object
						_updateDetailType(record);
					}
				});

				//subscribe on checkbox event (visibility)
				dt.subscribe("checkboxClickEvent", function(oArgs) {
						var elCheckbox = oArgs.target;
						var oRecord = dt.getRecord(elCheckbox);
						var data = oRecord.getData();
						data['vis'] = elCheckbox.checked?1:0;

						//var recindex = dt.getRecordIndex(oRecord);
						//dt.updateRow(recindex, data);

						//keep the track of changes in special array
						_updateDetailType(oRecord);
				});

	//
	// keep the changes in object that will be send to server
	//
	function _updateDetailType(oRecord)
	{
			var dty_ID = oRecord.getData('id');
			var newvals = [oRecord.getData('vis'), oRecord.getData('grp_id')];

			//update HEURIST
			var td = top.HEURIST.detailTypes.typedefs[dty_ID];
			var deftype = td.commonFields;
			deftype[5] = newvals[0]; //visibility
			deftype[7] = newvals[1]; //group

			//update keep object
			var dt_def = _oDetailType.detailtype.defs[dty_ID];
			if(dt_def==undefined){
				 	_oDetailType.detailtype.defs[dty_ID] = {common:newvals};
				 	_updatesCnt++;
			}else{
					_oDetailType.detailtype.defs[dty_ID].common = newvals;
			}

			if(_lblNotice==null){
				_lblNotice = YAHOO.util.Dom.get("lblNoticeAboutChanges");
				_btnSave   = YAHOO.util.Dom.get("btnSave");
				_btnSave.onclick = _updateDetailTypeOnServer
			}

			_lblNotice.innerHTML = 'You have changed <b>'+_updatesCnt+'</b> field type'+((_updatesCnt>1)?'s':'');
			_btnSave.style.display = 'block';
	}
	//
	// send updates to server
	//
	function _updateDetailTypeOnServer(event) {
		var str = YAHOO.lang.JSON.stringify(_oDetailType);
		alert("Stringified changes: " + str);

		if(str != null) {
			_updateResult(""); //debug
			return;//debug

			// TODO: Change base URL
			var baseurl = top.HEURIST.baseURL + "admin/structure/saveStructure.php";
			var callback = _updateResult;
			var params = "method=saveDT&";
			params += "data=" + str;
			top.HEURIST.util.getJsonData(baseurl, callback, params);
		}
	}
	//
	//
	//
	function _updateResult(context) {
		_updatesCnt = 0;
		_oDetailType.detailtype.defs = {}; //clear keeptrack
		_btnSave.style.display = 'none';
		_lblNotice.innerHTML = '';
	}

				//mouse over help colums shows the datailed description
				dt.on('cellMouseoverEvent', function (oArgs) {
									clearHideTimer();

									var forceHideTip = true;
									var textTip = null;
									var target = oArgs.target;
									var column = this.getColumn(target);

									if (column!=null && column.key == 'help') {
										var record = this.getRecord(target);
										var description = record.getData('description') || 'no further description';
										var xy = [parseInt(oArgs.event.clientX,10) + 10 ,parseInt(oArgs.event.clientY,10) + 10 ];
										var textTip = '<p>'+description+'</p>';

										/*     yui tooltip does not work :(
										toolTip.setBody(description);
										toolTip.cfg.setProperty('xy',xy);
										toolTip.render();//.show();
										*/
										/*
										showTimer = window.setTimeout(function() {
										tt.setBody(description);
										tt.cfg.setProperty('xy',xy);
										tt.show();
										hideTimer = window.setTimeout(function() {
										tt.hide();
										},5000);
										},500);*/
									}else if(column!=null && column.key == 'usage') {
										var record = this.getRecord(target);
										var dty_ID = description = record.getData('id');

										if(currentTipId!=dty_ID){
											currentTipId=dty_ID;

											var xy = [parseInt(oArgs.event.clientX,10), parseInt(oArgs.event.clientY,10) - 20 ];

											//find all records that reference this type
											var aUsage = top.HEURIST.detailTypes.rectypeUsage[dty_ID];
											if(aUsage != undefined){
												var textTip = "<p><ul>";
												for (var k in aUsage) {
													textTip = textTip + "<li><a href='editRecordType.html'>"+top.HEURIST.rectypes.names[k]+"</a></li>";
												}
												textTip = textTip + "</ul></p>";
											}
										}else{
											forceHideTip = false;
										}
									}

									if(textTip!=null){

										needHideTip = true;

										var my_tooltip = $("#toolTip2");

										my_tooltip.mouseover(clearHideTimer2);
										my_tooltip.mouseout(hideToolTip2);

										var border_top = $(window).scrollTop();
										var border_right = $(window).width();
										var border_height = $(window).height();
										var left_pos;
										var top_pos;
										var offset = 15;
										if(border_right - (offset *2) >= my_tooltip.width() +  xy[0]) {
											left_pos = xy[0]+offset;
										} else {
											left_pos = border_right-my_tooltip.width()-offset;
										}

										if((border_top + offset *2) >=  xy[1] - my_tooltip.height()) {
											top_pos = border_top + offset + xy[1]; //
										} else {
											top_pos = border_top + xy[1] - my_tooltip.height()-offset;
										}
										if(top_pos + my_tooltip.height() > border_top+border_height){
											top_pos	= border_top + border_height - my_tooltip.height()-5;
										}


										//var lft = my_tooltip.css('left');
										my_tooltip.css( {
											left:left_pos+'px', top:top_pos+'px'
										});
										//lft = my_tooltip.css('left');
										my_tooltip.html(textTip);
										hideTimer = window.setTimeout(hideToolTip, 5000);
									}
									else if(forceHideTip)
									{
										hideToolTip();
									}
				});
				dt.on('cellMouseoutEvent', function (oArgs) {
									hideTimer = window.setTimeout(hideToolTip, 2000);
				});

				function hideToolTip2(){
					needHideTip = true;
				}
				function clearHideTimer2(){
					needHideTip = false;
					clearHideTimer();
				}
				function hideToolTip(){
					if(needHideTip){
						currentTipId = null;
						clearHideTimer();
						var my_tooltip = $("#toolTip2");
							my_tooltip.css( {
							left:"-9999px"
							});
					}
				}
				function clearHideTimer(){
						if (hideTimer) {
							window.clearTimeout(hideTimer);
							hideTimer = 0;
						}
				}

								arrTables[currentTabIndex] = dt;
								arrDataSources[currentTabIndex] = myDataSource;


								var filter = YAHOO.util.Dom.get('filter'+currentTabIndex);
								filter.onkeyup = function (e) {
									clearTimeout(filterTimeout);
									setTimeout(updateFilter,600);  };

								var filtervis = YAHOO.util.Dom.get('filter'+currentTabIndex+'vis');
								filtervis.onchange = function (e) {
									clearTimeout(filterTimeout);
									updateFilter();  };

								var btnAdd = YAHOO.util.Dom.get('btnAdd'+currentTabIndex);
								btnAdd.onclick = function (e) {
									var currentTabIndex = tabView.get('activeIndex');
									var dtg_ID = tabView.getTab(currentTabIndex).get('id');
									_onAddEditFieldType(0, dtg_ID);
								};


								/*
								YAHOO.util.Event.on('filter','onkeyup',function (e) {
								clearTimeout(filterTimeout);
								setTimeout(updateFilter,600);
								});    */


							}
	}//initTabContent =============================================== END DATATABLE INIT

						function _onAddEditFieldType(dty_ID, dtg_ID){

							var url = top.HEURIST.basePath + "admin/structure/editDetailType.html";
							if(dty_ID>0){
								url = url + "?detailTypeID="+dty_ID; //existing
							}else{
								url = url + "?groupID="+dtg_ID; //new one
							}

							top.HEURIST.util.popupURL(top, url,
										{   "close-on-blur": false,
											"no-resize": true,
											height: 430,
											width: 640,
											callback: function(editedDetailType) {
												if(editedDetailType==null){
													alert("Edition is cancelled");
												}else{
													alert('Edited dt type is '+editedDetailType[0]);
												}
												//setTimeout(function() { }, 0);
											}
										});
						}


						/*

						var toolTip = new YAHOO.widget.Tooltip("myTooltip", {
						showDelay:5000
						});

						var panelEdit = new YAHOO.widget.Panel("panelDtEdit", {
						width: "400px",
						fixedcenter: true,
						constraintoviewport: true,
						underlay: "shadow",
						close: true,
						//modal: true,
						visible: false,
						draggable: true
						});
						panelEdit.render(YAHOO.util.Dom.get('modelTabs'));
						*/

						//
						// filtering by name
						// listenter is activated along with dataTable creation
						//
						var filterTimeout = null;
						var updateFilter  = function () {
							// Reset timeout
							filterTimeout = null;

							var currentTabIndex = tabView.get('activeIndex');
							var dtable = arrTables[currentTabIndex];
							var dsource = arrDataSources[currentTabIndex];

							// Reset sort
							var state = dtable.getState();
							state.sortedBy = {key:'name', dir:YAHOO.widget.DataTable.CLASS_ASC};

							var filterval = YAHOO.util.Dom.get('filter'+currentTabIndex).value;
							var filtervis = YAHOO.util.Dom.get('filter'+currentTabIndex+'vis').checked?1:0;

							// Get filtered data
							dsource.sendRequest(filterval+'|'+filtervis,{
								success : dtable.onDataReturnInitializeTable,
								failure : dtable.onDataReturnInitializeTable,
								scope   : dtable,
								argument : { pagination: { recordOffset: 0 } } // to jump to page 1
							});
						};


						(function () {

							var bookmarkedTabViewState = YAHOO.util.History.getBookmarkedState("tabview");
							var initialTabViewState = bookmarkedTabViewState || "tab0";

							//var tabView;

							YAHOO.util.History.register("tabview", initialTabViewState, function (state) {
								tabView.set("activeIndex", state.substr(3));  //restre the index from history
							});

							YAHOO.util.History.onReady(function () {
								var currentState;

								initTabView();

								currentState = YAHOO.util.History.getCurrentState("tabview");

								//alert('!!!!'+currentState);
								if(currentState && currentState.length>3) {
									tabView.set("activeIndex", currentState.substr(3));  //restore active tab from history
								}
							});

							try {
								YAHOO.util.History.initialize("yui-history-field", "yui-history-iframe");
							} catch (e) {
								initTabView();
							}

						})();

					});

				</script>
			</div>

		</div>
	</body>
</html>