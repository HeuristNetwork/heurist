<!--

/**
 * filename, brief description, date of creation, by whom
 * @copyright (C) 2005-2010 University of Sydney Digital Innovation Unit.
 * @link: http://HeuristScholar.org
 * @license http://www.gnu.org/licenses/gpl-3.0.txt
 * @package Heurist academic knowledge management system
 * @todo
 **/

-->
<html>
 <head>
  <title>Heurist - Record types</title>

  <link rel="icon" href="../../favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="../../favicon.ico" type="image/x-icon">

  <link rel="stylesheet" type="text/css" href="../../common/css/Popup.css">
  <script type="text/javascript" src="../../common/js/utilsForPopups.js"></script>

  <link rel="stylesheet" type="text/css" href="../../common/css/newshsseri.css">
  <style type="text/css">
	a img { border: 0; }
	.friendly_border { border: 1px dotted lightgray; background-color: #FFFFDD; border-collapse: collapse; }
	.delete_icon { cursor: pointer; }

	.rft_icon {
		margin-right: 5px;
		vertical-align: middle;
		cursor: pointer;
	}
	body.wg .base-only { display: none; }
  </style>

[literal]
  <script type="text/javascript">
   <!--

	var existing_details = new Object();

	function delete_bdr(rst_ID) {
		var delement = document.forms['edit_form'].elements['bdr_delete_del_field_'+rst_ID];
		if (delement) {
			delement.value = 1;
			delement.form.submit();
		}
	}

	function delete_bdt(dty_ID) {
		if (! confirm("Remove this detail type (field) and all dependencies upon it?")) return;

		var delete_bdt_elt = document.getElementById('delete_bdt');
		delete_bdt_elt.value = dty_ID;
		delete_bdt_elt.form.submit();
	}

	var protect_div = null;
	function edit_enum_types(dty_ID) {
		var name_span = document.getElementById('name'+dty_ID);
		var name_span_pos = findPos(name_span);
		edit_enum_types_with_pos(dty_ID, name_span_pos);
	}

	function edit_enum_types_with_pos(dty_ID, pos) {
		popup_frame(pos, 'editVocab.php?instance=[instance-name!]&amp;dty_ID='+dty_ID, finish_edit_enum_types);
	}

	function finish_edit_enum_types() {
		close_popup_frame();
	}

	function edit_reftype_constraints(dty_ID) {
		popup_frame(pos, 'editReftypeConstraints.php?instance=[instance-name!]&amp;dty_ID='+dty_ID, finish_edit_reftype_constraints);
	}

	function finish_edit_reftype_constraints() {
		close_popup_frame();
		document.location.replace('editStructure.php?instance=[instance-name!]');//note: called in the context of the popup
	}

	function edit_constrain_reftype(dty_ID) {
		var name_span = document.getElementById('name'+dty_ID);
		var pos = findPos(name_span);
		popup_frame(pos, 'editReftypeConstraints.php?instance=[instance-name!]&amp;dty_ID='+dty_ID, finish_edit_constrain_reftype,true);
	}

	function finish_edit_constrain_reftype() {
		close_popup_frame();
		document.location.replace('editStructure.php?instance=[instance-name!]'); //note: called in the context of the popup
	}

	function popup_frame(position, location, finish_fn, keepRelPos) {
		var popup_frame_elt = document.getElementById('popup_frame_obj');
		var frameTop = position.y - 138;
		var overflow;
		popup_frame_elt.style.left = position.x - 8;
		popup_frame_elt.style.top = frameTop;
		popup_frame_elt.contentWindow.location.replace(location);

		protect_div = document.createElement('div');
		protect_div.style.position = 'absolute';
		protect_div.style.width = '100%';
		protect_div.style.height = '200%';
		protect_div.style.left = '0px';
		protect_div.style.top = '0px';
		protect_div.style.zIndex = 0;
		protect_div.style.backgroundColor = 'black';
		protect_div.style.MozOpacity = '0.3';
		protect_div.style.opacity = '0.3';
		protect_div.onclick = finish_fn;
		popup_frame_elt.parentNode.appendChild(protect_div);
		document.body.style.overflow = 'hidden';

		overflow = popup_frame_elt.offsetTop + popup_frame_elt.offsetHeight - window.innerHeight;
		if (overflow > 0) {
			if (keepRelPos) {
				popup_frame_elt.ownerDocument.body.scrollTop = frameTop;
			}else{
				popup_frame_elt.style.top = Math.max(frameTop - overflow, popup_frame_elt.ownerDocument.body.scrollTop);
			}
		}
	}

	function close_popup_frame() {
		if (protect_div) { protect_div.parentNode.removeChild(protect_div); protect_div = null; }
		var popup_frame_elt = document.getElementById('popup_frame_obj');
		popup_frame_elt.style.left = '-1000px';
		document.body.style.overflow = '';
	}

	function findPos(obj) {
		var curleft = 0;
		var curtop = 0;
		if (obj.offsetParent) {
			while (obj.offsetParent) {
				curleft += obj.offsetLeft;
				curtop += obj.offsetTop;

	//			if (obj.scrollLeft) curleft -= obj.scrollLeft;
	//			if (obj.scrollTop) curtop -= obj.scrollTop;
				if (obj.parentNode.scrollLeft  ||  obj.parentNode.scrollTop) {
					curleft -= obj.parentNode.scrollLeft;
					curtop -= obj.parentNode.scrollTop;
				}
				obj = obj.offsetParent;
			}

		} else if (obj.x  ||  obj.y) {
			curleft += obj.x;
			curtop += obj.y;
		}

		var cur = new Object();
		cur.x = curleft;
		cur.y = curtop;

		return cur;
	}

	function upload_icon(rty_ID) {
		var img = document.getElementById('rt'+rty_ID);

		top.popup_url('uploadRectypeIcon.php?instance=[instance-name!]&amp;rty_ID='+rty_ID, 100, 300);
	}

	function icon_refresh(rty_ID) {
		var img = document.getElementById('rt'+rty_ID);
		img.src = img.src.replace(/\?.*/, '') + '?' + (new Date()).getTime();
	}

	function check_prompts() {
		if (! check_matches()) {
			alert("Please select at least one field for MATCHING records of this type");
			return false;
		}

		var detail_table = document.getElementById('bib_detail_table');
		if (! detail_table) return true;
		var inputs = detail_table.getElementsByTagName('input');
		if (! inputs) return true;
		var title;
		var fields = '';
		for (var i = 0; i < inputs.length; ++i) {
			if (inputs[i].getAttribute('title') == 'contextual name')
				title = inputs[i].value;
			if (inputs[i].getAttribute('title') == 'prompt') {
				var prompt = inputs[i].value;
				if (! prompt  ||  ! prompt.match(/[^ ]+ [^ ]+ [^ ]+/)) {
					fields += title + '\n';
				}
			}
		}
		if (fields.length > 0) {
			alert('Please provide prompts of at least three words for the following fields:\n\n' + fields);
			return false;
		}
		return true;
	}

	function check_matches() {
		if (window.reqMatchField) return true;	// high tech it ain't
		var inputs = document.getElementsByTagName("input");
		if (inputs.length <= 11) return true; //ms 9/05  -hack!! change that to proper check

		for (var i=0; i < inputs.length; ++i) {
			if (inputs[i].name.match(/^bdr_rdr_match_/)  &&  inputs[i].checked) return true;
		}
		return false;
	}

   //-->
  </script>
[end-literal]

 </head>

 <body>

  {PageHeader}

  <div id="main">

  <div>

<a href="../ugrps/findAddUser.php?instance=[instance-name!]">User admin</a>
|
<a href="../verification/recalcTitlesAllRecords.php?instance=[instance-name!]">Rebuild titles</a>
|
<a href="../verification/listDuplicateRecords.php?fuzziness=10&amp;instance=[instance-name!]">Find duplicates</a>
|
<a href="../ugrps/editGroupTags.php?instance=[instance-name!]">Group tags</a>
|
<a href="../ugrps/assignUsersToGroups.php?instance=[instance-name!]">List all users</a>
|
<a href="../../search/search.html?q=_BROKEN_&amp;w=all&amp;instance=[instance-name!]">Records with broken urls</a>
|
<a href="../ugrps/quitGroupForSession.php?instance=[instance-name!]">Take your hat off (exit group)</a>
<br>
<a href="../verification/checkXHTML.php?instance=[instance-name!]">Woot XHTML check</a>
|
<a href="../verification/checkInvalidChars.php?instance=[instance-name!]" >invalid Character check</a>
|
<a href="../verification/cleanInvalidChars.php?instance=[instance-name!]">clean invalid Character</a>
|
<a href="../ugrps/editGroups.php?instance=[instance-name!]">Add/edit groups</a>
|
<a href="../rollback/rollbackRecords.php?instance=[instance-name!]">Record rollback</a>

  </div>

  <div style="padding: 10px;">

   <span class="normal" id="asdf">

  [if : added-detail-type]
   <p style="color: green; font-weight: bold;">New detail type (field) added</p>
  [end-if]

<div style="font-size: 16px; font-weight: bold; text-align: center; background-color: red;">
 Warning: Editing MASTER types!
 <br>
 This will affect ALL Heurist instances
</div>

<form action="editStructure.php?instance=[instance-name!]" method="post" name="edit_form" onSubmit="return check_prompts();">
[update REFTYPE rt1]

  [errors]
  [if : edit-success]
   <p style="color: green; font-weight: bold;">Changes saved</p>
  [end-if]
  <div class="headline">Editing record type <span style="letter-spacing: -2px;">&lt;&lt;</span><b>[rty_Name]</b><span style="letter-spacing: -2px;">&gt;&gt;</span></div>

  <p/>


  <p class="base-only">
   <a href="../../help/bib_detail_editor.html" target=_blank><img src="../../common/images/lb.gif" style="vertical-align: bottom;"></a>
   <a href="../../help/bib_detail_editor.html" target=_blank>Explanation of functions</a>
  </p>

  <table border="0">
   <tr class="base-only">
    <td style="width: 100px; font-weight: bold; text-align: right; vertical-align: top;">Notes on this record type</td>
    <td style="width: 300px;">
     [textarea : rty_Description : notes : style="width: 500px;" rows="1"]
    </td>
   </tr>

   <tr class="base-only">
    <td style="font-weight: bold; text-align: right;">Icon</td>
	<td>
     <img src="../../common/images/reftype-icons/[rty_ID].png" style="vertical-align: middle;" class="rft_icon" onClick="upload_icon([rty_ID]);">
     &nbsp;&nbsp;&nbsp;&nbsp;
     <span style="font-weight: bold; text-align: right;">Bibliographic record types</span>
     [checkbox : rty_RecTypeGroupID : primary record type : style="margin: 0px;"]
    </td>
   </tr>

   <tr class="base-only">
    <td style="font-weight: bold; text-align: right; vertical-align: top;">New title mask</td>
    <td>
     <div style="font-size: 80%; padding-bottom: 4px; width: 60%;">
      The title mask is a string into which detail types (fields) are interpolated, e.g.
       <span style="font-family: fixed; padding: 4px;">&#91;Title&#93;, pp &#91;Start_Page&#93;-&#91;End_Page&#93;</span>
      The names in square brackets should match field names for this record type.
      The interpolated value is used as the default title for spontaneously-created bibliographic records of this type.
      To insert a literal square-bracket, use two consecutive square-brackets (&#91;&#91; or &#93;&#93;).
     </div>
     [textbox : rty_TitleMask : combination of bibliographic details to make a title : style="width: 60%;"]
     <div style="color: red; font-weight: bold; width: 80%;">[new-field-errors]</div>
    </td>
   </tr>

   <tr class="base-only">
    <td colspan="2">&nbsp;</td>
   </tr>

   <tr class="base-only">
    <td style="font-weight: bold; text-align: right; vertical-align: top;">Record Constraints</td>
    <td>
     <input type="button" value="Add/Edit Constraints" onClick="edit_reftype_constraints([rty_ID]);">
    </td>
   </tr>

   <tr class="base-only">
    <td colspan="2">&nbsp;</td>
   </tr>

   <tr>
    <td style="font-weight: bold; text-align: right; vertical-align: top;">Bibliographic details</td>
    <td>
     <table id="bib_detail_table" border="0" cellspacing="0" style="border-collapse: collapse;">
	 [search BIB_DETAIL_REQ bdr_search /* find all the detail requirements*/]
	 [auto : rst_RecTypeID : rty_ID /* for the current update record type */]
     [foreach BIB_DETAIL_REQ bdr : 1 order by rst_DisplayOrder, rst_ID /*itereate through each of the results*/]
      <tr class="friendly_border">
       <td style="vertical-align: top; font-weight: bold;">
        <img src="../../common/images/cross.gif" onClick="delete_bdr([rst_ID]);" class="delete_icon">
        [delete BIB_DETAIL_REQ bdr_delete][hidden required : del_field/* create hidden field to control marking this detail requirement for deletion*/][end-delete]
        [select BIB_DETAIL_TYPE bdt][dty_Name] <span style="font-size: 80%; font-weight: normal;">([dty_ID])</span>[end-select]&nbsp;
</td>
<td style="padding-bottom: 1ex;">
<nobr>
        [update BIB_DETAIL_REQ bdr]
         &nbsp;&nbsp;&nbsp;label [textbox : rst_DisplayName : contextual name : style="width: 200px;"]&nbsp;
[dropdown required : rst_RequirementType : : select req_abbrev, req_full from requirements order by req_order : style="width: 90px;"]&nbsp;
<img src="../../common/images/10x10.gif">
         &nbsp;size [textbox : rst_DisplayWidth : field width : style="width: 30px;"]
          &nbsp;<label>repeatable [textbox : rst_MaxValues : repeat : style="width: 30px; padding: 0px 2px;"]</label>&nbsp;
          &nbsp;<label>matching [checkbox : rst_RecordMatchOrder : is this field used for identifying possible matches? : style="margin: 0px;"]</label>&nbsp;
          &nbsp;order&nbsp;[textbox : rst_DisplayOrder : : style="width: 30px; padding: 0px 2px;"]&nbsp;
         &nbsp;default [textbox : rst_DefaultValue : default value : style="width: 100px;"]&nbsp;
         [textarea : rst_DisplayHelp : help text : style="height: 25px; width: 200px; vertical-align: top;"]
         </nobr>
         <nobr>prompt [textbox : rst_DisplayPrompt : prompt : style="width: 700px;"]&nbsp;
[select BIB_DETAIL_TYPE bdt]
         &nbsp;data&nbsp;type : [if-eq : dty_Type : "enum"]<a href="#" onClick="edit_enum_types_with_pos([dty_ID], findPos(this.parentNode)); return false;">[dty_Type]</a>[else][dty_Type][end-if-eq]
&nbsp;&nbsp;
		 detail type description: [dty_Description]
[end-select]
</nobr>
       </td>
        [end-update]

      </tr>
     [end-foreach]
	 [end-search]
     [not-found]
      <tr><td colspan="2">(none specified)</td></tr>
     [end-not-found]

      <tr><td colspan="2">&nbsp;</td></tr>
     </table>
    </td>
   </tr>

   <tr>
    [insert BIB_DETAIL_REQ new_bdr]
    <td style="font-weight: bold; text-align: right;">Add new detail to this type</td>
    <td>
     [dropdown required : rst_DetailTypeID : : select dty_ID, concat(dty_ID,' ',dty_Type,'  ',dty_Name) from defDetailTypes left join defRecStructure on rst_RecTypeID=[special-rty_ID] and rst_DetailTypeID=dty_ID where rst_ID is null order by dty_Type,dty_Name : onchange="document.getElementById('new_bdr_label').value = this.options&#91;this.selectedIndex&#93;.text.replace(/&#91;0-9&#93;+\s*/,''); document.getElementById('new_bdr_order').value = this.options&#91;this.selectedIndex&#93;.value;"]
     [hidden : rst_DisplayName : : id="new_bdr_label"]
     [auto : rst_RecTypeID : rty_ID]
     [hidden : rst_DisplayOrder : : id="new_bdr_order"]
     [auto : rst_DisplayWidth : "30"]
    </td>
    [end-insert]
   </tr>

   <tr>
    <td colspan="2">&nbsp;</td>
   </tr>

   <tr>
    <td></td>
    <td>
     <input type="submit" name="action" value="Save" style="font-weight: bold;">
     &nbsp;&nbsp;
     <input type="button" value="Return to list" onClick="window.location.href = 'editStructure.php?instance=[instance-name!]';">
    </td>
   </tr>
  </table>

[end-update]
</form>

[not-found]
<div class="headline">Record types</div>
<p/>
<table border="0">
 <tr><td></td><td style="text-align: right;"><a href="../describe/listRectypeDescriptions.php?instance=[instance-name!]">print-friendly dump</a> | <a href="../verification/listRecordPointerErrors.php?instance=[instance-name!]">records with errors</a></td></tr>
<tr><td>
 <p><b>Select a record type to edit:</b></p>

 <div style="width: 300px; height: 500px; overflow: auto; padding: 3px;" class="friendly_border">
  <table border="0">
   [foreach REFTYPE rtf : 1 order by (rty_RecTypeGroupID > 1), rty_Name]
    <tr><td style="text-align: right;">[rty_ID]</td><td><img src="../../common/images/reftype-icons/[rty_ID].png" id="rt[rty_ID]" class="rft_icon" onClick="upload_icon([rty_ID]);"><a href="?rty_ID=[rty_ID]">[rty_Name]</a></td></tr>
   [end-foreach]
   [not-found][end-not-found]
  </table>
 </div>

 <p><b>or add a new record type:</b></p>

<form method="post">
<input type="hidden" name="_submit" value="1">
   [insert REFTYPE new_rtf]
 <table border="0">
  <tr>
   <td style="width: 100px; font-weight: bold; text-align: right;">Short description</td>
   <td>[textbox required : rty_Name : record type : style="width: 200px;"]</td>
  </tr>
  <tr>
   <td style="width: 100px; font-weight: bold; text-align: right;">Notes</td>
   <td>[textbox : rty_Description : notes : style="width: 200px;"]</td>
  </tr>
  <tr>
   <td></td>
   <td style="text-align: right;"><input type="submit" name="action" value="Add record type"></td>
  </tr>
 </table>
   [end-insert]
</form>
</td>
<td>
 <p><b>Detail types (fields)</b></p>

 <div style="width: 450px; height: 500px; overflow: auto; padding: 3px;" class="friendly_border">
  <table border="0" style="width: 100%;">
   [foreach BIB_DETAIL_TYPE bdt : 1 order by dty_Type,dty_Name]
    <tr>
     <td>[dty_ID]</td>
     <td style="width: 200px;"><!--img src="cross.gif" onclick="delete_bdt([dty_ID]);" class="delete_icon"--> <span id="name[dty_ID]">[dty_Name]</span></td>
     <td style="text-align: left;">[if-eq : dty_Type : "enum"]<a href="#" onClick="edit_enum_types([dty_ID]); return false;">[dty_Type]</a>[else][dty_Type][end-if-eq][if-eq : dty_Type : "resource"] <a href="#" onClick="edit_constrain_reftype([dty_ID]); return false;">([if : dty_PtrConstraints][select REFTYPE rft][rty_Name][end-select][else]unconstrained[end-if])</a>[end-if-eq]</td>
    </tr>
   [end-foreach]
   <!--form action="master_bib_detail_editor.php" method="post"><input type="hidden" name="delete_bdt_field" value="" id="delete_bdt"></form-->
  </table>
 </div>

 <p><b>or add a new detail type (field):</b>
 <span style="color:red; float:right; font-weight: bold;">Please check that no suitable field already exists</span>
</p>
<form method="post">
<input type="hidden" name="_submit" value="1">
   [insert BIB_DETAIL_TYPE new_bdt]
 <table border="0">
  <tr>
   <td style="width: 100px; font-weight: bold; text-align: right;">Generic name</td>
   <td>[textbox required : dty_Name : generic name : style="width: 200px;"]</td>
  </tr>
  <tr>
   <td style="width: 100px; font-weight: bold; text-align: right;">Data type</td>
   <td>[dropdown : dty_Type : type : enum("freetext","blocktext","integer","date","year","relmarker","boolean","enum","resource","float","file","geo","separator")]</td>
  </tr>
  <tr>
   <td></td>
   <td style="text-align: right;"><input type="submit" name="action" value="Add detail type (field)"></td>
   </tr>
 </table>
   [end-insert]
</form>
</td></tr></table>

[end-not-found]

   </span>

<div style="font-size: 16px; font-weight: bold; text-align: center; background-color: red;">
 Warning: Editing MASTER types!
 <br>
 This will affect ALL Heurist instances
</div>

  </div>

  <iframe name="popup_frame" id="popup_frame_obj" src="editVocab.php?instance=[instance-name!]" style="z-index: 51; width: 550px; height: 570px; position: absolute; top: -700px; left: 0px;" frameborder="0"></iframe>

  </div>

 </body>
</html>
